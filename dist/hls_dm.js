!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.Hls=f()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function EventEmitter(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function isFunction(arg){return"function"==typeof arg}function isNumber(arg){return"number"==typeof arg}function isObject(arg){return"object"==typeof arg&&null!==arg}function isUndefined(arg){return void 0===arg}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length)){if(er=arguments[1],er instanceof Error)throw er;var err=new Error('Uncaught, unspecified "error" event. ('+er+")");throw err.context=er,err}if(handler=this._events[type],isUndefined(handler))return!1;if(isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1),handler.apply(this,args)}else if(isObject(handler))for(args=Array.prototype.slice.call(arguments,1),listeners=handler.slice(),len=listeners.length,i=0;i<len;i++)listeners[i].apply(this,args);return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener),this._events[type]?isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,isObject(this._events[type])&&!this._events[type].warned&&(m=isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),"function"==typeof console.trace&&console.trace())),this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(isObject(list)){for(i=length;i-- >0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(position<0)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],isFunction(listeners))this.removeListener(type,listeners);else if(listeners)for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){var ret;return ret=this._events&&this._events[type]?isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;if(evlistener)return evlistener.length}return 0},EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type)}},{}],2:[function(require,module,exports){!function(root){var URLToolkit={buildAbsoluteURL:function(baseURL,relativeURL){if(relativeURL=relativeURL.trim(),/^[a-z]+:/i.test(relativeURL))return relativeURL;var relativeURLQuery=null,relativeURLHash=null,relativeURLHashSplit=/^([^#]*)(.*)$/.exec(relativeURL);relativeURLHashSplit&&(relativeURLHash=relativeURLHashSplit[2],relativeURL=relativeURLHashSplit[1]);var relativeURLQuerySplit=/^([^\?]*)(.*)$/.exec(relativeURL);relativeURLQuerySplit&&(relativeURLQuery=relativeURLQuerySplit[2],relativeURL=relativeURLQuerySplit[1]);var baseURLHashSplit=/^([^#]*)(.*)$/.exec(baseURL);baseURLHashSplit&&(baseURL=baseURLHashSplit[1]);var baseURLQuerySplit=/^([^\?]*)(.*)$/.exec(baseURL);baseURLQuerySplit&&(baseURL=baseURLQuerySplit[1]);var baseURLDomainSplit=/^(([a-z]+:)?\/\/[^:\/]+(:[0-9]+)?)?(\/?.*)$/i.exec(baseURL);if(!baseURLDomainSplit)throw new Error("Error trying to parse base URL.");var baseURLProtocol=baseURLDomainSplit[2]||"",baseURLProtocolDomain=baseURLDomainSplit[1]||"",baseURLPath=baseURLDomainSplit[4];0!==baseURLPath.indexOf("/")&&""!==baseURLProtocolDomain&&(baseURLPath="/"+baseURLPath);var builtURL=null;return builtURL=/^\/\//.test(relativeURL)?baseURLProtocol+"//"+URLToolkit.buildAbsolutePath("",relativeURL.substring(2)):/^\//.test(relativeURL)?baseURLProtocolDomain+"/"+URLToolkit.buildAbsolutePath("",relativeURL.substring(1)):URLToolkit.buildAbsolutePath(baseURLProtocolDomain+baseURLPath,relativeURL),relativeURLQuery&&(builtURL+=relativeURLQuery),relativeURLHash&&(builtURL+=relativeURLHash),builtURL},buildAbsolutePath:function(basePath,relativePath){for(var nUpLn,nEnd,sRelPath=relativePath,sDir="",sPath=basePath.replace(/[^\/]*$/,sRelPath.replace(/(\/|^)(?:\.?\/+)+/g,"$1")),nStart=0;nEnd=sPath.indexOf("/../",nStart),nEnd>-1;nStart=nEnd+nUpLn)nUpLn=/^\/(?:\.\.\/)*/.exec(sPath.slice(nEnd))[0].length,sDir=(sDir+sPath.substring(nStart,nEnd)).replace(new RegExp("(?:\\/+[^\\/]*){0,"+(nUpLn-1)/3+"}$"),"/");return sDir+sPath.substr(nStart)}};"object"==typeof exports&&"object"==typeof module?module.exports=URLToolkit:"function"==typeof define&&define.amd?define([],function(){return URLToolkit}):"object"==typeof exports?exports.URLToolkit=URLToolkit:root.URLToolkit=URLToolkit}(this)},{}],3:[function(require,module,exports){var bundleFn=arguments[3],sources=arguments[4],cache=arguments[5],stringify=JSON.stringify;module.exports=function(fn,options){function resolveSources(key){workerSources[key]=!0;for(var depPath in sources[key][1]){var depKey=sources[key][1][depPath];workerSources[depKey]||resolveSources(depKey)}}for(var wkey,cacheKeys=Object.keys(cache),i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i],exp=cache[key].exports;if(exp===fn||exp&&exp.default===fn){wkey=key;break}}if(!wkey){wkey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);for(var wcache={},i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];wcache[key]=key}sources[wkey]=[Function(["require","module","exports"],"("+fn+")(self)"),wcache]}var skey=Math.floor(Math.pow(16,8)*Math.random()).toString(16),scache={};scache[wkey]=wkey,sources[skey]=[Function(["require"],"var f = require("+stringify(wkey)+");(f.default ? f.default : f)(self);"),scache];var workerSources={};resolveSources(skey);var src="("+bundleFn+")({"+Object.keys(workerSources).map(function(key){return stringify(key)+":["+sources[key][0]+","+stringify(sources[key][1])+"]"}).join(",")+"},{},["+stringify(skey)+"])",URL=window.URL||window.webkitURL||window.mozURL||window.msURL,blob=new Blob([src],{type:"text/javascript"});if(options&&options.bare)return blob;var workerUrl=URL.createObjectURL(blob),worker=new Worker(workerUrl);return worker.objectURL=workerUrl,worker}},{}],4:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_bufferHelper=require("../helper/buffer-helper"),_bufferHelper2=_interopRequireDefault(_bufferHelper),_errors=require("../errors"),_logger=require("../utils/logger"),_ewmaBandwidthEstimator=require("./ewma-bandwidth-estimator"),_ewmaBandwidthEstimator2=_interopRequireDefault(_ewmaBandwidthEstimator),AbrController=function(_EventHandler){function AbrController(hls){_classCallCheck(this,AbrController);var _this=_possibleConstructorReturn(this,(AbrController.__proto__||Object.getPrototypeOf(AbrController)).call(this,hls,_events2.default.FRAG_LOADING,_events2.default.FRAG_LOADED,_events2.default.FRAG_BUFFERED,_events2.default.ERROR));return _this.lastLoadedFragLevel=0,_this._autoLevelCapping=-1,_this._nextAutoLevel=-1,_this.hls=hls,_this.onCheck=_this.abandonRulesCheck.bind(_this),_this}return _inherits(AbrController,_EventHandler),_createClass(AbrController,[{key:"destroy",value:function(){this.clearTimer(),_eventHandler2.default.prototype.destroy.call(this)}},{key:"onFragLoading",value:function(data){var frag=data.frag;if("main"===frag.type){if(this.timer||(this.timer=setInterval(this.onCheck,100)),!this.bwEstimator){var hls=this.hls,level=data.frag.level,isLive=hls.levels[level].details.live,config=hls.config,ewmaFast=void 0,ewmaSlow=void 0;isLive?(ewmaFast=config.abrEwmaFastLive,ewmaSlow=config.abrEwmaSlowLive):(ewmaFast=config.abrEwmaFastVoD,ewmaSlow=config.abrEwmaSlowVoD),this.bwEstimator=new _ewmaBandwidthEstimator2.default(hls,ewmaSlow,ewmaFast,config.abrEwmaDefaultEstimate)}this.fragCurrent=frag}}},{key:"abandonRulesCheck",value:function(){var hls=this.hls,v=hls.media,frag=this.fragCurrent,loader=frag.loader,minAutoLevel=this.minAutoLevel;if(!loader||loader.stats&&loader.stats.aborted)return _logger.logger.warn("frag loader destroy or aborted, disarm abandonRules"),void this.clearTimer();var stats=loader.stats;if(v&&(!v.paused&&0!==v.playbackRate||!v.readyState)&&frag.autoLevel&&frag.level){var requestDelay=performance.now()-stats.trequest,playbackRate=Math.abs(v.playbackRate);if(requestDelay>500*frag.duration/playbackRate){var levels=hls.levels,loadRate=Math.max(1,stats.bw?stats.bw/8:1e3*stats.loaded/requestDelay),level=levels[frag.level],levelBitrate=level.realbitrate?Math.max(level.realbitrate,level.bitrate):level.bitrate,expectedLen=stats.total?stats.total:Math.max(stats.loaded,Math.round(frag.duration*levelBitrate/8)),pos=v.currentTime,fragLoadedDelay=(expectedLen-stats.loaded)/loadRate,bufferStarvationDelay=(_bufferHelper2.default.bufferInfo(v,pos,hls.config.maxBufferHole).end-pos)/playbackRate;if(bufferStarvationDelay<2*frag.duration/playbackRate&&fragLoadedDelay>bufferStarvationDelay){var fragLevelNextLoadedDelay=void 0,nextLoadLevel=void 0;for(nextLoadLevel=frag.level-1;nextLoadLevel>minAutoLevel;nextLoadLevel--){var levelNextBitrate=levels[nextLoadLevel].realbitrate?Math.max(levels[nextLoadLevel].realbitrate,levels[nextLoadLevel].bitrate):levels[nextLoadLevel].bitrate;if(fragLevelNextLoadedDelay=frag.duration*levelNextBitrate/(6.4*loadRate),fragLevelNextLoadedDelay<bufferStarvationDelay)break}fragLevelNextLoadedDelay<fragLoadedDelay&&(_logger.logger.warn("loading too slow, abort fragment loading and switch to level "+nextLoadLevel+":fragLoadedDelay["+nextLoadLevel+"]<fragLoadedDelay["+(frag.level-1)+"];bufferStarvationDelay:"+fragLevelNextLoadedDelay.toFixed(1)+"<"+fragLoadedDelay.toFixed(1)+":"+bufferStarvationDelay.toFixed(1)),hls.nextLoadLevel=nextLoadLevel,this.bwEstimator.sample(requestDelay,stats.loaded),loader.abort(),this.clearTimer(),hls.trigger(_events2.default.FRAG_LOAD_EMERGENCY_ABORTED,{frag:frag,stats:stats}))}}}}},{key:"onFragLoaded",value:function(data){var frag=data.frag;if("main"===frag.type){this.clearTimer(),this.lastLoadedFragLevel=frag.level,this._nextAutoLevel=-1;var level=this.hls.levels[frag.level],loadedBytes=(level.loaded?level.loaded.bytes:0)+data.stats.loaded,loadedDuration=(level.loaded?level.loaded.duration:0)+data.frag.duration;if(level.loaded={bytes:loadedBytes,duration:loadedDuration},level.realBitrate=Math.round(8*loadedBytes/loadedDuration),data.frag.bitrateTest){var stats=data.stats;stats.tparsed=stats.tbuffered=stats.tload,this.onFragBuffered(data)}}}},{key:"onFragBuffered",value:function(data){var stats=data.stats,frag=data.frag;if(stats.aborted!==!0&&1===frag.loadCounter&&"main"===frag.type&&(!frag.bitrateTest||stats.tload===stats.tbuffered)){var fragLoadingProcessingMs=stats.tparsed-stats.trequest;_logger.logger.log("latency/loading/parsing/append/kbps:"+Math.round(stats.tfirst-stats.trequest)+"/"+Math.round(stats.tload-stats.tfirst)+"/"+Math.round(stats.tparsed-stats.tload)+"/"+Math.round(stats.tbuffered-stats.tparsed)+"/"+Math.round(8*stats.loaded/(stats.tbuffered-stats.trequest))),this.bwEstimator.sample(fragLoadingProcessingMs,stats.loaded),frag.bitrateTest?this.bitrateTestDelay=fragLoadingProcessingMs/1e3:this.bitrateTestDelay=0}}},{key:"onError",value:function(data){switch(data.details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer()}}},{key:"clearTimer",value:function(){this.timer&&(clearInterval(this.timer),this.timer=null)}},{key:"findBestLevel",value:function(currentLevel,currentFragDuration,currentBw,minAutoLevel,maxAutoLevel,maxFetchDuration,bwFactor,bwUpFactor,levels){for(var i=maxAutoLevel;i>=minAutoLevel;i--){var levelInfo=levels[i],levelDetails=levelInfo.details,avgDuration=levelDetails?levelDetails.totalduration/levelDetails.fragments.length:currentFragDuration,live=!!levelDetails&&levelDetails.live,adjustedbw=void 0;adjustedbw=i<=currentLevel?bwFactor*currentBw:bwUpFactor*currentBw;var bitrate=levels[i].realbitrate?Math.max(levels[i].realbitrate,levels[i].bitrate):levels[i].bitrate,fetchDuration=bitrate*avgDuration/adjustedbw;if(_logger.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+i+"/"+Math.round(adjustedbw)+"/"+bitrate+"/"+avgDuration+"/"+maxFetchDuration+"/"+fetchDuration),adjustedbw>bitrate&&(!fetchDuration||live||fetchDuration<maxFetchDuration))return i}return-1}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(newLevel){this._autoLevelCapping=newLevel}},{key:"nextAutoLevel",get:function(){var nextAutoLevel=this._nextAutoLevel,bwEstimator=this.bwEstimator,hls=this.hls,levels=hls.levels,minAutoBitrate=hls.config.minAutoBitrate;if(!(nextAutoLevel===-1||bwEstimator&&bwEstimator.canEstimate()))return Math.min(nextAutoLevel,this.maxAutoLevel);var nextABRAutoLevel=this.nextABRAutoLevel;if(nextAutoLevel!==-1&&(nextABRAutoLevel=Math.min(nextAutoLevel,nextABRAutoLevel)),void 0!==minAutoBitrate)for(var levelNextBitrate=levels[nextABRAutoLevel].realbitrate?Math.max(levels[nextABRAutoLevel].realbitrate,levels[nextABRAutoLevel].bitrate):levels[nextABRAutoLevel].bitrate;levelNextBitrate<minAutoBitrate;)nextABRAutoLevel++;return nextABRAutoLevel},set:function(nextLevel){this._nextAutoLevel=nextLevel}},{key:"minAutoLevel",get:function(){for(var hls=this.hls,levels=hls.levels,minAutoBitrate=hls.config.minAutoBitrate,len=levels?levels.length:0,i=0;i<len;i++){var levelNextBitrate=levels[i].realbitrate?Math.max(levels[i].realbitrate,levels[i].bitrate):levels[i].bitrate;if(levelNextBitrate>minAutoBitrate)return i}return 0}},{key:"maxAutoLevel",get:function(){var maxAutoLevel,levels=this.hls.levels,autoLevelCapping=this._autoLevelCapping;return maxAutoLevel=autoLevelCapping===-1&&levels&&levels.length?levels.length-1:autoLevelCapping}},{key:"nextABRAutoLevel",get:function(){var hls=this.hls,maxAutoLevel=this.maxAutoLevel,levels=hls.levels,config=hls.config,minAutoLevel=this.minAutoLevel,v=hls.media,currentLevel=this.lastLoadedFragLevel,currentFragDuration=this.fragCurrent?this.fragCurrent.duration:0,pos=v?v.currentTime:0,playbackRate=v&&0!==v.playbackRate?Math.abs(v.playbackRate):1,avgbw=this.bwEstimator?this.bwEstimator.getEstimate():config.abrEwmaDefaultEstimate,bufferStarvationDelay=(_bufferHelper2.default.bufferInfo(v,pos,config.maxBufferHole).end-pos)/playbackRate,bestLevel=this.findBestLevel(currentLevel,currentFragDuration,avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,config.abrBandWidthFactor,config.abrBandWidthUpFactor,levels);if(bestLevel>=0)return bestLevel;_logger.logger.trace("rebuffering expected to happen, lets try to find a quality level minimizing the rebuffering");var maxStarvationDelay=config.maxStarvationDelay,bwFactor=config.abrBandWidthFactor,bwUpFactor=config.abrBandWidthUpFactor;if(0===bufferStarvationDelay){var bitrateTestDelay=this.bitrateTestDelay;if(bitrateTestDelay){var maxLoadingDelay=currentFragDuration?Math.min(currentFragDuration,config.maxLoadingDelay):config.maxLoadingDelay;maxStarvationDelay=maxLoadingDelay-bitrateTestDelay,_logger.logger.trace("bitrate test took "+Math.round(1e3*bitrateTestDelay)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*maxStarvationDelay)+" ms"),bwFactor=bwUpFactor=1}}return bestLevel=this.findBestLevel(currentLevel,currentFragDuration,avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay+maxStarvationDelay,bwFactor,bwUpFactor,levels),Math.max(bestLevel,0)}}]),AbrController}(_eventHandler2.default);exports.default=AbrController},{"../errors":26,"../event-handler":27,"../events":28,"../helper/buffer-helper":30,"../utils/logger":45,"./ewma-bandwidth-estimator":9}],5:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_binarySearch=require("../utils/binary-search"),_binarySearch2=_interopRequireDefault(_binarySearch),_bufferHelper=require("../helper/buffer-helper"),_bufferHelper2=_interopRequireDefault(_bufferHelper),_demuxer=require("../demux/demuxer"),_demuxer2=_interopRequireDefault(_demuxer),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_levelHelper=require("../helper/level-helper"),_levelHelper2=_interopRequireDefault(_levelHelper),_timeRanges=require("../utils/timeRanges"),_timeRanges2=_interopRequireDefault(_timeRanges),_errors=require("../errors"),_logger=require("../utils/logger"),State={STOPPED:"STOPPED",STARTING:"STARTING",IDLE:"IDLE",PAUSED:"PAUSED",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",BUFFER_FLUSHING:"BUFFER_FLUSHING",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS"},AudioStreamController=function(_EventHandler){function AudioStreamController(hls){_classCallCheck(this,AudioStreamController);var _this=_possibleConstructorReturn(this,(AudioStreamController.__proto__||Object.getPrototypeOf(AudioStreamController)).call(this,hls,_events2.default.MEDIA_ATTACHED,_events2.default.MEDIA_DETACHING,_events2.default.AUDIO_TRACKS_UPDATED,_events2.default.AUDIO_TRACK_SWITCHING,_events2.default.AUDIO_TRACK_LOADED,_events2.default.KEY_LOADED,_events2.default.FRAG_LOADED,_events2.default.FRAG_PARSING_INIT_SEGMENT,_events2.default.FRAG_PARSING_DATA,_events2.default.FRAG_PARSED,_events2.default.ERROR,_events2.default.BUFFER_CREATED,_events2.default.BUFFER_APPENDED,_events2.default.BUFFER_FLUSHED,_events2.default.INIT_PTS_FOUND));return _this.config=hls.config,_this.audioCodecSwap=!1,_this.ticks=0,_this._state=State.STOPPED,_this.ontick=_this.tick.bind(_this),_this.initPTS=[],_this.waitingFragment=null,_this}return _inherits(AudioStreamController,_EventHandler),_createClass(AudioStreamController,[{key:"destroy",value:function(){this.stopLoad(),this.timer&&(clearInterval(this.timer),this.timer=null),_eventHandler2.default.prototype.destroy.call(this),this.state=State.STOPPED}},{key:"onInitPtsFound",value:function(data){var demuxerId=data.id,cc=data.cc,initPTS=data.initPTS;"main"===demuxerId&&(this.initPTS[cc]=initPTS,_logger.logger.log("InitPTS for cc:"+cc+" found from video track:"+initPTS),this.state===State.WAITING_INIT_PTS&&(_logger.logger.log("sending pending audio frag to demuxer"),this.state=State.FRAG_LOADING,this.onFragLoaded(this.waitingFragment),this.waitingFragment=null))}},{key:"startLoad",value:function(startPosition){if(this.tracks){var lastCurrentTime=this.lastCurrentTime;this.stopLoad(),this.timer||(this.timer=setInterval(this.ontick,100)),this.fragLoadError=0,lastCurrentTime>0&&startPosition===-1?(_logger.logger.log("audio:override startPosition with lastCurrentTime @"+lastCurrentTime.toFixed(3)),this.state=State.IDLE):(this.lastCurrentTime=this.startPosition?this.startPosition:startPosition,this.state=State.STARTING),this.nextLoadPosition=this.startPosition=this.lastCurrentTime,this.tick()}else this.startPosition=startPosition,this.state=State.STOPPED}},{key:"stopLoad",value:function(){var frag=this.fragCurrent;frag&&(frag.loader&&frag.loader.abort(),this.fragCurrent=null),this.fragPrevious=null,this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),this.state=State.STOPPED}},{key:"tick",value:function(){this.ticks++,1===this.ticks&&(this.doTick(),this.ticks>1&&setTimeout(this.tick,1),this.ticks=0)}},{key:"doTick",value:function(){var pos,track,trackDetails,now,retryDate,isSeeking,_this2=this,hls=this.hls,config=hls.config,_ret=function(){switch(_this2.state){case State.ERROR:case State.PAUSED:case State.BUFFER_FLUSHING:break;case State.STARTING:_this2.state=State.WAITING_TRACK,_this2.loadedmetadata=!1;break;case State.IDLE:var tracks=_this2.tracks;if(!tracks)break;if(!_this2.media&&(_this2.startFragRequested||!config.startFragPrefetch))break;pos=_this2.loadedmetadata?_this2.media.currentTime:_this2.nextLoadPosition;var media=_this2.mediaBuffer?_this2.mediaBuffer:_this2.media,bufferInfo=_bufferHelper2.default.bufferInfo(media,pos,config.maxBufferHole),bufferLen=bufferInfo.len,bufferEnd=bufferInfo.end,fragPrevious=_this2.fragPrevious,maxBufLen=config.maxMaxBufferLength,audioSwitch=_this2.audioSwitch,trackId=_this2.trackId;if(bufferLen<maxBufLen&&trackId<tracks.length){if(trackDetails=tracks[trackId].details,"undefined"==typeof trackDetails){_this2.state=State.WAITING_TRACK;break}if(!audioSwitch&&!trackDetails.live&&fragPrevious&&fragPrevious.sn===trackDetails.endSN&&(!_this2.media.seeking||_this2.media.duration-bufferEnd<fragPrevious.duration/2)){_this2.hls.trigger(_events2.default.BUFFER_EOS,{type:"audio"}),_this2.state=State.ENDED;break}var fragments=trackDetails.fragments,fragLen=fragments.length,start=fragments[0].start,end=fragments[fragLen-1].start+fragments[fragLen-1].duration,frag=void 0;if(audioSwitch)if(trackDetails.live&&!trackDetails.PTSKnown)_logger.logger.log("switching audiotrack, live stream, unknown PTS,load first fragment"),bufferEnd=0;else if(bufferEnd=pos,trackDetails.PTSKnown&&pos<start){if(!(bufferInfo.end>start||bufferInfo.nextStart))return{v:void 0};_logger.logger.log("alt audio track ahead of main track, seek to start of alt audio track"),_this2.media.currentTime=start+.05}if(bufferEnd<=start){if(frag=fragments[0],trackDetails.live&&frag.loadIdx&&frag.loadIdx===_this2.fragLoadIdx){var nextBuffered=bufferInfo.nextStart?bufferInfo.nextStart:start;return _logger.logger.log("no alt audio available @currentTime:"+_this2.media.currentTime+", seeking @"+(nextBuffered+.05)),_this2.media.currentTime=nextBuffered+.05,{v:void 0}}}else!function(){var foundFrag=void 0,maxFragLookUpTolerance=config.maxFragLookUpTolerance;bufferEnd<end?(bufferEnd>end-maxFragLookUpTolerance&&(maxFragLookUpTolerance=0),foundFrag=_binarySearch2.default.search(fragments,function(candidate){return candidate.start+candidate.duration-maxFragLookUpTolerance<=bufferEnd?1:candidate.start-maxFragLookUpTolerance>bufferEnd?-1:0}),foundFrag||_logger.logger.log("frag not found @bufferEnd/start:"+bufferEnd+"/"+start)):foundFrag=fragments[fragLen-1],foundFrag&&(frag=foundFrag,start=foundFrag.start,fragPrevious&&frag.level===fragPrevious.level&&frag.sn===fragPrevious.sn&&(frag.sn<trackDetails.endSN?(frag=fragments[frag.sn+1-trackDetails.startSN],_logger.logger.log("SN just loaded, load next one: "+frag.sn)):frag=null))}();if(frag)if(null!=frag.decryptdata.uri&&null==frag.decryptdata.key)_logger.logger.log("Loading key for "+frag.sn+" of ["+trackDetails.startSN+" ,"+trackDetails.endSN+"],track "+trackId),_this2.state=State.KEY_LOADING,hls.trigger(_events2.default.KEY_LOADING,{frag:frag});else{if(_logger.logger.log("Loading "+frag.sn+" of ["+trackDetails.startSN+" ,"+trackDetails.endSN+"],track "+trackId+", currentTime:"+pos+",bufferEnd:"+bufferEnd.toFixed(3)),void 0!==_this2.fragLoadIdx?_this2.fragLoadIdx++:_this2.fragLoadIdx=0,frag.loadCounter){frag.loadCounter++;var maxThreshold=config.fragLoadingLoopThreshold;if(frag.loadCounter>maxThreshold&&Math.abs(_this2.fragLoadIdx-frag.loadIdx)<maxThreshold)return hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR,fatal:!1,frag:frag}),{v:void 0}}else frag.loadCounter=1;frag.loadIdx=_this2.fragLoadIdx,_this2.fragCurrent=frag,_this2.startFragRequested=!0,_this2.nextLoadPosition=frag.start+frag.duration,hls.trigger(_events2.default.FRAG_LOADING,{frag:frag}),_this2.state=State.FRAG_LOADING}}break;case State.WAITING_TRACK:track=_this2.tracks[_this2.trackId],track&&track.details&&(_this2.state=State.IDLE);break;case State.FRAG_LOADING_WAITING_RETRY:now=performance.now(),retryDate=_this2.retryDate,media=_this2.media,isSeeking=media&&media.seeking,(!retryDate||now>=retryDate||isSeeking)&&(_logger.logger.log("audioStreamController: retryDate reached, switch back to IDLE state"),_this2.state=State.IDLE);break;case State.WAITING_INIT_PTS:case State.STOPPED:case State.FRAG_LOADING:case State.PARSING:case State.PARSED:case State.ENDED:}}();if("object"===("undefined"==typeof _ret?"undefined":_typeof(_ret)))return _ret.v}},{key:"onMediaAttached",value:function(data){var media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),media.addEventListener("seeking",this.onvseeking),media.addEventListener("ended",this.onvended);var config=this.config;this.tracks&&config.autoStartLoad&&this.startLoad(config.startPosition)}},{key:"onMediaDetaching",value:function(){var media=this.media;media&&media.ended&&(_logger.logger.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0);var tracks=this.tracks;tracks&&tracks.forEach(function(track){track.details&&track.details.fragments.forEach(function(fragment){fragment.loadCounter=void 0})}),media&&(media.removeEventListener("seeking",this.onvseeking),media.removeEventListener("ended",this.onvended),this.onvseeking=this.onvseeked=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.stopLoad()}},{key:"onMediaSeeking",value:function(){this.state===State.ENDED&&(this.state=State.IDLE),this.media&&(this.lastCurrentTime=this.media.currentTime),void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold),this.tick()}},{key:"onMediaEnded",value:function(){this.startPosition=this.lastCurrentTime=0}},{key:"onAudioTracksUpdated",value:function(data){_logger.logger.log("audio tracks updated"),this.tracks=data.audioTracks}},{key:"onAudioTrackSwitching",value:function(data){var altAudio=!!data.url;this.trackId=data.id,this.state=State.IDLE,this.fragCurrent=null,this.state=State.PAUSED,this.waitingFragment=null,altAudio?this.timer||(this.timer=setInterval(this.ontick,100)):this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),altAudio&&(this.audioSwitch=!0,this.state=State.IDLE,void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold)),this.tick()}},{key:"onAudioTrackLoaded",value:function(data){var newDetails=data.details,trackId=data.id,track=this.tracks[trackId],duration=newDetails.totalduration,sliding=0;
if(_logger.logger.log("track "+trackId+" loaded ["+newDetails.startSN+","+newDetails.endSN+"],duration:"+duration),newDetails.live){var curDetails=track.details;curDetails&&newDetails.fragments.length>0?(_levelHelper2.default.mergeDetails(curDetails,newDetails),sliding=newDetails.fragments[0].start,newDetails.PTSKnown?_logger.logger.log("live audio playlist sliding:"+sliding.toFixed(3)):_logger.logger.log("live audio playlist - outdated PTS, unknown sliding")):(newDetails.PTSKnown=!1,_logger.logger.log("live audio playlist - first load, unknown sliding"))}else newDetails.PTSKnown=!1;if(track.details=newDetails,!this.startFragRequested){if(this.startPosition===-1){var startTimeOffset=newDetails.startTimeOffset;isNaN(startTimeOffset)?this.startPosition=0:(_logger.logger.log("start time offset found in playlist, adjust startPosition to "+startTimeOffset),this.startPosition=startTimeOffset)}this.nextLoadPosition=this.startPosition}this.state===State.WAITING_TRACK&&(this.state=State.IDLE),this.tick()}},{key:"onKeyLoaded",value:function(){this.state===State.KEY_LOADING&&(this.state=State.IDLE,this.tick())}},{key:"onFragLoaded",value:function(data){var fragCurrent=this.fragCurrent;if(this.state===State.FRAG_LOADING&&fragCurrent&&"audio"===data.frag.type&&data.frag.level===fragCurrent.level&&data.frag.sn===fragCurrent.sn){this.state=State.PARSING,this.stats=data.stats;var track=this.tracks[this.trackId],details=track.details,duration=details.totalduration,start=fragCurrent.start,trackId=fragCurrent.level,sn=fragCurrent.sn,cc=fragCurrent.cc,audioCodec=this.config.defaultAudioCodec||track.audioCodec;this.appended=!1,this.demuxer||(this.demuxer=new _demuxer2.default(this.hls,"audio"));var initPTS=this.initPTS[cc];if(void 0!==initPTS){this.pendingBuffering=!0,_logger.logger.log("Demuxing "+sn+" of ["+details.startSN+" ,"+details.endSN+"],track "+trackId);var accurateTimeOffset=!1;this.demuxer.push(data.payload,audioCodec,null,start,cc,trackId,sn,duration,fragCurrent.decryptdata,accurateTimeOffset,initPTS)}else _logger.logger.log("unknown video PTS for continuity counter "+cc+", waiting for video PTS before demuxing audio frag "+sn+" of ["+details.startSN+" ,"+details.endSN+"],track "+trackId),this.waitingFragment=data,this.state=State.WAITING_INIT_PTS}this.fragLoadError=0}},{key:"onFragParsingInitSegment",value:function(data){var fragCurrent=this.fragCurrent;if(fragCurrent&&"audio"===data.id&&data.sn===fragCurrent.sn&&data.level===fragCurrent.level&&this.state===State.PARSING){var tracks=data.tracks,track=void 0;if(tracks.video&&delete tracks.video,track=tracks.audio){track.levelCodec="mp4a.40.2",track.id=data.id,this.hls.trigger(_events2.default.BUFFER_CODECS,tracks),_logger.logger.log("audio track:audio,container:"+track.container+",codecs[level/parsed]=["+track.levelCodec+"/"+track.codec+"]");var initSegment=track.initSegment;if(initSegment){var appendObj={type:"audio",data:initSegment,parent:"audio",content:"initSegment"};this.audioSwitch?this.pendingData=[appendObj]:(this.appended=!0,this.pendingBuffering=!0,this.hls.trigger(_events2.default.BUFFER_APPENDING,appendObj))}this.tick()}}}},{key:"onFragParsingData",value:function(data){var _this3=this,fragCurrent=this.fragCurrent;fragCurrent&&"audio"===data.id&&"audio"===data.type&&data.sn===fragCurrent.sn&&data.level===fragCurrent.level&&this.state===State.PARSING&&!function(){var trackId=_this3.trackId,track=_this3.tracks[trackId],frag=_this3.fragCurrent,hls=_this3.hls;_logger.logger.log("parsed "+data.type+",PTS:["+data.startPTS.toFixed(3)+","+data.endPTS.toFixed(3)+"],DTS:["+data.startDTS.toFixed(3)+"/"+data.endDTS.toFixed(3)+"],nb:"+data.nb),_levelHelper2.default.updateFragPTSDTS(track.details,frag.sn,data.startPTS,data.endPTS);var audioSwitch=_this3.audioSwitch,media=_this3.media,appendOnBufferFlush=!1;if(audioSwitch&&media)if(media.readyState){var currentTime=media.currentTime;_logger.logger.log("switching audio track : currentTime:"+currentTime),currentTime>=data.startPTS&&(_logger.logger.log("switching audio track : flushing all audio"),_this3.state=State.BUFFER_FLUSHING,hls.trigger(_events2.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),appendOnBufferFlush=!0,_this3.audioSwitch=!1,hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:trackId}))}else _this3.audioSwitch=!1,hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:trackId});var pendingData=_this3.pendingData;_this3.audioSwitch||([data.data1,data.data2].forEach(function(buffer){buffer&&pendingData.push({type:data.type,data:buffer,parent:"audio",content:"data"})}),!appendOnBufferFlush&&pendingData.length&&(pendingData.forEach(function(appendObj){_this3.pendingBuffering=!0,_this3.hls.trigger(_events2.default.BUFFER_APPENDING,appendObj)}),_this3.pendingData=[],_this3.appended=!0)),_this3.tick()}()}},{key:"onFragParsed",value:function(data){var fragCurrent=this.fragCurrent;fragCurrent&&"audio"===data.id&&data.sn===fragCurrent.sn&&data.level===fragCurrent.level&&this.state===State.PARSING&&(this.stats.tparsed=performance.now(),this.state=State.PARSED,this._checkAppendedParsed())}},{key:"onBufferCreated",value:function(data){var audioTrack=data.tracks.audio;audioTrack&&(this.mediaBuffer=audioTrack.buffer,this.loadedmetadata=!0)}},{key:"onBufferAppended",value:function(data){if("audio"===data.parent){var state=this.state;state!==State.PARSING&&state!==State.PARSED||(this.pendingBuffering=data.pending>0,this._checkAppendedParsed())}}},{key:"_checkAppendedParsed",value:function(){if(!(this.state!==State.PARSED||this.appended&&this.pendingBuffering)){var frag=this.fragCurrent,stats=this.stats,hls=this.hls;if(frag){this.fragPrevious=frag,stats.tbuffered=performance.now(),hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:frag,id:"audio"});var media=this.mediaBuffer?this.mediaBuffer:this.media;_logger.logger.log("audio buffered : "+_timeRanges2.default.toString(media.buffered)),this.audioSwitch&&this.appended&&(this.audioSwitch=!1,hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:this.trackId})),this.state=State.IDLE}this.tick()}}},{key:"onError",value:function(data){var frag=data.frag;if(!frag||"audio"===frag.type)switch(data.details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:if(!data.fatal){var loadError=this.fragLoadError;loadError?loadError++:loadError=1;var config=this.config;if(loadError<=config.fragLoadingMaxRetry){this.fragLoadError=loadError,frag.loadCounter=0;var delay=Math.min(Math.pow(2,loadError-1)*config.fragLoadingRetryDelay,config.fragLoadingMaxRetryTimeout);_logger.logger.warn("audioStreamController: frag loading failed, retry in "+delay+" ms"),this.retryDate=performance.now()+delay,this.state=State.FRAG_LOADING_WAITING_RETRY}else _logger.logger.error("audioStreamController: "+data.details+" reaches max retry, redispatch as fatal ..."),data.fatal=!0,this.hls.trigger(_events2.default.ERROR,data),this.state=State.ERROR}break;case _errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR:case _errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case _errors.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case _errors.ErrorDetails.KEY_LOAD_ERROR:case _errors.ErrorDetails.KEY_LOAD_TIMEOUT:this.state!==State.ERROR&&(this.state=data.fatal?State.ERROR:State.IDLE,_logger.logger.warn("audioStreamController: "+data.details+" while loading frag,switch to "+this.state+" state ..."))}}},{key:"onBufferFlushed",value:function(){var _this4=this,pendingData=this.pendingData;pendingData&&pendingData.length?(_logger.logger.log("appending pending audio data on Buffer Flushed"),pendingData.forEach(function(appendObj){_this4.hls.trigger(_events2.default.BUFFER_APPENDING,appendObj)}),this.appended=!0,this.pendingData=[],this.state=State.PARSED):(this.state=State.IDLE,this.fragPrevious=null,this.tick())}},{key:"state",set:function(nextState){if(this.state!==nextState){var previousState=this.state;this._state=nextState,_logger.logger.log("audio stream:"+previousState+"->"+nextState)}},get:function(){return this._state}}]),AudioStreamController}(_eventHandler2.default);exports.default=AudioStreamController},{"../demux/demuxer":22,"../errors":26,"../event-handler":27,"../events":28,"../helper/buffer-helper":30,"../helper/level-helper":31,"../utils/binary-search":41,"../utils/logger":45,"../utils/timeRanges":46}],6:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_logger=require("../utils/logger"),AudioTrackController=function(_EventHandler){function AudioTrackController(hls){_classCallCheck(this,AudioTrackController);var _this=_possibleConstructorReturn(this,(AudioTrackController.__proto__||Object.getPrototypeOf(AudioTrackController)).call(this,hls,_events2.default.MANIFEST_LOADING,_events2.default.MANIFEST_LOADED,_events2.default.AUDIO_TRACK_LOADED));return _this.ticks=0,_this.ontick=_this.tick.bind(_this),_this}return _inherits(AudioTrackController,_EventHandler),_createClass(AudioTrackController,[{key:"destroy",value:function(){_eventHandler2.default.prototype.destroy.call(this)}},{key:"tick",value:function(){this.ticks++,1===this.ticks&&(this.doTick(),this.ticks>1&&setTimeout(this.tick,1),this.ticks=0)}},{key:"doTick",value:function(){this.updateTrack(this.trackId)}},{key:"onManifestLoading",value:function(){this.tracks=[],this.trackId=-1}},{key:"onManifestLoaded",value:function(data){var _this2=this,tracks=data.audioTracks||[],defaultFound=!1;this.tracks=tracks,this.hls.trigger(_events2.default.AUDIO_TRACKS_UPDATED,{audioTracks:tracks});var id=0;tracks.forEach(function(track){return track.default?(_this2.audioTrack=id,void(defaultFound=!0)):void id++}),defaultFound===!1&&tracks.length&&(_logger.logger.log("no default audio track defined, use first audio track as default"),this.audioTrack=0)}},{key:"onAudioTrackLoaded",value:function(data){data.id<this.tracks.length&&(_logger.logger.log("audioTrack "+data.id+" loaded"),this.tracks[data.id].details=data.details,data.details.live&&!this.timer&&(this.timer=setInterval(this.ontick,1e3*data.details.targetduration)),!data.details.live&&this.timer&&(clearInterval(this.timer),this.timer=null))}},{key:"setAudioTrackInternal",value:function(newId){if(newId>=0&&newId<this.tracks.length){this.timer&&(clearInterval(this.timer),this.timer=null),this.trackId=newId,_logger.logger.log("switching to audioTrack "+newId);var audioTrack=this.tracks[newId],hls=this.hls,type=audioTrack.type,url=audioTrack.url,eventObj={id:newId,type:type,url:url};hls.trigger(_events2.default.AUDIO_TRACK_SWITCH,eventObj),hls.trigger(_events2.default.AUDIO_TRACK_SWITCHING,eventObj);var details=audioTrack.details;!url||void 0!==details&&details.live!==!0||(_logger.logger.log("(re)loading playlist for audioTrack "+newId),hls.trigger(_events2.default.AUDIO_TRACK_LOADING,{url:url,id:newId}))}}},{key:"updateTrack",value:function(newId){if(newId>=0&&newId<this.tracks.length){this.timer&&(clearInterval(this.timer),this.timer=null),this.trackId=newId,_logger.logger.log("updating audioTrack "+newId);var audioTrack=this.tracks[newId],url=audioTrack.url,details=audioTrack.details;!url||void 0!==details&&details.live!==!0||(_logger.logger.log("(re)loading playlist for audioTrack "+newId),this.hls.trigger(_events2.default.AUDIO_TRACK_LOADING,{url:url,id:newId}))}}},{key:"audioTracks",get:function(){return this.tracks}},{key:"audioTrack",get:function(){return this.trackId},set:function(audioTrackId){this.trackId===audioTrackId&&void 0!==this.tracks[audioTrackId].details||this.setAudioTrackInternal(audioTrackId)}}]),AudioTrackController}(_eventHandler2.default);exports.default=AudioTrackController},{"../event-handler":27,"../events":28,"../utils/logger":45}],7:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_logger=require("../utils/logger"),_errors=require("../errors"),BufferController=function(_EventHandler){function BufferController(hls){_classCallCheck(this,BufferController);var _this=_possibleConstructorReturn(this,(BufferController.__proto__||Object.getPrototypeOf(BufferController)).call(this,hls,_events2.default.MEDIA_ATTACHING,_events2.default.MEDIA_DETACHING,_events2.default.MANIFEST_PARSED,_events2.default.BUFFER_RESET,_events2.default.BUFFER_APPENDING,_events2.default.BUFFER_CODECS,_events2.default.BUFFER_EOS,_events2.default.BUFFER_FLUSHING,_events2.default.LEVEL_PTS_UPDATED,_events2.default.LEVEL_UPDATED));return _this._msDuration=null,_this._levelDuration=null,_this.onsbue=_this.onSBUpdateEnd.bind(_this),_this.onsbe=_this.onSBUpdateError.bind(_this),_this.pendingTracks={},_this.tracks={},_this}return _inherits(BufferController,_EventHandler),_createClass(BufferController,[{key:"destroy",value:function(){_eventHandler2.default.prototype.destroy.call(this)}},{key:"onLevelPtsUpdated",value:function(data){var type=data.type,audioTrack=this.tracks.audio;if("audio"===type&&audioTrack&&"audio/mpeg"===audioTrack.container){var audioBuffer=this.sourceBuffer.audio,delta=Math.abs(audioBuffer.timestampOffset-data.start);if(delta>.1){var updating=audioBuffer.updating;try{audioBuffer.abort()}catch(err){updating=!0,_logger.logger.warn("can not abort audio buffer: "+err)}updating?this.audioTimestampOffset=data.start:(_logger.logger.warn("change mpeg audio timestamp offset from "+audioBuffer.timestampOffset+" to "+data.start),audioBuffer.timestampOffset=data.start)}}}},{key:"onManifestParsed",value:function(data){var audioExpected=data.audio,videoExpected=data.video,sourceBufferNb=0;data.altAudio&&(audioExpected||videoExpected)&&(sourceBufferNb=(audioExpected?1:0)+(videoExpected?1:0),_logger.logger.log(sourceBufferNb+" sourceBuffer(s) expected")),this.sourceBufferNb=sourceBufferNb}},{key:"onMediaAttaching",value:function(data){var media=this.media=data.media;if(media){var ms=this.mediaSource=new MediaSource;this.onmso=this.onMediaSourceOpen.bind(this),this.onmse=this.onMediaSourceEnded.bind(this),this.onmsc=this.onMediaSourceClose.bind(this),ms.addEventListener("sourceopen",this.onmso),ms.addEventListener("sourceended",this.onmse),ms.addEventListener("sourceclose",this.onmsc),media.src=URL.createObjectURL(ms)}}},{key:"onMediaDetaching",value:function(){_logger.logger.log("media source detaching");var ms=this.mediaSource;if(ms){if("open"===ms.readyState)try{ms.endOfStream()}catch(err){_logger.logger.warn("onMediaDetaching:"+err.message+" while calling endOfStream")}ms.removeEventListener("sourceopen",this.onmso),ms.removeEventListener("sourceended",this.onmse),ms.removeEventListener("sourceclose",this.onmsc),this.media&&(URL.revokeObjectURL(this.media.src),this.media.removeAttribute("src"),this.media.load()),this.mediaSource=null,this.media=null,this.pendingTracks={},this.tracks={},this.sourceBuffer={},this.flushRange=[],this.segments=[],this.appended=0}this.onmso=this.onmse=this.onmsc=null,this.hls.trigger(_events2.default.MEDIA_DETACHED)}},{key:"onMediaSourceOpen",value:function(){_logger.logger.log("media source opened"),this.hls.trigger(_events2.default.MEDIA_ATTACHED,{media:this.media});var mediaSource=this.mediaSource;mediaSource&&mediaSource.removeEventListener("sourceopen",this.onmso),this.checkPendingTracks()}},{key:"checkPendingTracks",value:function(){var pendingTracks=this.pendingTracks,pendingTracksNb=Object.keys(pendingTracks).length;pendingTracksNb&&(this.sourceBufferNb<=pendingTracksNb||0===this.sourceBufferNb)&&(this.createSourceBuffers(pendingTracks),this.pendingTracks={},this.doAppending())}},{key:"onMediaSourceClose",value:function(){_logger.logger.log("media source closed")}},{key:"onMediaSourceEnded",value:function(){_logger.logger.log("media source ended")}},{key:"onSBUpdateEnd",value:function(){if(this.audioTimestampOffset){var audioBuffer=this.sourceBuffer.audio;_logger.logger.warn("change mpeg audio timestamp offset from "+audioBuffer.timestampOffset+" to "+this.audioTimestampOffset),audioBuffer.timestampOffset=this.audioTimestampOffset,delete this.audioTimestampOffset}this._needsFlush&&this.doFlush(),this._needsEos&&this.checkEos(),this.appending=!1;var parent=this.parent,pending=this.segments.reduce(function(counter,segment){return segment.parent===parent?counter+1:counter},0);this.hls.trigger(_events2.default.BUFFER_APPENDED,{parent:parent,pending:pending}),this._needsFlush||this.doAppending(),this.updateMediaElementDuration()}},{key:"onSBUpdateError",value:function(event){_logger.logger.error("sourceBuffer error:"+event),this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1})}},{key:"onBufferReset",value:function(){var sourceBuffer=this.sourceBuffer;for(var type in sourceBuffer){var sb=sourceBuffer[type];try{this.mediaSource.removeSourceBuffer(sb),sb.removeEventListener("updateend",this.onsbue),sb.removeEventListener("error",this.onsbe)}catch(err){}}this.sourceBuffer={},this.flushRange=[],this.segments=[],this.appended=0}},{key:"onBufferCodecs",value:function(tracks){if(0===Object.keys(this.sourceBuffer).length){for(var trackName in tracks)this.pendingTracks[trackName]=tracks[trackName];var mediaSource=this.mediaSource;mediaSource&&"open"===mediaSource.readyState&&this.checkPendingTracks()}}},{key:"createSourceBuffers",value:function(tracks){var sourceBuffer=this.sourceBuffer,mediaSource=this.mediaSource;for(var trackName in tracks)if(!sourceBuffer[trackName]){var track=tracks[trackName],codec=track.levelCodec||track.codec,mimeType=track.container+";codecs="+codec;_logger.logger.log("creating sourceBuffer("+mimeType+")");try{var sb=sourceBuffer[trackName]=mediaSource.addSourceBuffer(mimeType);sb.addEventListener("updateend",this.onsbue),sb.addEventListener("error",this.onsbe),this.tracks[trackName]={codec:codec,container:track.container},track.buffer=sb}catch(err){_logger.logger.error("error while trying to add sourceBuffer:"+err.message),this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,err:err,mimeType:mimeType})}}this.hls.trigger(_events2.default.BUFFER_CREATED,{tracks:tracks})}},{key:"onBufferAppending",value:function(data){this._needsFlush||(this.segments?this.segments.push(data):this.segments=[data],this.doAppending())}},{key:"onBufferAppendFail",value:function(data){_logger.logger.error("sourceBuffer error:",data.event),this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1,frag:this.fragCurrent})}},{key:"onBufferEos",value:function(data){var sb=this.sourceBuffer,dataType=data.type;for(var type in sb)dataType&&type!==dataType||sb[type].ended||(sb[type].ended=!0,_logger.logger.log(type+" sourceBuffer now EOS"));this.checkEos()}},{key:"checkEos",value:function(){var sb=this.sourceBuffer,mediaSource=this.mediaSource;if(!mediaSource||"open"!==mediaSource.readyState)return void(this._needsEos=!1);for(var type in sb){var sbobj=sb[type];if(!sbobj.ended)return;if(sbobj.updating)return void(this._needsEos=!0)}_logger.logger.log("all media data available, signal endOfStream() to MediaSource and stop loading fragment");try{mediaSource.endOfStream()}catch(e){_logger.logger.warn("exception while calling mediaSource.endOfStream()")}this._needsEos=!1}},{key:"onBufferFlushing",value:function(data){this.flushRange.push({start:data.startOffset,end:data.endOffset,type:data.type}),this.flushBufferCounter=0,this.doFlush()}},{key:"onLevelUpdated",value:function(event){var details=event.details;0!==details.fragments.length&&(this._levelDuration=details.totalduration+details.fragments[0].start,this.updateMediaElementDuration())}},{key:"updateMediaElementDuration",value:function(){var media=this.media,mediaSource=this.mediaSource,sourceBuffer=this.sourceBuffer,levelDuration=this._levelDuration;if(null!==levelDuration&&media&&mediaSource&&sourceBuffer&&0!==media.readyState&&"open"===mediaSource.readyState){for(var type in sourceBuffer)if(sourceBuffer[type].updating)return;null===this._msDuration&&(this._msDuration=mediaSource.duration);var duration=media.duration;(levelDuration>this._msDuration&&levelDuration>duration||duration===1/0||isNaN(duration))&&(_logger.logger.log("Updating mediasource duration to "+levelDuration.toFixed(3)),this._msDuration=mediaSource.duration=levelDuration)}}},{key:"doFlush",value:function(){for(;this.flushRange.length;){var range=this.flushRange[0];if(!this.flushBuffer(range.start,range.end,range.type))return void(this._needsFlush=!0);this.flushRange.shift(),this.flushBufferCounter=0}if(0===this.flushRange.length){this._needsFlush=!1;var appended=0,sourceBuffer=this.sourceBuffer;try{for(var type in sourceBuffer)appended+=sourceBuffer[type].buffered.length}catch(error){_logger.logger.error("error while accessing sourceBuffer.buffered")}this.appended=appended,this.hls.trigger(_events2.default.BUFFER_FLUSHED)}}},{key:"doAppending",value:function(){var hls=this.hls,sourceBuffer=this.sourceBuffer,segments=this.segments;if(Object.keys(sourceBuffer).length){if(this.media.error)return this.segments=[],void _logger.logger.error("trying to append although a media error occured, flush segment and abort");if(this.appending)return;if(segments&&segments.length){var segment=segments.shift();try{var type=segment.type,sb=sourceBuffer[type];sb?sb.updating?segments.unshift(segment):(sb.ended=!1,this.parent=segment.parent,sb.appendBuffer(segment.data),this.appendError=0,this.appended++,this.appending=!0):this.onSBUpdateEnd()}catch(err){_logger.logger.error("error while trying to append buffer:"+err.message),segments.unshift(segment);var event={type:_errors.ErrorTypes.MEDIA_ERROR};if(22===err.code)return this.segments=[],event.details=_errors.ErrorDetails.BUFFER_FULL_ERROR,event.fatal=!1,void hls.trigger(_events2.default.ERROR,event);if(this.appendError?this.appendError++:this.appendError=1,event.details=_errors.ErrorDetails.BUFFER_APPEND_ERROR,event.frag=this.fragCurrent,this.appendError>hls.config.appendErrorMaxRetry)return _logger.logger.log("fail "+hls.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),segments=[],event.fatal=!0,void hls.trigger(_events2.default.ERROR,event);event.fatal=!1,hls.trigger(_events2.default.ERROR,event)}}}}},{key:"flushBuffer",value:function(startOffset,endOffset,typeIn){var sb,i,bufStart,bufEnd,flushStart,flushEnd,sourceBuffer=this.sourceBuffer;if(Object.keys(sourceBuffer).length){if(_logger.logger.log("flushBuffer,pos/start/end: "+this.media.currentTime.toFixed(3)+"/"+startOffset+"/"+endOffset),this.flushBufferCounter<this.appended){for(var type in sourceBuffer)if(!typeIn||type===typeIn){if(sb=sourceBuffer[type],sb.ended=!1,sb.updating)return _logger.logger.warn("cannot flush, sb updating in progress"),!1;try{for(i=0;i<sb.buffered.length;i++)if(bufStart=sb.buffered.start(i),bufEnd=sb.buffered.end(i),navigator.userAgent.toLowerCase().indexOf("firefox")!==-1&&endOffset===Number.POSITIVE_INFINITY?(flushStart=startOffset,flushEnd=endOffset):(flushStart=Math.max(bufStart,startOffset),flushEnd=Math.min(bufEnd,endOffset)),Math.min(flushEnd,bufEnd)-flushStart>.5)return this.flushBufferCounter++,_logger.logger.log("flush "+type+" ["+flushStart+","+flushEnd+"], of ["+bufStart+","+bufEnd+"], pos:"+this.media.currentTime),sb.remove(flushStart,flushEnd),!1}catch(e){_logger.logger.warn("exception while accessing sourcebuffer, it might have been removed from MediaSource")}}}else _logger.logger.warn("abort flushing too many retries");_logger.logger.log("buffer flushed")}return!0}}]),BufferController}(_eventHandler2.default);exports.default=BufferController},{"../errors":26,"../event-handler":27,"../events":28,"../utils/logger":45}],8:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),CapLevelController=function(_EventHandler){function CapLevelController(hls){return _classCallCheck(this,CapLevelController),_possibleConstructorReturn(this,(CapLevelController.__proto__||Object.getPrototypeOf(CapLevelController)).call(this,hls,_events2.default.FPS_DROP_LEVEL_CAPPING,_events2.default.MEDIA_ATTACHING,_events2.default.MANIFEST_PARSED))}return _inherits(CapLevelController,_EventHandler),_createClass(CapLevelController,[{key:"destroy",value:function(){this.hls.config.capLevelToPlayerSize&&(this.media=this.restrictedLevels=null,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(this.timer=clearInterval(this.timer)))}},{key:"onFpsDropLevelCapping",value:function(data){this.restrictedLevels||(this.restrictedLevels=[]),this.isLevelRestricted(data.droppedLevel)||this.restrictedLevels.push(data.droppedLevel)}},{key:"onMediaAttaching",value:function(data){this.media=data.media instanceof HTMLVideoElement?data.media:null}},{key:"onManifestParsed",value:function(data){var hls=this.hls;hls.config.capLevelToPlayerSize&&(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.levels=data.levels,hls.firstLevel=this.getMaxLevel(data.firstLevel),clearInterval(this.timer),this.timer=setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}},{key:"detectPlayerSize",value:function(){if(this.media){var levelsLength=this.levels?this.levels.length:0;if(levelsLength){var hls=this.hls;hls.autoLevelCapping=this.getMaxLevel(levelsLength-1),hls.autoLevelCapping>this.autoLevelCapping&&hls.streamController.nextLevelSwitch(),this.autoLevelCapping=hls.autoLevelCapping}}}},{key:"getMaxLevel",value:function(capLevelIndex){var result=0,i=void 0,level=void 0,mWidth=this.mediaWidth,mHeight=this.mediaHeight,lWidth=0,lHeight=0;for(i=0;i<=capLevelIndex&&(level=this.levels[i],!this.isLevelRestricted(i))&&(result=i,lWidth=level.width,lHeight=level.height,!(mWidth<=lWidth||mHeight<=lHeight));i++);return result}},{key:"isLevelRestricted",value:function(level){return!(!this.restrictedLevels||this.restrictedLevels.indexOf(level)===-1)}},{key:"contentScaleFactor",get:function(){var pixelRatio=1;try{pixelRatio=window.devicePixelRatio}catch(e){}return pixelRatio}},{key:"mediaWidth",get:function(){var width=void 0,media=this.media;return media&&(width=media.width||media.clientWidth||media.offsetWidth,width*=this.contentScaleFactor),width}},{key:"mediaHeight",get:function(){var height=void 0,media=this.media;return media&&(height=media.height||media.clientHeight||media.offsetHeight,height*=this.contentScaleFactor),height}}]),CapLevelController}(_eventHandler2.default);exports.default=CapLevelController},{"../event-handler":27,"../events":28}],9:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_ewma=require("../utils/ewma"),_ewma2=_interopRequireDefault(_ewma),EwmaBandWidthEstimator=function(){function EwmaBandWidthEstimator(hls,slow,fast,defaultEstimate){
_classCallCheck(this,EwmaBandWidthEstimator),this.hls=hls,this.defaultEstimate_=defaultEstimate,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new _ewma2.default(slow),this.fast_=new _ewma2.default(fast)}return _createClass(EwmaBandWidthEstimator,[{key:"sample",value:function(durationMs,numBytes){durationMs=Math.max(durationMs,this.minDelayMs_);var bandwidth=8e3*numBytes/durationMs,weight=durationMs/1e3;this.fast_.sample(weight,bandwidth),this.slow_.sample(weight,bandwidth)}},{key:"canEstimate",value:function(){var fast=this.fast_;return fast&&fast.getTotalWeight()>=this.minWeight_}},{key:"getEstimate",value:function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}},{key:"destroy",value:function(){}}]),EwmaBandWidthEstimator}();exports.default=EwmaBandWidthEstimator},{"../utils/ewma":44}],10:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_logger=require("../utils/logger"),FPSController=function(_EventHandler){function FPSController(hls){return _classCallCheck(this,FPSController),_possibleConstructorReturn(this,(FPSController.__proto__||Object.getPrototypeOf(FPSController)).call(this,hls,_events2.default.MEDIA_ATTACHING))}return _inherits(FPSController,_EventHandler),_createClass(FPSController,[{key:"destroy",value:function(){this.timer&&clearInterval(this.timer),this.isVideoPlaybackQualityAvailable=!1}},{key:"onMediaAttaching",value:function(data){var config=this.hls.config;if(config.capLevelOnFPSDrop){var video=this.video=data.media instanceof HTMLVideoElement?data.media:null;"function"==typeof video.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),clearInterval(this.timer),this.timer=setInterval(this.checkFPSInterval.bind(this),config.fpsDroppedMonitoringPeriod)}}},{key:"checkFPS",value:function(video,decodedFrames,droppedFrames){var currentTime=performance.now();if(decodedFrames){if(this.lastTime){var currentPeriod=currentTime-this.lastTime,currentDropped=droppedFrames-this.lastDroppedFrames,currentDecoded=decodedFrames-this.lastDecodedFrames,droppedFPS=1e3*currentDropped/currentPeriod,hls=this.hls;if(hls.trigger(_events2.default.FPS_DROP,{currentDropped:currentDropped,currentDecoded:currentDecoded,totalDroppedFrames:droppedFrames}),droppedFPS>0&&currentDropped>hls.config.fpsDroppedMonitoringThreshold*currentDecoded){var currentLevel=hls.currentLevel;_logger.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+currentLevel),currentLevel>0&&(hls.autoLevelCapping===-1||hls.autoLevelCapping>=currentLevel)&&(currentLevel-=1,hls.trigger(_events2.default.FPS_DROP_LEVEL_CAPPING,{level:currentLevel,droppedLevel:hls.currentLevel}),hls.autoLevelCapping=currentLevel,hls.streamController.nextLevelSwitch())}}this.lastTime=currentTime,this.lastDroppedFrames=droppedFrames,this.lastDecodedFrames=decodedFrames}}},{key:"checkFPSInterval",value:function(){var video=this.video;if(video)if(this.isVideoPlaybackQualityAvailable){var videoPlaybackQuality=video.getVideoPlaybackQuality();this.checkFPS(video,videoPlaybackQuality.totalVideoFrames,videoPlaybackQuality.droppedVideoFrames)}else this.checkFPS(video,video.webkitDecodedFrameCount,video.webkitDroppedFrameCount)}}]),FPSController}(_eventHandler2.default);exports.default=FPSController},{"../event-handler":27,"../events":28,"../utils/logger":45}],11:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_logger=require("../utils/logger"),_errors=require("../errors"),_bufferHelper=require("../helper/buffer-helper"),_bufferHelper2=_interopRequireDefault(_bufferHelper),LevelController=function(_EventHandler){function LevelController(hls){_classCallCheck(this,LevelController);var _this=_possibleConstructorReturn(this,(LevelController.__proto__||Object.getPrototypeOf(LevelController)).call(this,hls,_events2.default.MANIFEST_LOADED,_events2.default.LEVEL_LOADED,_events2.default.FRAG_LOADED,_events2.default.ERROR));return _this.ontick=_this.tick.bind(_this),_this._manualLevel=_this._autoLevelCapping=-1,_this}return _inherits(LevelController,_EventHandler),_createClass(LevelController,[{key:"destroy",value:function(){this.timer&&(clearTimeout(this.timer),this.timer=null),this._manualLevel=-1}},{key:"startLoad",value:function(){this.canload=!0;var levels=this._levels;levels&&levels.forEach(function(level){level.loadError=0;var levelDetails=level.details;levelDetails&&levelDetails.live&&(level.details=void 0)}),this.timer&&this.tick()}},{key:"stopLoad",value:function(){this.canload=!1}},{key:"onManifestLoaded",value:function(data){var bitrateStart,levels0=[],levels=[],bitrateSet={},videoCodecFound=!1,audioCodecFound=!1,hls=this.hls,brokenmp4inmp3=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),checkSupported=function(type,codec){return MediaSource.isTypeSupported(type+"/mp4;codecs="+codec)};if(data.levels.forEach(function(level){level.videoCodec&&(videoCodecFound=!0),brokenmp4inmp3&&level.audioCodec&&level.audioCodec.indexOf("mp4a.40.34")!==-1&&(level.audioCodec=void 0),(level.audioCodec||level.attrs&&level.attrs.AUDIO)&&(audioCodecFound=!0);var redundantLevelId=bitrateSet[level.bitrate];void 0===redundantLevelId?(bitrateSet[level.bitrate]=levels0.length,level.url=[level.url],level.urlId=0,levels0.push(level)):levels0[redundantLevelId].url.push(level.url)}),videoCodecFound&&audioCodecFound?levels0.forEach(function(level){level.videoCodec&&levels.push(level)}):levels=levels0,levels=levels.filter(function(level){var audioCodec=level.audioCodec,videoCodec=level.videoCodec;return(!audioCodec||checkSupported("audio",audioCodec))&&(!videoCodec||checkSupported("video",videoCodec))}),levels.length){bitrateStart=levels[0].bitrate,levels.sort(function(a,b){return a.bitrate-b.bitrate}),this._levels=levels;for(var i=0;i<levels.length;i++)if(levels[i].bitrate===bitrateStart){this._firstLevel=i,_logger.logger.log("manifest loaded,"+levels.length+" level(s) found, first bitrate:"+bitrateStart);break}hls.trigger(_events2.default.MANIFEST_PARSED,{levels:levels,firstLevel:this._firstLevel,stats:data.stats,audio:audioCodecFound,video:videoCodecFound,altAudio:data.audioTracks.length>0})}else hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:hls.url,reason:"no level with compatible codecs found in manifest"})}},{key:"setLevelInternal",value:function(newLevel){var levels=this._levels;if(newLevel>=0&&newLevel<levels.length){this.timer&&(clearTimeout(this.timer),this.timer=null),this._level!==newLevel&&(_logger.logger.log("switching to level "+newLevel),this._level=newLevel,this.hls.trigger(_events2.default.LEVEL_SWITCH,{level:newLevel}));var level=levels[newLevel],levelDetails=level.details;if(!levelDetails||levelDetails.live===!0){var urlId=level.urlId;this.hls.trigger(_events2.default.LEVEL_LOADING,{url:level.url[urlId],level:newLevel,id:urlId})}}else this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.OTHER_ERROR,details:_errors.ErrorDetails.LEVEL_SWITCH_ERROR,level:newLevel,fatal:!1,reason:"invalid level idx"})}},{key:"onError",value:function(data){if(!data.fatal){var details=data.details,hls=this.hls,levelId=void 0,level=void 0,levelError=!1,abrController=hls.abrController,minAutoLevel=abrController.minAutoLevel;switch(details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:case _errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR:case _errors.ErrorDetails.KEY_LOAD_ERROR:case _errors.ErrorDetails.KEY_LOAD_TIMEOUT:levelId=data.frag.level;break;case _errors.ErrorDetails.LEVEL_LOAD_ERROR:case _errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:levelId=data.context.level,levelError=!0;break;case _errors.ErrorDetails.REMUX_ALLOC_ERROR:levelId=data.level}if(void 0!==levelId){level=this._levels[levelId],level.loadError?level.loadError++:level.loadError=1;var nbRedundantLevel=level.url.length;if(nbRedundantLevel>1&&level.loadError<nbRedundantLevel)level.urlId=(level.urlId+1)%nbRedundantLevel,level.details=void 0,_logger.logger.warn("level controller,"+details+" for level "+levelId+": switching to redundant stream id "+level.urlId);else{var recoverable=this._manualLevel===-1&&levelId;if(recoverable)_logger.logger.warn("level controller,"+details+": switch-down for next fragment"),abrController.nextAutoLevel=Math.max(minAutoLevel,levelId-1);else if(level&&level.details&&level.details.live)_logger.logger.warn("level controller,"+details+" on live stream, discard"),levelError&&(this._level=void 0);else if(details===_errors.ErrorDetails.LEVEL_LOAD_ERROR||details===_errors.ErrorDetails.LEVEL_LOAD_TIMEOUT){var media=hls.media,mediaBuffered=media&&_bufferHelper2.default.isBuffered(media,media.currentTime)&&_bufferHelper2.default.isBuffered(media,media.currentTime+.5);if(mediaBuffered){var retryDelay=hls.config.levelLoadingRetryDelay;_logger.logger.warn("level controller,"+details+", but media buffered, retry in "+retryDelay+"ms"),this.timer=setTimeout(this.ontick,retryDelay)}else _logger.logger.error("cannot recover "+details+" error"),this._level=void 0,this.timer&&(clearTimeout(this.timer),this.timer=null),data.fatal=!0,hls.trigger(_events2.default.ERROR,data)}}}}}},{key:"onFragLoaded",value:function(data){var fragLoaded=data.frag;if(fragLoaded&&"main"===fragLoaded.type){var level=this._levels[fragLoaded.level];level&&(level.loadError=0)}}},{key:"onLevelLoaded",value:function(data){var levelId=data.level;if(levelId===this._level){var curLevel=this._levels[levelId];curLevel.loadError=0;var newDetails=data.details;if(newDetails.live){var reloadInterval=1e3*(newDetails.averagetargetduration?newDetails.averagetargetduration:newDetails.targetduration),curDetails=curLevel.details;curDetails&&newDetails.endSN===curDetails.endSN&&(reloadInterval/=2,_logger.logger.log("same live playlist, reload twice faster")),reloadInterval-=performance.now()-data.stats.trequest,reloadInterval=Math.max(1e3,Math.round(reloadInterval)),_logger.logger.log("live playlist, reload in "+reloadInterval+" ms"),this.timer=setTimeout(this.ontick,reloadInterval)}else this.timer=null}}},{key:"tick",value:function(){var levelId=this._level;if(void 0!==levelId&&this.canload){var level=this._levels[levelId],urlId=level.urlId;this.hls.trigger(_events2.default.LEVEL_LOADING,{url:level.url[urlId],level:levelId,id:urlId})}}},{key:"levels",get:function(){return this._levels}},{key:"level",get:function(){return this._level},set:function(newLevel){var levels=this._levels;levels&&levels.length>newLevel&&(this._level===newLevel&&void 0!==levels[newLevel].details||this.setLevelInternal(newLevel))}},{key:"manualLevel",get:function(){return this._manualLevel},set:function(newLevel){this._manualLevel=newLevel,void 0===this._startLevel&&(this._startLevel=newLevel),newLevel!==-1&&(this.level=newLevel)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(newLevel){this._firstLevel=newLevel}},{key:"startLevel",get:function(){if(void 0===this._startLevel){var configStartLevel=this.hls.config.startLevel;return void 0!==configStartLevel?configStartLevel:this._firstLevel}return this._startLevel},set:function(newLevel){newLevel!==-1&&(newLevel=Math.max(newLevel,this.hls.abrController.minAutoLevel)),this._startLevel=newLevel}},{key:"nextLoadLevel",get:function(){return this._manualLevel!==-1?this._manualLevel:this.hls.abrController.nextAutoLevel},set:function(nextLevel){this.level=nextLevel,this._manualLevel===-1&&(this.hls.abrController.nextAutoLevel=nextLevel)}}]),LevelController}(_eventHandler2.default);exports.default=LevelController},{"../errors":26,"../event-handler":27,"../events":28,"../helper/buffer-helper":30,"../utils/logger":45}],12:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_binarySearch=require("../utils/binary-search"),_binarySearch2=_interopRequireDefault(_binarySearch),_bufferHelper=require("../helper/buffer-helper"),_bufferHelper2=_interopRequireDefault(_bufferHelper),_demuxer=require("../demux/demuxer"),_demuxer2=_interopRequireDefault(_demuxer),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_levelHelper=require("../helper/level-helper"),_levelHelper2=_interopRequireDefault(_levelHelper),_timeRanges=require("../utils/timeRanges"),_timeRanges2=_interopRequireDefault(_timeRanges),_errors=require("../errors"),_logger=require("../utils/logger"),State={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_LEVEL:"WAITING_LEVEL",PARSING:"PARSING",PARSED:"PARSED",BUFFER_FLUSHING:"BUFFER_FLUSHING",ENDED:"ENDED",ERROR:"ERROR"},StreamController=function(_EventHandler){function StreamController(hls){_classCallCheck(this,StreamController);var _this=_possibleConstructorReturn(this,(StreamController.__proto__||Object.getPrototypeOf(StreamController)).call(this,hls,_events2.default.MEDIA_ATTACHED,_events2.default.MEDIA_DETACHING,_events2.default.MANIFEST_LOADING,_events2.default.MANIFEST_PARSED,_events2.default.LEVEL_LOADED,_events2.default.KEY_LOADED,_events2.default.FRAG_LOADED,_events2.default.FRAG_LOAD_EMERGENCY_ABORTED,_events2.default.FRAG_PARSING_INIT_SEGMENT,_events2.default.FRAG_PARSING_DATA,_events2.default.FRAG_PARSED,_events2.default.ERROR,_events2.default.AUDIO_TRACK_SWITCHING,_events2.default.AUDIO_TRACK_SWITCHED,_events2.default.BUFFER_CREATED,_events2.default.BUFFER_APPENDED,_events2.default.BUFFER_FLUSHED));return _this.config=hls.config,_this.audioCodecSwap=!1,_this.ticks=0,_this._state=State.STOPPED,_this.ontick=_this.tick.bind(_this),_this}return _inherits(StreamController,_EventHandler),_createClass(StreamController,[{key:"destroy",value:function(){this.stopLoad(),this.timer&&(clearInterval(this.timer),this.timer=null),_eventHandler2.default.prototype.destroy.call(this),this.state=State.STOPPED}},{key:"startLoad",value:function(startPosition){if(this.levels){var lastCurrentTime=this.lastCurrentTime,hls=this.hls;if(this.stopLoad(),this.timer||(this.timer=setInterval(this.ontick,100)),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var startLevel=hls.startLevel;startLevel===-1&&(startLevel=0,this.bitrateTest=!0),this.level=hls.nextLoadLevel=startLevel,this.loadedmetadata=!1}lastCurrentTime>0&&startPosition===-1&&(_logger.logger.log("override startPosition with lastCurrentTime @"+lastCurrentTime.toFixed(3)),startPosition=lastCurrentTime),this.state=State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition,this.tick()}else _logger.logger.warn("cannot start loading as manifest not parsed yet"),this.state=State.STOPPED}},{key:"stopLoad",value:function(){var frag=this.fragCurrent;frag&&(frag.loader&&frag.loader.abort(),this.fragCurrent=null),this.fragPrevious=null,this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),this.state=State.STOPPED}},{key:"tick",value:function(){this.ticks++,1===this.ticks&&(this.doTick(),this.ticks>1&&setTimeout(this.tick,1),this.ticks=0)}},{key:"doTick",value:function(){switch(this.state){case State.ERROR:break;case State.BUFFER_FLUSHING:this.fragLoadError=0;break;case State.IDLE:if(!this._doTickIdle())return;break;case State.WAITING_LEVEL:var level=this.levels[this.level];level&&level.details&&(this.state=State.IDLE);break;case State.FRAG_LOADING_WAITING_RETRY:var now=performance.now(),retryDate=this.retryDate;(!retryDate||now>=retryDate||this.media&&this.media.seeking)&&(_logger.logger.log("mediaController: retryDate reached, switch back to IDLE state"),this.state=State.IDLE);break;case State.ERROR:case State.STOPPED:case State.FRAG_LOADING:case State.PARSING:case State.PARSED:case State.ENDED:}this._checkBuffer(),this._checkFragmentChanged()}},{key:"_doTickIdle",value:function(){var hls=this.hls,config=hls.config,media=this.media;if(void 0!==this.levelLastLoaded&&!media&&(this.startFragRequested||!config.startFragPrefetch))return!0;var pos=void 0;pos=this.loadedmetadata?media.currentTime:this.nextLoadPosition;var level=hls.nextLoadLevel,levelInfo=this.levels[level],levelBitrate=levelInfo.bitrate,maxBufLen=void 0;maxBufLen=levelBitrate?Math.max(8*config.maxBufferSize/levelBitrate,config.maxBufferLength):config.maxBufferLength,maxBufLen=Math.min(maxBufLen,config.maxMaxBufferLength);var bufferInfo=_bufferHelper2.default.bufferInfo(this.mediaBuffer?this.mediaBuffer:media,pos,config.maxBufferHole),bufferLen=bufferInfo.len;if(bufferLen>=maxBufLen)return!0;_logger.logger.trace("buffer length of "+bufferLen.toFixed(3)+" is below max of "+maxBufLen.toFixed(3)+". checking for more payload ..."),this.level=hls.nextLoadLevel=level;var levelDetails=levelInfo.details;if("undefined"==typeof levelDetails||levelDetails.live&&this.levelLastLoaded!==level)return this.state=State.WAITING_LEVEL,!0;var fragPrevious=this.fragPrevious;if(!levelDetails.live&&fragPrevious&&fragPrevious.sn===levelDetails.endSN&&media.duration-Math.max(bufferInfo.end,fragPrevious.start)<=Math.max(.2,fragPrevious.duration/2)){var data={};return this.altAudio&&(data.type="video"),this.hls.trigger(_events2.default.BUFFER_EOS,data),this.state=State.ENDED,!0}return this._fetchPayloadOrEos(pos,bufferInfo,levelDetails)}},{key:"_fetchPayloadOrEos",value:function(pos,bufferInfo,levelDetails){var fragPrevious=this.fragPrevious,level=this.level,fragments=levelDetails.fragments,fragLen=fragments.length;if(0===fragLen)return!1;var start=fragments[0].start,end=fragments[fragLen-1].start+fragments[fragLen-1].duration,bufferEnd=bufferInfo.end,frag=void 0;if(levelDetails.live){var initialLiveManifestSize=this.config.initialLiveManifestSize;if(fragLen<initialLiveManifestSize)return _logger.logger.warn("Can not start playback of a level, reason: not enough fragments "+fragLen+" < "+initialLiveManifestSize),!1;if(frag=this._ensureFragmentAtLivePoint(levelDetails,bufferEnd,start,end,fragPrevious,fragments,fragLen),null===frag)return!1}else bufferEnd<start&&(frag=fragments[0]);return frag||(frag=this._findFragment(start,fragPrevious,fragLen,fragments,bufferEnd,end,levelDetails)),!frag||this._loadFragmentOrKey(frag,level,levelDetails,pos,bufferEnd)}},{key:"_ensureFragmentAtLivePoint",value:function(levelDetails,bufferEnd,start,end,fragPrevious,fragments,fragLen){var config=this.hls.config,media=this.media,frag=void 0,maxLatency=void 0!==config.liveMaxLatencyDuration?config.liveMaxLatencyDuration:config.liveMaxLatencyDurationCount*levelDetails.targetduration;if(bufferEnd<Math.max(start-config.maxFragLookUpTolerance,end-maxLatency)){var liveSyncPosition=this.liveSyncPosition=this.computeLivePosition(start,levelDetails);_logger.logger.log("buffer end: "+bufferEnd.toFixed(3)+" is located too far from the end of live sliding playlist, reset currentTime to : "+liveSyncPosition.toFixed(3)),bufferEnd=liveSyncPosition,media&&media.readyState&&media.duration>liveSyncPosition&&(media.currentTime=liveSyncPosition)}if(levelDetails.PTSKnown&&bufferEnd>end&&media&&media.readyState)return null;if(this.startFragRequested&&!levelDetails.PTSKnown){if(fragPrevious){var targetSN=fragPrevious.sn+1;targetSN>=levelDetails.startSN&&targetSN<=levelDetails.endSN&&(frag=fragments[targetSN-levelDetails.startSN],_logger.logger.log("live playlist, switching playlist, load frag with next SN: "+frag.sn))}frag||(frag=fragments[Math.min(fragLen-1,Math.round(fragLen/2))],_logger.logger.log("live playlist, switching playlist, unknown, load middle frag : "+frag.sn))}return frag}},{key:"_findFragment",value:function(start,fragPrevious,fragLen,fragments,bufferEnd,end,levelDetails){var config=this.hls.config,frag=void 0,foundFrag=void 0,maxFragLookUpTolerance=config.maxFragLookUpTolerance;if(bufferEnd<end?(bufferEnd>end-maxFragLookUpTolerance&&(maxFragLookUpTolerance=0),foundFrag=_binarySearch2.default.search(fragments,function(candidate){return candidate.start+candidate.duration-maxFragLookUpTolerance<=bufferEnd?1:candidate.start-maxFragLookUpTolerance>bufferEnd&&candidate.start?-1:0})):foundFrag=fragments[fragLen-1],foundFrag&&(frag=foundFrag,start=foundFrag.start,fragPrevious&&frag.level===fragPrevious.level&&frag.sn===fragPrevious.sn))if(frag.sn<levelDetails.endSN){var deltaPTS=fragPrevious.deltaPTS,curSNIdx=frag.sn-levelDetails.startSN;deltaPTS&&deltaPTS>config.maxBufferHole&&fragPrevious.dropped&&curSNIdx?(frag=fragments[curSNIdx-1],_logger.logger.warn("SN just loaded, with large PTS gap between audio and video, maybe frag is not starting with a keyframe ? load previous one to try to overcome this"),fragPrevious.loadCounter--):(frag=fragments[curSNIdx+1],_logger.logger.log("SN just loaded, load next one: "+frag.sn))}else frag=null;return frag}},{key:"_loadFragmentOrKey",value:function(frag,level,levelDetails,pos,bufferEnd){var hls=this.hls,config=hls.config;if(null==frag.decryptdata.uri||null!=frag.decryptdata.key){if(_logger.logger.log("Loading "+frag.sn+" of ["+levelDetails.startSN+" ,"+levelDetails.endSN+"],level "+level+", currentTime:"+pos.toFixed(3)+",bufferEnd:"+bufferEnd.toFixed(3)),void 0!==this.fragLoadIdx?this.fragLoadIdx++:this.fragLoadIdx=0,frag.loadCounter){frag.loadCounter++;var maxThreshold=config.fragLoadingLoopThreshold;if(frag.loadCounter>maxThreshold&&Math.abs(this.fragLoadIdx-frag.loadIdx)<maxThreshold)return hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR,fatal:!1,frag:frag}),!1}else frag.loadCounter=1;return frag.loadIdx=this.fragLoadIdx,this.fragCurrent=frag,this.startFragRequested=!0,this.nextLoadPosition=frag.start+frag.duration,frag.autoLevel=hls.autoLevelEnabled,frag.bitrateTest=this.bitrateTest,hls.trigger(_events2.default.FRAG_LOADING,{frag:frag}),this.demuxer||(this.demuxer=new _demuxer2.default(hls,"main")),this.state=State.FRAG_LOADING,!0}_logger.logger.log("Loading key for "+frag.sn+" of ["+levelDetails.startSN+" ,"+levelDetails.endSN+"],level "+level),this.state=State.KEY_LOADING,hls.trigger(_events2.default.KEY_LOADING,{frag:frag})}},{key:"getBufferRange",value:function(position){return _binarySearch2.default.search(this.bufferRange,function(range){return position<range.start?-1:position>range.end?1:0})}},{key:"followingBufferRange",value:function(range){return range?this.getBufferRange(range.end+.5):null}},{key:"_checkFragmentChanged",value:function(){var rangeCurrent,currentTime,video=this.media;if(video&&video.readyState&&video.seeking===!1&&(currentTime=video.currentTime,currentTime>video.playbackRate*this.lastCurrentTime&&(this.lastCurrentTime=currentTime),_bufferHelper2.default.isBuffered(video,currentTime)?rangeCurrent=this.getBufferRange(currentTime):_bufferHelper2.default.isBuffered(video,currentTime+.1)&&(rangeCurrent=this.getBufferRange(currentTime+.1)),rangeCurrent)){var fragPlaying=rangeCurrent.frag;fragPlaying!==this.fragPlaying&&(this.fragPlaying=fragPlaying,this.hls.trigger(_events2.default.FRAG_CHANGED,{frag:fragPlaying}))}}},{key:"immediateLevelSwitch",value:function(){if(_logger.logger.log("immediateLevelSwitch"),!this.immediateSwitch){this.immediateSwitch=!0;var media=this.media,previouslyPaused=void 0;media?(previouslyPaused=media.paused,media.pause()):previouslyPaused=!0,this.previouslyPaused=previouslyPaused}var fragCurrent=this.fragCurrent;fragCurrent&&fragCurrent.loader&&fragCurrent.loader.abort(),this.fragCurrent=null,this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}},{key:"immediateLevelSwitchEnd",value:function(){var media=this.media;media&&media.buffered.length&&(this.immediateSwitch=!1,_bufferHelper2.default.isBuffered(media,media.currentTime)&&(media.currentTime-=1e-4),this.previouslyPaused||media.play())}},{key:"nextLevelSwitch",value:function(){var media=this.media;if(media&&media.readyState){var fetchdelay=void 0,currentRange=void 0,nextRange=void 0;if(this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,currentRange=this.getBufferRange(media.currentTime),currentRange&&currentRange.start>1&&this.flushMainBuffer(0,currentRange.start-1),media.paused)fetchdelay=0;else{var nextLevelId=this.hls.nextLoadLevel,nextLevel=this.levels[nextLevelId],fragLastKbps=this.fragLastKbps;fetchdelay=fragLastKbps&&this.fragCurrent?this.fragCurrent.duration*nextLevel.bitrate/(1e3*fragLastKbps)+1:0}if(nextRange=this.getBufferRange(media.currentTime+fetchdelay),nextRange&&(nextRange=this.followingBufferRange(nextRange))){var fragCurrent=this.fragCurrent;fragCurrent&&fragCurrent.loader&&fragCurrent.loader.abort(),this.fragCurrent=null,this.flushMainBuffer(nextRange.start,Number.POSITIVE_INFINITY)}}}},{key:"flushMainBuffer",value:function(startOffset,endOffset){this.state=State.BUFFER_FLUSHING;var flushScope={startOffset:startOffset,endOffset:endOffset};this.altAudio&&(flushScope.type="video"),this.hls.trigger(_events2.default.BUFFER_FLUSHING,flushScope)}},{key:"onMediaAttached",value:function(data){var media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),this.onvended=this.onMediaEnded.bind(this),media.addEventListener("seeking",this.onvseeking),media.addEventListener("seeked",this.onvseeked),media.addEventListener("ended",this.onvended);var config=this.config;this.levels&&config.autoStartLoad&&this.hls.startLoad(config.startPosition)}},{key:"onMediaDetaching",value:function(){var media=this.media;media&&media.ended&&(_logger.logger.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0);var levels=this.levels;levels&&levels.forEach(function(level){level.details&&level.details.fragments.forEach(function(fragment){fragment.loadCounter=void 0})}),media&&(media.removeEventListener("seeking",this.onvseeking),media.removeEventListener("seeked",this.onvseeked),media.removeEventListener("ended",this.onvended),this.onvseeking=this.onvseeked=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.stopLoad()}},{key:"onMediaSeeking",value:function(){var media=this.media,currentTime=media?media.currentTime:void 0,config=this.config;if(_logger.logger.log("media seeking to "+currentTime.toFixed(3)),this.state===State.FRAG_LOADING){var mediaBuffer=this.mediaBuffer?this.mediaBuffer:media,bufferInfo=_bufferHelper2.default.bufferInfo(mediaBuffer,currentTime,this.config.maxBufferHole),fragCurrent=this.fragCurrent;if(0===bufferInfo.len&&fragCurrent){var tolerance=config.maxFragLookUpTolerance,fragStartOffset=fragCurrent.start-tolerance,fragEndOffset=fragCurrent.start+fragCurrent.duration+tolerance;currentTime<fragStartOffset||currentTime>fragEndOffset?(fragCurrent.loader&&(_logger.logger.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),fragCurrent.loader.abort()),this.fragCurrent=null,this.fragPrevious=null,this.state=State.IDLE):_logger.logger.log("seeking outside of buffer but within currently loaded fragment range")}}else this.state===State.ENDED&&(this.state=State.IDLE);media&&(this.lastCurrentTime=currentTime),this.state!==State.FRAG_LOADING&&void 0!==this.fragLoadIdx&&(this.fragLoadIdx+=2*config.fragLoadingLoopThreshold),this.loadedmetadata||(this.nextLoadPosition=this.startPosition=currentTime),this.tick()}},{key:"onMediaSeeked",value:function(){_logger.logger.log("media seeked to "+this.media.currentTime.toFixed(3)),this.tick()}},{key:"onMediaEnded",value:function(){_logger.logger.log("media ended"),this.startPosition=this.lastCurrentTime=0;
}},{key:"onManifestLoading",value:function(){_logger.logger.log("trigger BUFFER_RESET"),this.hls.trigger(_events2.default.BUFFER_RESET),this.bufferRange=[],this.stalled=!1,this.startPosition=this.lastCurrentTime=0}},{key:"onManifestParsed",value:function(data){var codec,aac=!1,heaac=!1;data.levels.forEach(function(level){codec=level.audioCodec,codec&&(codec.indexOf("mp4a.40.2")!==-1&&(aac=!0),codec.indexOf("mp4a.40.5")!==-1&&(heaac=!0))}),this.audioCodecSwitch=aac&&heaac,this.audioCodecSwitch&&_logger.logger.log("both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=data.levels,this.startLevelLoaded=!1,this.startFragRequested=!1;var config=this.config;config.autoStartLoad&&this.hls.startLoad(config.startPosition)}},{key:"onLevelLoaded",value:function(data){var newDetails=data.details,newLevelId=data.level,curLevel=this.levels[newLevelId],duration=newDetails.totalduration,sliding=0;if(_logger.logger.log("level "+newLevelId+" loaded ["+newDetails.startSN+","+newDetails.endSN+"],duration:"+duration),this.levelLastLoaded=newLevelId,newDetails.live){var curDetails=curLevel.details;curDetails&&newDetails.fragments.length>0?(_levelHelper2.default.mergeDetails(curDetails,newDetails),sliding=newDetails.fragments[0].start,this.liveSyncPosition=this.computeLivePosition(sliding,curDetails),newDetails.PTSKnown?_logger.logger.log("live playlist sliding:"+sliding.toFixed(3)):_logger.logger.log("live playlist - outdated PTS, unknown sliding")):(newDetails.PTSKnown=!1,_logger.logger.log("live playlist - first load, unknown sliding"))}else newDetails.PTSKnown=!1;if(curLevel.details=newDetails,this.hls.trigger(_events2.default.LEVEL_UPDATED,{details:newDetails,level:newLevelId}),this.startFragRequested===!1){if(this.startPosition===-1||this.lastCurrentTime===-1){var startTimeOffset=newDetails.startTimeOffset;isNaN(startTimeOffset)?newDetails.live?(this.startPosition=this.computeLivePosition(sliding,newDetails),_logger.logger.log("configure startPosition to "+this.startPosition)):this.startPosition=0:(startTimeOffset<0&&(_logger.logger.log("negative start time offset "+startTimeOffset+", count from end of last fragment"),startTimeOffset=sliding+duration+startTimeOffset),_logger.logger.log("start time offset found in playlist, adjust startPosition to "+startTimeOffset),this.startPosition=startTimeOffset),this.lastCurrentTime=this.startPosition}this.nextLoadPosition=this.startPosition}this.state===State.WAITING_LEVEL&&(this.state=State.IDLE),this.tick()}},{key:"onKeyLoaded",value:function(){this.state===State.KEY_LOADING&&(this.state=State.IDLE,this.tick())}},{key:"onFragLoaded",value:function(data){var fragCurrent=this.fragCurrent,fragLoaded=data.frag;if(this.state===State.FRAG_LOADING&&fragCurrent&&"main"===fragLoaded.type&&fragLoaded.level===fragCurrent.level&&fragLoaded.sn===fragCurrent.sn){var stats=data.stats,currentLevel=this.levels[fragCurrent.level],details=currentLevel.details;if(_logger.logger.log("Loaded  "+fragCurrent.sn+" of ["+details.startSN+" ,"+details.endSN+"],level "+fragCurrent.level),this.bitrateTest=!1,fragLoaded.bitrateTest===!0&&this.hls.nextLoadLevel)this.state=State.IDLE,this.startFragRequested=!1,stats.tparsed=stats.tbuffered=performance.now(),this.hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:fragCurrent,id:"main"}),this.tick();else{this.state=State.PARSING,this.stats=stats;var duration=details.totalduration,start=isNaN(fragCurrent.startDTS)?fragCurrent.start:fragCurrent.startDTS,level=fragCurrent.level,sn=fragCurrent.sn,audioCodec=this.config.defaultAudioCodec||currentLevel.audioCodec;this.audioCodecSwap&&(_logger.logger.log("swapping playlist audio codec"),void 0===audioCodec&&(audioCodec=this.lastAudioCodec),audioCodec&&(audioCodec=audioCodec.indexOf("mp4a.40.5")!==-1?"mp4a.40.2":"mp4a.40.5")),this.pendingBuffering=!0,this.appended=!1,_logger.logger.log("Parsing "+sn+" of ["+details.startSN+" ,"+details.endSN+"],level "+level+", cc "+fragCurrent.cc);var demuxer=this.demuxer;demuxer||(demuxer=this.demuxer=new _demuxer2.default(this.hls,"main"));var media=this.media,mediaSeeking=media&&media.seeking,accurateTimeOffset=!mediaSeeking&&(details.PTSKnown||!details.live);demuxer.push(data.payload,audioCodec,currentLevel.videoCodec,start,fragCurrent.cc,level,sn,duration,fragCurrent.decryptdata,accurateTimeOffset,null)}}this.fragLoadError=0}},{key:"onFragParsingInitSegment",value:function(data){var fragCurrent=this.fragCurrent;if(fragCurrent&&"main"===data.id&&data.sn===fragCurrent.sn&&data.level===fragCurrent.level&&this.state===State.PARSING){var trackName,track,tracks=data.tracks;if(tracks.audio&&this.altAudio&&delete tracks.audio,track=tracks.audio){var audioCodec=this.levels[this.level].audioCodec,ua=navigator.userAgent.toLowerCase();audioCodec&&this.audioCodecSwap&&(_logger.logger.log("swapping playlist audio codec"),audioCodec=audioCodec.indexOf("mp4a.40.5")!==-1?"mp4a.40.2":"mp4a.40.5"),this.audioCodecSwitch&&1!==track.metadata.channelCount&&ua.indexOf("firefox")===-1&&(audioCodec="mp4a.40.5"),ua.indexOf("android")!==-1&&"audio/mpeg"!==track.container&&(audioCodec="mp4a.40.2",_logger.logger.log("Android: force audio codec to "+audioCodec)),track.levelCodec=audioCodec,track.id=data.id}if(track=tracks.video,track&&(track.levelCodec=this.levels[this.level].videoCodec,track.id=data.id),data.unique){var mergedTrack={codec:"",levelCodec:""};for(trackName in data.tracks)track=tracks[trackName],mergedTrack.container=track.container,mergedTrack.codec&&(mergedTrack.codec+=",",mergedTrack.levelCodec+=","),track.codec&&(mergedTrack.codec+=track.codec),track.levelCodec&&(mergedTrack.levelCodec+=track.levelCodec);tracks={audiovideo:mergedTrack}}this.hls.trigger(_events2.default.BUFFER_CODECS,tracks);for(trackName in tracks){track=tracks[trackName],_logger.logger.log("main track:"+trackName+",container:"+track.container+",codecs[level/parsed]=["+track.levelCodec+"/"+track.codec+"]");var initSegment=track.initSegment;initSegment&&(this.appended=!0,this.pendingBuffering=!0,this.hls.trigger(_events2.default.BUFFER_APPENDING,{type:trackName,data:initSegment,parent:"main",content:"initSegment"}))}this.tick()}}},{key:"onFragParsingData",value:function(data){var _this2=this,fragCurrent=this.fragCurrent;if(fragCurrent&&"main"===data.id&&data.sn===fragCurrent.sn&&data.level===fragCurrent.level&&("audio"!==data.type||!this.altAudio)&&this.state===State.PARSING){var level=this.levels[this.level],frag=this.fragCurrent;_logger.logger.log("Parsed "+data.type+",PTS:["+data.startPTS.toFixed(3)+","+data.endPTS.toFixed(3)+"],DTS:["+data.startDTS.toFixed(3)+"/"+data.endDTS.toFixed(3)+"],nb:"+data.nb+",dropped:"+(data.dropped||0));var drift=_levelHelper2.default.updateFragPTSDTS(level.details,frag.sn,data.startPTS,data.endPTS,data.startDTS,data.endDTS),hls=this.hls;hls.trigger(_events2.default.LEVEL_PTS_UPDATED,{details:level.details,level:this.level,drift:drift,type:data.type,start:data.startPTS,end:data.endPTS}),"video"===data.type&&(frag.dropped=data.dropped),[data.data1,data.data2].forEach(function(buffer){buffer&&(_this2.appended=!0,_this2.pendingBuffering=!0,hls.trigger(_events2.default.BUFFER_APPENDING,{type:data.type,data:buffer,parent:"main",content:"data"}))}),this.tick()}}},{key:"onFragParsed",value:function(data){var fragCurrent=this.fragCurrent;fragCurrent&&"main"===data.id&&data.sn===fragCurrent.sn&&data.level===fragCurrent.level&&this.state===State.PARSING&&(this.stats.tparsed=performance.now(),this.state=State.PARSED,this._checkAppendedParsed())}},{key:"onAudioTrackSwitching",value:function(data){var altAudio=!!data.url,trackId=data.id;if(!altAudio){if(this.mediaBuffer!==this.media){_logger.logger.log("switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var fragCurrent=this.fragCurrent;fragCurrent.loader&&(_logger.logger.log("switching to main audio track, cancel main fragment load"),fragCurrent.loader.abort()),this.fragCurrent=null,this.fragPrevious=null,this.demuxer&&(this.demuxer.destroy(),this.demuxer=null),this.state=State.IDLE}var hls=this.hls;hls.trigger(_events2.default.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),hls.trigger(_events2.default.AUDIO_TRACK_SWITCHED,{id:trackId}),this.altAudio=!1}}},{key:"onAudioTrackSwitched",value:function(data){var trackId=data.id,altAudio=!!this.hls.audioTracks[trackId].url;if(altAudio){var videoBuffer=this.videoBuffer;videoBuffer&&this.mediaBuffer!==videoBuffer&&(_logger.logger.log("switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=videoBuffer)}this.altAudio=altAudio,this.tick()}},{key:"onBufferCreated",value:function(data){var tracks=data.tracks,mediaTrack=void 0,name=void 0,alternate=!1;for(var type in tracks){var track=tracks[type];"main"===track.id?(name=type,mediaTrack=track,"video"===type&&(this.videoBuffer=tracks[type].buffer)):alternate=!0}alternate&&mediaTrack?(_logger.logger.log("alternate track found, use "+name+".buffered to schedule main fragment loading"),this.mediaBuffer=mediaTrack.buffer):this.mediaBuffer=this.media}},{key:"onBufferAppended",value:function(data){if("main"===data.parent){var state=this.state;state!==State.PARSING&&state!==State.PARSED||(this.pendingBuffering=data.pending>0,this._checkAppendedParsed())}}},{key:"_checkAppendedParsed",value:function(){var _this3=this;if(!(this.state!==State.PARSED||this.appended&&this.pendingBuffering)){var frag=this.fragCurrent;frag&&!function(){var media=_this3.mediaBuffer?_this3.mediaBuffer:_this3.media;_logger.logger.log("main buffered : "+_timeRanges2.default.toString(media.buffered));var bufferRange=_this3.bufferRange.filter(function(range){return _bufferHelper2.default.isBuffered(media,(range.start+range.end)/2)});bufferRange.push({type:frag.type,start:frag.startPTS,end:frag.endPTS,frag:frag}),_this3.bufferRange=bufferRange.sort(function(a,b){return a.start-b.start}),_this3.fragPrevious=frag;var stats=_this3.stats;stats.tbuffered=performance.now(),_this3.fragLastKbps=Math.round(8*stats.total/(stats.tbuffered-stats.tfirst)),_this3.hls.trigger(_events2.default.FRAG_BUFFERED,{stats:stats,frag:frag,id:"main"}),_this3.state=State.IDLE}(),this.tick()}}},{key:"onError",value:function(data){var frag=data.frag||this.fragCurrent;if(!frag||"main"===frag.type){var media=this.media,mediaBuffered=media&&_bufferHelper2.default.isBuffered(media,media.currentTime)&&_bufferHelper2.default.isBuffered(media,media.currentTime+.5);switch(data.details){case _errors.ErrorDetails.FRAG_LOAD_ERROR:case _errors.ErrorDetails.FRAG_LOAD_TIMEOUT:case _errors.ErrorDetails.KEY_LOAD_ERROR:case _errors.ErrorDetails.KEY_LOAD_TIMEOUT:if(!data.fatal){var loadError=this.fragLoadError;loadError?loadError++:loadError=1;var config=this.config;if(loadError<=config.fragLoadingMaxRetry||mediaBuffered||frag.autoLevel&&frag.level){this.fragLoadError=loadError,frag.loadCounter=0;var delay=Math.min(Math.pow(2,loadError-1)*config.fragLoadingRetryDelay,config.fragLoadingMaxRetryTimeout);_logger.logger.warn("mediaController: frag loading failed, retry in "+delay+" ms"),this.retryDate=performance.now()+delay,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.state=State.FRAG_LOADING_WAITING_RETRY}else _logger.logger.error("mediaController: "+data.details+" reaches max retry, redispatch as fatal ..."),data.fatal=!0,this.hls.trigger(_events2.default.ERROR,data),this.state=State.ERROR}break;case _errors.ErrorDetails.FRAG_LOOP_LOADING_ERROR:data.fatal||(mediaBuffered?(this._reduceMaxBufferLength(frag.duration),this.state=State.IDLE):frag.autoLevel&&0!==frag.level||(data.fatal=!0,this.hls.trigger(_events2.default.ERROR,data),this.state=State.ERROR));break;case _errors.ErrorDetails.LEVEL_LOAD_ERROR:case _errors.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==State.ERROR&&(data.fatal?(this.state=State.ERROR,_logger.logger.warn("streamController: "+data.details+",switch to "+this.state+" state ...")):this.state===State.WAITING_LEVEL&&(this.state=State.IDLE));break;case _errors.ErrorDetails.BUFFER_FULL_ERROR:this.state!==State.PARSING&&this.state!==State.PARSED||(mediaBuffered?(this._reduceMaxBufferLength(frag.duration),this.state=State.IDLE):(_logger.logger.warn("buffer full error also media.currentTime is not buffered, flush everything"),this.fragCurrent=null,this.flushMainBuffer(0,Number.POSITIVE_INFINITY)))}}}},{key:"_reduceMaxBufferLength",value:function(minLength){var config=this.config;config.maxMaxBufferLength>=minLength&&(config.maxMaxBufferLength/=2,_logger.logger.warn("reduce max buffer length to "+config.maxMaxBufferLength+"s and switch to IDLE state"),this.fragLoadIdx+=2*config.fragLoadingLoopThreshold)}},{key:"_checkBuffer",value:function(){var media=this.media;if(media&&media.readyState){var currentTime=media.currentTime,mediaBuffer=this.mediaBuffer?this.mediaBuffer:media,buffered=mediaBuffer.buffered;if(this.loadedmetadata||!buffered.length||media.seeking)if(this.immediateSwitch)this.immediateLevelSwitchEnd();else{var bufferInfo=_bufferHelper2.default.bufferInfo(media,currentTime,0),expectedPlaying=!(media.paused||media.ended||0===media.buffered.length),jumpThreshold=.5,playheadMoving=currentTime!==this.lastCurrentTime,config=this.config;if(playheadMoving)this.stallReported&&(_logger.logger.warn("playback not stuck anymore @"+currentTime+", after "+Math.round(performance.now()-this.stalled)+"ms"),this.stallReported=!1),this.stalled=void 0,this.nudgeRetry=0;else if(expectedPlaying){var tnow=performance.now(),hls=this.hls;if(this.stalled){var stalledDuration=tnow-this.stalled,bufferLen=bufferInfo.len,nudgeRetry=this.nudgeRetry||0;if(bufferLen<=jumpThreshold&&stalledDuration>1e3*config.lowBufferWatchdogPeriod){this.stallReported||(this.stallReported=!0,_logger.logger.warn("playback stalling in low buffer @"+currentTime),hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:bufferLen}));var nextBufferStart=bufferInfo.nextStart,delta=nextBufferStart-currentTime;if(nextBufferStart&&delta<config.maxSeekHole&&delta>0){this.nudgeRetry=++nudgeRetry;var nudgeOffset=nudgeRetry*config.nudgeOffset;_logger.logger.log("adjust currentTime from "+media.currentTime+" to next buffered @ "+nextBufferStart+" + nudge "+nudgeOffset),media.currentTime=nextBufferStart+nudgeOffset,this.stalled=void 0,hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,hole:nextBufferStart+nudgeOffset-currentTime})}}else if(bufferLen>jumpThreshold&&stalledDuration>1e3*config.highBufferWatchdogPeriod)if(this.stallReported||(this.stallReported=!0,_logger.logger.warn("playback stalling in high buffer @"+currentTime),hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:bufferLen})),this.stalled=void 0,this.nudgeRetry=++nudgeRetry,nudgeRetry<config.nudgeMaxRetry){var _currentTime=media.currentTime,targetTime=_currentTime+nudgeRetry*config.nudgeOffset;_logger.logger.log("adjust currentTime from "+_currentTime+" to "+targetTime),media.currentTime=targetTime,hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else _logger.logger.error("still stuck in high buffer @"+currentTime+" after "+config.nudgeMaxRetry+", raise fatal error"),hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}else this.stalled=tnow,this.stallReported=!1}}else{this.loadedmetadata=!0;var startPosition=this.startPosition,startPositionBuffered=_bufferHelper2.default.isBuffered(mediaBuffer,startPosition);currentTime===startPosition&&startPositionBuffered||(_logger.logger.log("target start position:"+startPosition),startPositionBuffered||(startPosition=buffered.start(0),_logger.logger.log("target start position not buffered, seek to buffered.start(0) "+startPosition)),_logger.logger.log("adjust currentTime from "+currentTime+" to "+startPosition),media.currentTime=startPosition)}}}},{key:"onFragLoadEmergencyAborted",value:function(){this.state=State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tick()}},{key:"onBufferFlushed",value:function(){var media=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferRange=this.bufferRange.filter(function(range){return _bufferHelper2.default.isBuffered(media,(range.start+range.end)/2)}),this.fragLoadIdx+=2*this.config.fragLoadingLoopThreshold,this.state=State.IDLE,this.fragPrevious=null}},{key:"swapAudioCodec",value:function(){this.audioCodecSwap=!this.audioCodecSwap}},{key:"computeLivePosition",value:function(sliding,levelDetails){var targetLatency=void 0!==this.config.liveSyncDuration?this.config.liveSyncDuration:this.config.liveSyncDurationCount*levelDetails.targetduration;return sliding+Math.max(0,levelDetails.totalduration-targetLatency)}},{key:"state",set:function(nextState){if(this.state!==nextState){var previousState=this.state;this._state=nextState,_logger.logger.log("main stream:"+previousState+"->"+nextState),this.hls.trigger(_events2.default.STREAM_STATE_TRANSITION,{previousState:previousState,nextState:nextState})}},get:function(){return this._state}},{key:"currentLevel",get:function(){var media=this.media;if(media){var range=this.getBufferRange(media.currentTime);if(range)return range.frag.level}return-1}},{key:"nextBufferRange",get:function(){var media=this.media;return media?this.followingBufferRange(this.getBufferRange(media.currentTime)):null}},{key:"nextLevel",get:function(){var range=this.nextBufferRange;return range?range.frag.level:-1}},{key:"liveSyncPosition",get:function(){return this._liveSyncPosition},set:function(value){this._liveSyncPosition=value}}]),StreamController}(_eventHandler2.default);exports.default=StreamController},{"../demux/demuxer":22,"../errors":26,"../event-handler":27,"../events":28,"../helper/buffer-helper":30,"../helper/level-helper":31,"../utils/binary-search":41,"../utils/logger":45,"../utils/timeRanges":46}],13:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_cea608Parser=require("../utils/cea-608-parser"),_cea608Parser2=_interopRequireDefault(_cea608Parser),TimelineController=function(_EventHandler){function TimelineController(hls){_classCallCheck(this,TimelineController);var _this=_possibleConstructorReturn(this,(TimelineController.__proto__||Object.getPrototypeOf(TimelineController)).call(this,hls,_events2.default.MEDIA_ATTACHING,_events2.default.MEDIA_DETACHING,_events2.default.FRAG_PARSING_USERDATA,_events2.default.MANIFEST_LOADING,_events2.default.FRAG_LOADED,_events2.default.LEVEL_SWITCH));if(_this.hls=hls,_this.config=hls.config,_this.enabled=!0,_this.Cues=hls.config.cueHandler,_this.config.enableCEA708Captions){var self=_this,sendAddTrackEvent=function(track,media){var e=null;try{e=new window.Event("addtrack")}catch(err){e=document.createEvent("Event"),e.initEvent("addtrack",!1,!1)}e.track=track,media.dispatchEvent(e)},channel1={newCue:function(startTime,endTime,screen){if(!self.textTrack1){var existingTrack1=self.getExistingTrack("1");existingTrack1?(self.textTrack1=existingTrack1,self.clearCurrentCues(self.textTrack1),sendAddTrackEvent(self.textTrack1,self.media)):(self.textTrack1=self.createTextTrack("captions","English","en"),self.textTrack1.textTrack1=!0)}self.Cues.newCue(self.textTrack1,startTime,endTime,screen)}},channel2={newCue:function(startTime,endTime,screen){if(!self.textTrack2){var existingTrack2=self.getExistingTrack("2");existingTrack2?(self.textTrack2=existingTrack2,self.clearCurrentCues(self.textTrack2),sendAddTrackEvent(self.textTrack2,self.media)):(self.textTrack2=self.createTextTrack("captions","Spanish","es"),self.textTrack2.textTrack2=!0)}self.Cues.newCue(self.textTrack2,startTime,endTime,screen)}};_this.cea608Parser=new _cea608Parser2.default(0,channel1,channel2)}return _this}return _inherits(TimelineController,_EventHandler),_createClass(TimelineController,[{key:"clearCurrentCues",value:function(track){if(track&&track.cues)for(;track.cues.length>0;)track.removeCue(track.cues[0])}},{key:"getExistingTrack",value:function(channelNumber){var media=this.media;if(media)for(var i=0;i<media.textTracks.length;i++){var textTrack=media.textTracks[i],propName="textTrack"+channelNumber;if(textTrack[propName]===!0)return textTrack}return null}},{key:"createTextTrack",value:function(kind,label,lang){if(this.media)return this.media.addTextTrack(kind,label,lang)}},{key:"destroy",value:function(){_eventHandler2.default.prototype.destroy.call(this)}},{key:"onMediaAttaching",value:function(data){this.media=data.media}},{key:"onMediaDetaching",value:function(){this.clearCurrentCues(this.textTrack1),this.clearCurrentCues(this.textTrack2)}},{key:"onManifestLoading",value:function(){this.lastPts=Number.NEGATIVE_INFINITY}},{key:"onLevelSwitch",value:function(){"NONE"===this.hls.currentLevel.closedCaptions?this.enabled=!1:this.enabled=!0}},{key:"onFragLoaded",value:function(data){if("main"===data.frag.type){var pts=data.frag.start;pts<=this.lastPts&&(this.clearCurrentCues(this.textTrack1),this.clearCurrentCues(this.textTrack2)),this.lastPts=pts}}},{key:"onFragParsingUserdata",value:function(data){if(this.enabled&&this.config.enableCEA708Captions)for(var i=0;i<data.samples.length;i++){var ccdatas=this.extractCea608Data(data.samples[i].bytes);this.cea608Parser.addData(data.samples[i].pts,ccdatas)}}},{key:"extractCea608Data",value:function(byteArray){for(var tmpByte,ccbyte1,ccbyte2,ccValid,ccType,count=31&byteArray[0],position=2,actualCCBytes=[],j=0;j<count;j++)tmpByte=byteArray[position++],ccbyte1=127&byteArray[position++],ccbyte2=127&byteArray[position++],ccValid=0!==(4&tmpByte),ccType=3&tmpByte,0===ccbyte1&&0===ccbyte2||ccValid&&0===ccType&&(actualCCBytes.push(ccbyte1),actualCCBytes.push(ccbyte2));return actualCCBytes}}]),TimelineController}(_eventHandler2.default);exports.default=TimelineController},{"../event-handler":27,"../events":28,"../utils/cea-608-parser":42}],14:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),AESCrypto=function(){function AESCrypto(subtle,iv){_classCallCheck(this,AESCrypto),this.subtle=subtle,this.aesIV=iv}return _createClass(AESCrypto,[{key:"decrypt",value:function(data,key){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},key,data)}}]),AESCrypto}();exports.default=AESCrypto},{}],15:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),AESDecryptor=function(){function AESDecryptor(){_classCallCheck(this,AESDecryptor),this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[],this.subMix[0]=new Uint32Array(256),this.subMix[1]=new Uint32Array(256),this.subMix[2]=new Uint32Array(256),this.subMix[3]=new Uint32Array(256),this.invSubMix=[],this.invSubMix[0]=new Uint32Array(256),this.invSubMix[1]=new Uint32Array(256),this.invSubMix[2]=new Uint32Array(256),this.invSubMix[3]=new Uint32Array(256),this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}return _createClass(AESDecryptor,[{key:"uint8ArrayToUint32Array_",value:function(arrayBuffer){for(var view=new DataView(arrayBuffer),newArray=new Uint32Array(4),i=0;i<newArray.length;i++)newArray[i]=view.getUint32(4*i);return newArray}},{key:"initTable",value:function(){var sBox=this.sBox,invSBox=this.invSBox,subMix0=this.subMix[0],subMix1=this.subMix[1],subMix2=this.subMix[2],subMix3=this.subMix[3],invSubMix0=this.invSubMix[0],invSubMix1=this.invSubMix[1],invSubMix2=this.invSubMix[2],invSubMix3=this.invSubMix[3],d=new Uint32Array(256),x=0,xi=0,i=0;for(i=0;i<256;i++)i<128?d[i]=i<<1:d[i]=i<<1^283;for(i=0;i<256;i++){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,sBox[x]=sx,invSBox[sx]=x;var x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;subMix0[x]=t<<24|t>>>8,subMix1[x]=t<<16|t>>>16,subMix2[x]=t<<8|t>>>24,subMix3[x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,invSubMix0[sx]=t<<24|t>>>8,invSubMix1[sx]=t<<16|t>>>16,invSubMix2[sx]=t<<8|t>>>24,invSubMix3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}}},{key:"expandKey",value:function(keyBuffer){for(var key=this.uint8ArrayToUint32Array_(keyBuffer),sameKey=!0,offset=0;offset<key.length&&sameKey;)sameKey=key[offset]===this.key[offset],offset++;if(!sameKey){this.key=key;var keySize=this.keySize=key.length;if(4!==keySize&&6!==keySize&&8!==keySize)throw new Error("Invalid aes key size="+keySize);var ksRows=this.ksRows=4*(keySize+6+1),ksRow=void 0,invKsRow=void 0,keySchedule=this.keySchedule=new Uint32Array(this.ksRows),invKeySchedule=this.invKeySchedule=new Uint32Array(this.ksRows),sbox=this.sBox,rcon=this.rcon,invSubMix0=this.invSubMix[0],invSubMix1=this.invSubMix[1],invSubMix2=this.invSubMix[2],invSubMix3=this.invSubMix[3],prev=void 0,t=void 0;for(ksRow=0;ksRow<ksRows;ksRow++)ksRow<keySize?prev=keySchedule[ksRow]=key[ksRow]:(t=prev,ksRow%keySize===0?(t=t<<8|t>>>24,t=sbox[t>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t],t^=rcon[ksRow/keySize|0]<<24):keySize>6&&ksRow%keySize===4&&(t=sbox[t>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t]),keySchedule[ksRow]=prev=(keySchedule[ksRow-keySize]^t)>>>0);for(invKsRow=0;invKsRow<ksRows;invKsRow++)ksRow=ksRows-invKsRow,t=3&invKsRow?keySchedule[ksRow]:keySchedule[ksRow-4],invKsRow<4||ksRow<=4?invKeySchedule[invKsRow]=t:invKeySchedule[invKsRow]=invSubMix0[sbox[t>>>24]]^invSubMix1[sbox[t>>>16&255]]^invSubMix2[sbox[t>>>8&255]]^invSubMix3[sbox[255&t]],invKeySchedule[invKsRow]=invKeySchedule[invKsRow]>>>0}}},{key:"networkToHostOrderSwap",value:function(word){return word<<24|(65280&word)<<8|(16711680&word)>>8|word>>>24}},{key:"decrypt",value:function(inputArrayBuffer,offset,aesIV){for(var ksRow,i,nRounds=this.keySize+6,invKeySchedule=this.invKeySchedule,invSBOX=this.invSBox,invSubMix0=this.invSubMix[0],invSubMix1=this.invSubMix[1],invSubMix2=this.invSubMix[2],invSubMix3=this.invSubMix[3],initVector=this.uint8ArrayToUint32Array_(aesIV),initVector0=initVector[0],initVector1=initVector[1],initVector2=initVector[2],initVector3=initVector[3],inputInt32=new Int32Array(inputArrayBuffer),outputInt32=new Int32Array(inputInt32.length),t0=void 0,t1=void 0,t2=void 0,t3=void 0,s0=void 0,s1=void 0,s2=void 0,s3=void 0,inputWords0=void 0,inputWords1=void 0,inputWords2=void 0,inputWords3=void 0;offset<inputInt32.length;){for(inputWords0=this.networkToHostOrderSwap(inputInt32[offset]),inputWords1=this.networkToHostOrderSwap(inputInt32[offset+1]),inputWords2=this.networkToHostOrderSwap(inputInt32[offset+2]),inputWords3=this.networkToHostOrderSwap(inputInt32[offset+3]),s0=inputWords0^invKeySchedule[0],s1=inputWords3^invKeySchedule[1],s2=inputWords2^invKeySchedule[2],s3=inputWords1^invKeySchedule[3],ksRow=4,i=1;i<nRounds;i++)t0=invSubMix0[s0>>>24]^invSubMix1[s1>>16&255]^invSubMix2[s2>>8&255]^invSubMix3[255&s3]^invKeySchedule[ksRow],t1=invSubMix0[s1>>>24]^invSubMix1[s2>>16&255]^invSubMix2[s3>>8&255]^invSubMix3[255&s0]^invKeySchedule[ksRow+1],t2=invSubMix0[s2>>>24]^invSubMix1[s3>>16&255]^invSubMix2[s0>>8&255]^invSubMix3[255&s1]^invKeySchedule[ksRow+2],t3=invSubMix0[s3>>>24]^invSubMix1[s0>>16&255]^invSubMix2[s1>>8&255]^invSubMix3[255&s2]^invKeySchedule[ksRow+3],s0=t0,s1=t1,s2=t2,s3=t3,ksRow+=4;t0=invSBOX[s0>>>24]<<24^invSBOX[s1>>16&255]<<16^invSBOX[s2>>8&255]<<8^invSBOX[255&s3]^invKeySchedule[ksRow],t1=invSBOX[s1>>>24]<<24^invSBOX[s2>>16&255]<<16^invSBOX[s3>>8&255]<<8^invSBOX[255&s0]^invKeySchedule[ksRow+1],t2=invSBOX[s2>>>24]<<24^invSBOX[s3>>16&255]<<16^invSBOX[s0>>8&255]<<8^invSBOX[255&s1]^invKeySchedule[ksRow+2],t3=invSBOX[s3>>>24]<<24^invSBOX[s0>>16&255]<<16^invSBOX[s1>>8&255]<<8^invSBOX[255&s2]^invKeySchedule[ksRow+3],ksRow+=3,outputInt32[offset]=this.networkToHostOrderSwap(t0^initVector0),outputInt32[offset+1]=this.networkToHostOrderSwap(t3^initVector1),outputInt32[offset+2]=this.networkToHostOrderSwap(t2^initVector2),outputInt32[offset+3]=this.networkToHostOrderSwap(t1^initVector3),initVector0=inputWords0,initVector1=inputWords1,initVector2=inputWords2,initVector3=inputWords3,offset+=4}return outputInt32.buffer}},{key:"destroy",value:function(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}]),AESDecryptor}();exports.default=AESDecryptor},{}],16:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor);
}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_aesCrypto=require("./aes-crypto"),_aesCrypto2=_interopRequireDefault(_aesCrypto),_fastAesKey=require("./fast-aes-key"),_fastAesKey2=_interopRequireDefault(_fastAesKey),_aesDecryptor=require("./aes-decryptor"),_aesDecryptor2=_interopRequireDefault(_aesDecryptor),_errors=require("../errors"),_logger=require("../utils/logger"),Decrypter=function(){function Decrypter(observer,config){_classCallCheck(this,Decrypter),this.observer=observer,this.config=config;try{var browserCrypto=crypto?crypto:self.crypto;this.subtle=browserCrypto.subtle||browserCrypto.webkitSubtle}catch(e){}this.disableWebCrypto=!this.subtle}return _createClass(Decrypter,[{key:"decrypt",value:function(data,key,iv,callback){var _this=this;if(this.disableWebCrypto&&this.config.enableSoftwareAES){_logger.logger.log("JS AES decrypt");var decryptor=this.decryptor;decryptor||(this.decryptor=decryptor=new _aesDecryptor2.default),decryptor.expandKey(key),callback(decryptor.decrypt(data,0,iv))}else!function(){_logger.logger.log("WebCrypto AES decrypt");var subtle=_this.subtle;_this.key!==key&&(_this.key=key,_this.fastAesKey=new _fastAesKey2.default(subtle,key)),_this.fastAesKey.expandKey().then(function(aesKey){var crypto=new _aesCrypto2.default(subtle,iv);crypto.decrypt(data,aesKey).then(function(result){callback(result)})}).catch(function(err){_this.onWebCryptoError(err,data,key,iv,callback)})}()}},{key:"onWebCryptoError",value:function(err,data,key,iv,callback){this.config.enableSoftwareAES?(_logger.logger.log("WebCrypto Error, disable WebCrypto API"),this.disableWebCrypto=!0,this.decrypt(data,key,iv,callback)):(_logger.logger.error("decrypting error : "+err.message),this.observer.trigger(Event.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_DECRYPT_ERROR,fatal:!0,reason:err.message}))}},{key:"destroy",value:function(){var decryptor=this.decryptor;decryptor&&(decryptor.destroy(),this.decryptor=void 0)}}]),Decrypter}();exports.default=Decrypter},{"../errors":26,"../utils/logger":45,"./aes-crypto":14,"./aes-decryptor":15,"./fast-aes-key":17}],17:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),FastAESKey=function(){function FastAESKey(subtle,key){_classCallCheck(this,FastAESKey),this.subtle=subtle,this.key=key}return _createClass(FastAESKey,[{key:"expandKey",value:function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}]),FastAESKey}();exports.default=FastAESKey},{}],18:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_adts=require("./adts"),_adts2=_interopRequireDefault(_adts),_logger=require("../utils/logger"),_id=require("../demux/id3"),_id2=_interopRequireDefault(_id),AACDemuxer=function(){function AACDemuxer(observer,id,remuxerClass,config,typeSupported){_classCallCheck(this,AACDemuxer),this.observer=observer,this.id=id,this.remuxerClass=remuxerClass,this.config=config,this.remuxer=new this.remuxerClass(observer,id,config,typeSupported),this.insertDiscontinuity()}return _createClass(AACDemuxer,[{key:"insertDiscontinuity",value:function(){this._aacTrack={container:"audio/adts",type:"audio",id:-1,sequenceNumber:0,isAAC:!0,samples:[],len:0}}},{key:"push",value:function(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,accurateTimeOffset,defaultInitPTS){var track,config,frameLength,frameDuration,frameIndex,offset,headerLength,stamp,len,aacSample,id3=new _id2.default(data),pts=90*id3.timeStamp,contiguous=!1;for(cc!==this.lastCC?(_logger.logger.log(this.id+" discontinuity detected"),this.lastCC=cc,this.insertDiscontinuity(),this.remuxer.switchLevel(),this.remuxer.insertDiscontinuity()):level!==this.lastLevel?(_logger.logger.log("audio track switch detected"),this.lastLevel=level,this.remuxer.switchLevel(),this.insertDiscontinuity()):sn===this.lastSN+1&&(contiguous=!0),track=this._aacTrack,this.lastSN=sn,this.lastLevel=level,offset=id3.length,len=data.length;offset<len-1&&(255!==data[offset]||240!==(240&data[offset+1]));offset++);for(track.audiosamplerate||(config=_adts2.default.getAudioConfig(this.observer,data,offset,audioCodec),track.config=config.config,track.audiosamplerate=config.samplerate,track.channelCount=config.channelCount,track.codec=config.codec,track.manifestCodec=config.manifestCodec,track.duration=duration,_logger.logger.log("parsed codec:"+track.codec+",rate:"+config.samplerate+",nb channel:"+config.channelCount)),frameIndex=0,frameDuration=9216e4/track.audiosamplerate;offset+5<len&&(headerLength=1&data[offset+1]?7:9,frameLength=(3&data[offset+3])<<11|data[offset+4]<<3|(224&data[offset+5])>>>5,frameLength-=headerLength,frameLength>0&&offset+headerLength+frameLength<=len);)for(stamp=pts+frameIndex*frameDuration,aacSample={unit:data.subarray(offset+headerLength,offset+headerLength+frameLength),pts:stamp,dts:stamp},track.samples.push(aacSample),track.len+=frameLength,offset+=frameLength+headerLength,frameIndex++;offset<len-1&&(255!==data[offset]||240!==(240&data[offset+1]));offset++);this.remuxer.remux(level,sn,cc,track,{samples:[]},{samples:[{pts:pts,dts:pts,unit:id3.payload}]},{samples:[]},timeOffset,contiguous,accurateTimeOffset,defaultInitPTS)}},{key:"destroy",value:function(){}}],[{key:"probe",value:function(data){var offset,len,id3=new _id2.default(data);if(id3.hasTimeStamp)for(offset=id3.length,len=data.length;offset<len-1;offset++)if(255===data[offset]&&240===(240&data[offset+1]))return!0;return!1}}]),AACDemuxer}();exports.default=AACDemuxer},{"../demux/id3":24,"../utils/logger":45,"./adts":19}],19:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_logger=require("../utils/logger"),_errors=require("../errors"),ADTS=function(){function ADTS(){_classCallCheck(this,ADTS)}return _createClass(ADTS,null,[{key:"getAudioConfig",value:function(observer,data,offset,audioCodec){var adtsObjectType,adtsSampleingIndex,adtsExtensionSampleingIndex,adtsChanelConfig,config,userAgent=navigator.userAgent.toLowerCase(),manifestCodec=audioCodec,adtsSampleingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];return adtsObjectType=((192&data[offset+2])>>>6)+1,adtsSampleingIndex=(60&data[offset+2])>>>2,adtsSampleingIndex>adtsSampleingRates.length-1?void observer.trigger(Event.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+adtsSampleingIndex}):(adtsChanelConfig=(1&data[offset+2])<<2,adtsChanelConfig|=(192&data[offset+3])>>>6,_logger.logger.log("manifest codec:"+audioCodec+",ADTS data:type:"+adtsObjectType+",sampleingIndex:"+adtsSampleingIndex+"["+adtsSampleingRates[adtsSampleingIndex]+"Hz],channelConfig:"+adtsChanelConfig),/firefox/i.test(userAgent)?adtsSampleingIndex>=6?(adtsObjectType=5,config=new Array(4),adtsExtensionSampleingIndex=adtsSampleingIndex-3):(adtsObjectType=2,config=new Array(2),adtsExtensionSampleingIndex=adtsSampleingIndex):userAgent.indexOf("android")!==-1?(adtsObjectType=2,config=new Array(2),adtsExtensionSampleingIndex=adtsSampleingIndex):(adtsObjectType=5,config=new Array(4),audioCodec&&(audioCodec.indexOf("mp4a.40.29")!==-1||audioCodec.indexOf("mp4a.40.5")!==-1)||!audioCodec&&adtsSampleingIndex>=6?adtsExtensionSampleingIndex=adtsSampleingIndex-3:((audioCodec&&audioCodec.indexOf("mp4a.40.2")!==-1&&adtsSampleingIndex>=6&&1===adtsChanelConfig||!audioCodec&&1===adtsChanelConfig)&&(adtsObjectType=2,config=new Array(2)),adtsExtensionSampleingIndex=adtsSampleingIndex)),config[0]=adtsObjectType<<3,config[0]|=(14&adtsSampleingIndex)>>1,config[1]|=(1&adtsSampleingIndex)<<7,config[1]|=adtsChanelConfig<<3,5===adtsObjectType&&(config[1]|=(14&adtsExtensionSampleingIndex)>>1,config[2]=(1&adtsExtensionSampleingIndex)<<7,config[2]|=8,config[3]=0),{config:config,samplerate:adtsSampleingRates[adtsSampleingIndex],channelCount:adtsChanelConfig,codec:"mp4a.40."+adtsObjectType,manifestCodec:manifestCodec})}}]),ADTS}();exports.default=ADTS},{"../errors":26,"../utils/logger":45}],20:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_errors=require("../errors"),_decrypter=require("../crypt/decrypter"),_decrypter2=_interopRequireDefault(_decrypter),_aacdemuxer=require("../demux/aacdemuxer"),_aacdemuxer2=_interopRequireDefault(_aacdemuxer),_tsdemuxer=require("../demux/tsdemuxer"),_tsdemuxer2=_interopRequireDefault(_tsdemuxer),_mp4Remuxer=require("../remux/mp4-remuxer"),_mp4Remuxer2=_interopRequireDefault(_mp4Remuxer),_passthroughRemuxer=require("../remux/passthrough-remuxer"),_passthroughRemuxer2=_interopRequireDefault(_passthroughRemuxer),DemuxerInline=function(){function DemuxerInline(hls,id,typeSupported){var config=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,DemuxerInline),this.hls=hls,this.id=id,this.config=this.hls.config||config,this.typeSupported=typeSupported}return _createClass(DemuxerInline,[{key:"destroy",value:function(){var demuxer=this.demuxer;demuxer&&demuxer.destroy()}},{key:"push",value:function(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,decryptdata,accurateTimeOffset,defaultInitPTS){if(data.byteLength>0&&null!=decryptdata&&null!=decryptdata.key&&"AES-128"===decryptdata.method){null==this.decrypter&&(this.decrypter=new _decrypter2.default(this.hls,this.config));var startTime,localthis=this;try{startTime=performance.now()}catch(error){startTime=Date.now()}this.decrypter.decrypt(data,decryptdata.key.buffer,decryptdata.iv.buffer,function(decryptedData){var endTime;try{endTime=performance.now()}catch(error){endTime=Date.now()}localthis.hls.trigger(_events2.default.FRAG_DECRYPTED,{level:level,sn:sn,stats:{tstart:startTime,tdecrypt:endTime}}),localthis.pushDecrypted(new Uint8Array(decryptedData),audioCodec,videoCodec,timeOffset,cc,level,sn,duration,accurateTimeOffset,defaultInitPTS)})}else this.pushDecrypted(new Uint8Array(data),audioCodec,videoCodec,timeOffset,cc,level,sn,duration,accurateTimeOffset,defaultInitPTS)}},{key:"pushDecrypted",value:function(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,accurateTimeOffset,defaultInitPTS){var demuxer=this.demuxer;if(!demuxer||cc!==this.cc&&!demuxer.probe(data)){var hls=this.hls,id=this.id,config=this.config,typeSupported=this.typeSupported;if(_tsdemuxer2.default.probe(data))demuxer=this.typeSupported.mp2t===!0?new _tsdemuxer2.default(hls,id,_passthroughRemuxer2.default,config,typeSupported):new _tsdemuxer2.default(hls,id,_mp4Remuxer2.default,config,typeSupported),demuxer.probe=_tsdemuxer2.default.probe;else{if(!_aacdemuxer2.default.probe(data))return void hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,id:id,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"});demuxer=new _aacdemuxer2.default(hls,id,_mp4Remuxer2.default,config,typeSupported),demuxer.probe=_aacdemuxer2.default.probe}this.demuxer=demuxer}demuxer.push(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,accurateTimeOffset,defaultInitPTS),this.cc=cc}}]),DemuxerInline}();exports.default=DemuxerInline},{"../crypt/decrypter":16,"../demux/aacdemuxer":18,"../demux/tsdemuxer":25,"../errors":26,"../events":28,"../remux/mp4-remuxer":38,"../remux/passthrough-remuxer":39}],21:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0});var _demuxerInline=require("../demux/demuxer-inline"),_demuxerInline2=_interopRequireDefault(_demuxerInline),_events=require("../events"),_events2=_interopRequireDefault(_events),_logger=require("../utils/logger"),_events3=require("events"),_events4=_interopRequireDefault(_events3),DemuxerWorker=function(self){var observer=new _events4.default;observer.trigger=function(event){for(var _len=arguments.length,data=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)data[_key-1]=arguments[_key];observer.emit.apply(observer,[event,event].concat(data))},observer.off=function(event){for(var _len2=arguments.length,data=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)data[_key2-1]=arguments[_key2];observer.removeListener.apply(observer,[event].concat(data))};var forwardMessage=function(ev,data){self.postMessage({event:ev,data:data})};self.addEventListener("message",function(ev){var data=ev.data;switch(data.cmd){case"init":var config=JSON.parse(data.config);self.demuxer=new _demuxerInline2.default(observer,data.id,data.typeSupported,config);try{(0,_logger.enableLogs)(config.debug===!0)}catch(err){console.warn("demuxerWorker: unable to enable logs")}forwardMessage("init",null);break;case"demux":self.demuxer.push(data.data,data.audioCodec,data.videoCodec,data.timeOffset,data.cc,data.level,data.sn,data.duration,data.decryptdata,data.accurateTimeOffset,data.defaultInitPTS)}}),observer.on(_events2.default.FRAG_DECRYPTED,forwardMessage),observer.on(_events2.default.FRAG_PARSING_INIT_SEGMENT,forwardMessage),observer.on(_events2.default.FRAG_PARSED,forwardMessage),observer.on(_events2.default.ERROR,forwardMessage),observer.on(_events2.default.FRAG_PARSING_METADATA,forwardMessage),observer.on(_events2.default.FRAG_PARSING_USERDATA,forwardMessage),observer.on(_events2.default.INIT_PTS_FOUND,forwardMessage),observer.on(_events2.default.FRAG_PARSING_DATA,function(ev,data){var data1=data.data1.buffer,data2=data.data2.buffer;delete data.data1,delete data.data2,self.postMessage({event:ev,data:data,data1:data1,data2:data2},[data1,data2])})};exports.default=DemuxerWorker},{"../demux/demuxer-inline":20,"../events":28,"../utils/logger":45,events:1}],22:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_demuxerInline=require("../demux/demuxer-inline"),_demuxerInline2=_interopRequireDefault(_demuxerInline),_demuxerWorker=require("../demux/demuxer-worker"),_demuxerWorker2=_interopRequireDefault(_demuxerWorker),_logger=require("../utils/logger"),_errors=require("../errors"),Demuxer=function(){function Demuxer(hls,id){_classCallCheck(this,Demuxer),this.hls=hls,this.id=id;var typeSupported={mp4:MediaSource.isTypeSupported("video/mp4"),mp2t:hls.config.enableMP2TPassThrough&&MediaSource.isTypeSupported("video/mp2t"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')};if(hls.config.enableWorker&&"undefined"!=typeof Worker){_logger.logger.log("demuxing in webworker");var w=void 0;try{var work=require("webworkify");w=this.w=work(_demuxerWorker2.default),this.onwmsg=this.onWorkerMessage.bind(this),w.addEventListener("message",this.onwmsg),w.onerror=function(event){hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.OTHER_ERROR,details:_errors.ErrorDetails.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",err:{message:event.message+" ("+event.filename+":"+event.lineno+")"}})},w.postMessage({cmd:"init",typeSupported:typeSupported,id:id,config:JSON.stringify(hls.config)})}catch(err){_logger.logger.error("error while initializing DemuxerWorker, fallback on DemuxerInline"),w&&URL.revokeObjectURL(w.objectURL),this.demuxer=new _demuxerInline2.default(hls,id,typeSupported)}}else this.demuxer=new _demuxerInline2.default(hls,id,typeSupported);this.demuxInitialized=!0}return _createClass(Demuxer,[{key:"destroy",value:function(){var w=this.w;if(w)w.removeEventListener("message",this.onwmsg),w.terminate(),this.w=null;else{var demuxer=this.demuxer;demuxer&&(demuxer.destroy(),this.demuxer=null)}}},{key:"push",value:function(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,decryptdata,accurateTimeOffset,defaultInitPTS){var w=this.w;if(w)w.postMessage({cmd:"demux",data:data,audioCodec:audioCodec,videoCodec:videoCodec,timeOffset:timeOffset,cc:cc,level:level,sn:sn,duration:duration,decryptdata:decryptdata,accurateTimeOffset:accurateTimeOffset,defaultInitPTS:defaultInitPTS},[data]);else{var demuxer=this.demuxer;demuxer&&demuxer.push(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,decryptdata,accurateTimeOffset,defaultInitPTS)}}},{key:"onWorkerMessage",value:function(ev){var data=ev.data,hls=this.hls;switch(data.event){case"init":URL.revokeObjectURL(this.w.objectURL);break;case _events2.default.FRAG_PARSING_DATA:data.data.data1=new Uint8Array(data.data1),data.data.data2=new Uint8Array(data.data2);default:hls.trigger(data.event,data.data)}}}]),Demuxer}();exports.default=Demuxer},{"../demux/demuxer-inline":20,"../demux/demuxer-worker":21,"../errors":26,"../events":28,"../utils/logger":45,webworkify:3}],23:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_logger=require("../utils/logger"),ExpGolomb=function(){function ExpGolomb(data){_classCallCheck(this,ExpGolomb),this.data=data,this.bytesAvailable=data.byteLength,this.word=0,this.bitsAvailable=0}return _createClass(ExpGolomb,[{key:"loadWord",value:function(){var data=this.data,bytesAvailable=this.bytesAvailable,position=data.byteLength-bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,bytesAvailable);if(0===availableBytes)throw new Error("no bytes available");workingBytes.set(data.subarray(position,position+availableBytes)),this.word=new DataView(workingBytes.buffer).getUint32(0),this.bitsAvailable=8*availableBytes,this.bytesAvailable-=availableBytes}},{key:"skipBits",value:function(count){var skipBytes;this.bitsAvailable>count?(this.word<<=count,this.bitsAvailable-=count):(count-=this.bitsAvailable,skipBytes=count>>3,count-=skipBytes>>3,this.bytesAvailable-=skipBytes,this.loadWord(),this.word<<=count,this.bitsAvailable-=count)}},{key:"readBits",value:function(size){var bits=Math.min(this.bitsAvailable,size),valu=this.word>>>32-bits;return size>32&&_logger.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=bits,this.bitsAvailable>0?this.word<<=bits:this.bytesAvailable>0&&this.loadWord(),bits=size-bits,bits>0&&this.bitsAvailable?valu<<bits|this.readBits(bits):valu}},{key:"skipLZ",value:function(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount)if(0!==(this.word&2147483648>>>leadingZeroCount))return this.word<<=leadingZeroCount,this.bitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var clz=this.skipLZ();return this.readBits(clz+1)-1}},{key:"readEG",value:function(){var valu=this.readUEG();return 1&valu?1+valu>>>1:-1*(valu>>>1)}},{key:"readBoolean",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"readUShort",value:function(){return this.readBits(16)}},{key:"readUInt",value:function(){return this.readBits(32)}},{key:"skipScalingList",value:function(count){var j,deltaScale,lastScale=8,nextScale=8;for(j=0;j<count;j++)0!==nextScale&&(deltaScale=this.readEG(),nextScale=(lastScale+deltaScale+256)%256),lastScale=0===nextScale?lastScale:nextScale}},{key:"readSPS",value:function(){var profileIdc,profileCompat,levelIdc,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,i,frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,readUByte=this.readUByte.bind(this),readBits=this.readBits.bind(this),readUEG=this.readUEG.bind(this),readBoolean=this.readBoolean.bind(this),skipBits=this.skipBits.bind(this),skipEG=this.skipEG.bind(this),skipUEG=this.skipUEG.bind(this),skipScalingList=this.skipScalingList.bind(this);if(readUByte(),profileIdc=readUByte(),profileCompat=readBits(5),skipBits(3),levelIdc=readUByte(),skipUEG(),100===profileIdc||110===profileIdc||122===profileIdc||244===profileIdc||44===profileIdc||83===profileIdc||86===profileIdc||118===profileIdc||128===profileIdc){var chromaFormatIdc=readUEG();if(3===chromaFormatIdc&&skipBits(1),skipUEG(),skipUEG(),skipBits(1),readBoolean())for(scalingListCount=3!==chromaFormatIdc?8:12,i=0;i<scalingListCount;i++)readBoolean()&&skipScalingList(i<6?16:64)}skipUEG();var picOrderCntType=readUEG();if(0===picOrderCntType)readUEG();else if(1===picOrderCntType)for(skipBits(1),skipEG(),skipEG(),numRefFramesInPicOrderCntCycle=readUEG(),i=0;i<numRefFramesInPicOrderCntCycle;i++)skipEG();skipUEG(),skipBits(1),picWidthInMbsMinus1=readUEG(),picHeightInMapUnitsMinus1=readUEG(),frameMbsOnlyFlag=readBits(1),0===frameMbsOnlyFlag&&skipBits(1),skipBits(1),readBoolean()&&(frameCropLeftOffset=readUEG(),frameCropRightOffset=readUEG(),frameCropTopOffset=readUEG(),frameCropBottomOffset=readUEG());var pixelRatio=[1,1];if(readBoolean()&&readBoolean()){var aspectRatioIdc=readUByte();switch(aspectRatioIdc){case 1:pixelRatio=[1,1];break;case 2:pixelRatio=[12,11];break;case 3:pixelRatio=[10,11];break;case 4:pixelRatio=[16,11];break;case 5:pixelRatio=[40,33];break;case 6:pixelRatio=[24,11];break;case 7:pixelRatio=[20,11];break;case 8:pixelRatio=[32,11];break;case 9:pixelRatio=[80,33];break;case 10:pixelRatio=[18,11];break;case 11:pixelRatio=[15,11];break;case 12:pixelRatio=[64,33];break;case 13:pixelRatio=[160,99];break;case 14:pixelRatio=[4,3];break;case 15:pixelRatio=[3,2];break;case 16:pixelRatio=[2,1];break;case 255:pixelRatio=[readUByte()<<8|readUByte(),readUByte()<<8|readUByte()]}}return{width:Math.ceil(16*(picWidthInMbsMinus1+1)-2*frameCropLeftOffset-2*frameCropRightOffset),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset),pixelRatio:pixelRatio}}},{key:"readSliceType",value:function(){return this.readUByte(),this.readUEG(),this.readUEG()}}]),ExpGolomb}();exports.default=ExpGolomb},{"../utils/logger":45}],24:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_logger=require("../utils/logger"),ID3=function(){function ID3(data){_classCallCheck(this,ID3),this._hasTimeStamp=!1;for(var byte1,byte2,byte3,byte4,tagSize,endPos,header,len,offset=0;;)if(header=this.readUTF(data,offset,3),offset+=3,"ID3"===header)offset+=3,byte1=127&data[offset++],byte2=127&data[offset++],byte3=127&data[offset++],byte4=127&data[offset++],tagSize=(byte1<<21)+(byte2<<14)+(byte3<<7)+byte4,endPos=offset+tagSize,this._parseID3Frames(data,offset,endPos),offset=endPos;else{if("3DI"!==header)return offset-=3,len=offset,void(len&&(this.hasTimeStamp||_logger.logger.warn("ID3 tag found, but no timestamp"),this._length=len,this._payload=data.subarray(0,len)));offset+=7,_logger.logger.log("3DI footer found, end: "+offset)}}return _createClass(ID3,[{key:"readUTF",value:function(data,start,len){var result="",offset=start,end=start+len;do result+=String.fromCharCode(data[offset++]);while(offset<end);return result}},{key:"_parseID3Frames",value:function(data,offset,endPos){for(var tagId,tagLen,tagStart,tagFlags,timestamp;offset+8<=endPos;)switch(tagId=this.readUTF(data,offset,4),offset+=4,tagLen=data[offset++]<<24+data[offset++]<<16+data[offset++]<<8+data[offset++],tagFlags=data[offset++]<<8+data[offset++],tagStart=offset,tagId){case"PRIV":if("com.apple.streaming.transportStreamTimestamp"===this.readUTF(data,offset,44)){offset+=44,offset+=4;var pts33Bit=1&data[offset++];this._hasTimeStamp=!0,timestamp=((data[offset++]<<23)+(data[offset++]<<15)+(data[offset++]<<7)+data[offset++])/45,pts33Bit&&(timestamp+=47721858.84),timestamp=Math.round(timestamp),_logger.logger.trace("ID3 timestamp found: "+timestamp),this._timeStamp=timestamp}}}},{key:"hasTimeStamp",get:function(){return this._hasTimeStamp}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"length",get:function(){return this._length}},{key:"payload",get:function(){return this._payload}}]),ID3}();exports.default=ID3},{"../utils/logger":45}],25:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_adts=require("./adts"),_adts2=_interopRequireDefault(_adts),_events=require("../events"),_events2=_interopRequireDefault(_events),_expGolomb=require("./exp-golomb"),_expGolomb2=_interopRequireDefault(_expGolomb),_logger=require("../utils/logger"),_errors=require("../errors"),TSDemuxer=function(){function TSDemuxer(observer,id,remuxerClass,config,typeSupported){_classCallCheck(this,TSDemuxer),this.observer=observer,this.id=id,this.remuxerClass=remuxerClass,this.config=config,this.typeSupported=typeSupported,this.lastCC=0,this.remuxer=new this.remuxerClass(observer,id,config,typeSupported)}return _createClass(TSDemuxer,[{key:"switchLevel",value:function(){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack={container:"video/mp2t",type:"video",id:-1,sequenceNumber:0,samples:[],len:0,dropped:0},this._audioTrack={container:"video/mp2t",type:"audio",id:-1,sequenceNumber:0,samples:[],len:0,isAAC:!0},this._id3Track={type:"id3",id:-1,sequenceNumber:0,samples:[],len:0},this._txtTrack={type:"text",id:-1,sequenceNumber:0,samples:[],len:0},this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.remuxer.switchLevel()}},{key:"insertDiscontinuity",value:function(){this.switchLevel(),this.remuxer.insertDiscontinuity()}},{key:"push",value:function(data,audioCodec,videoCodec,timeOffset,cc,level,sn,duration,accurateTimeOffset,defaultInitPTS){var start,stt,pid,atf,offset,pes,len=data.length,codecsOnly=this.remuxer.passthrough,unknownPIDs=!1;this.audioCodec=audioCodec,this.videoCodec=videoCodec,this._duration=duration,this.contiguous=!1,this.accurateTimeOffset=accurateTimeOffset,cc!==this.lastCC&&(_logger.logger.log("discontinuity detected"),this.insertDiscontinuity(),this.lastCC=cc),level!==this.lastLevel?(_logger.logger.log("level switch detected"),this.switchLevel(),this.lastLevel=level):sn===this.lastSN+1&&(this.contiguous=!0),this.lastSN=sn;var pmtParsed=this.pmtParsed,avcTrack=this._avcTrack,audioTrack=this._audioTrack,id3Track=this._id3Track,avcId=avcTrack.id,audioId=audioTrack.id,id3Id=id3Track.id,pmtId=this._pmtId,avcData=avcTrack.pesData,audioData=audioTrack.pesData,id3Data=id3Track.pesData,parsePAT=this._parsePAT,parsePMT=this._parsePMT,parsePES=this._parsePES,parseAVCPES=this._parseAVCPES.bind(this),parseAACPES=this._parseAACPES.bind(this),parseMPEGPES=this._parseMPEGPES.bind(this),parseID3PES=this._parseID3PES.bind(this);
for(len-=len%188,start=0;start<len;start+=188)if(71===data[start]){if(stt=!!(64&data[start+1]),pid=((31&data[start+1])<<8)+data[start+2],atf=(48&data[start+3])>>4,atf>1){if(offset=start+5+data[start+4],offset===start+188)continue}else offset=start+4;switch(pid){case avcId:if(stt){if(avcData&&(pes=parsePES(avcData))&&(parseAVCPES(pes,!1),codecsOnly&&avcTrack.codec&&(audioId===-1||audioTrack.codec)))return void this.remux(level,sn,cc,data,timeOffset);avcData={data:[],size:0}}avcData&&(avcData.data.push(data.subarray(offset,start+188)),avcData.size+=start+188-offset);break;case audioId:if(stt){if(audioData&&(pes=parsePES(audioData))&&(audioTrack.isAAC?parseAACPES(pes):parseMPEGPES(pes),codecsOnly&&audioTrack.codec&&(avcId===-1||avcTrack.codec)))return void this.remux(level,sn,cc,data,timeOffset);audioData={data:[],size:0}}audioData&&(audioData.data.push(data.subarray(offset,start+188)),audioData.size+=start+188-offset);break;case id3Id:stt&&(id3Data&&(pes=parsePES(id3Data))&&parseID3PES(pes),id3Data={data:[],size:0}),id3Data&&(id3Data.data.push(data.subarray(offset,start+188)),id3Data.size+=start+188-offset);break;case 0:stt&&(offset+=data[offset]+1),pmtId=this._pmtId=parsePAT(data,offset);break;case pmtId:stt&&(offset+=data[offset]+1);var parsedPIDs=parsePMT(data,offset,this.typeSupported.mpeg===!0||this.typeSupported.mp3===!0);avcId=parsedPIDs.avc,avcId>0&&(avcTrack.id=avcId),audioId=parsedPIDs.audio,audioId>0&&(audioTrack.id=audioId,audioTrack.isAAC=parsedPIDs.isAAC),id3Id=parsedPIDs.id3,id3Id>0&&(id3Track.id=id3Id),unknownPIDs&&!pmtParsed&&(_logger.logger.log("reparse from beginning"),unknownPIDs=!1,start=-188),pmtParsed=this.pmtParsed=!0;break;case 17:case 8191:break;default:unknownPIDs=!0}}else this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,id:this.id,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});avcData&&(pes=parsePES(avcData))?(parseAVCPES(pes,!0),avcTrack.pesData=null):avcTrack.pesData=avcData,audioData&&(pes=parsePES(audioData))?(audioTrack.isAAC?parseAACPES(pes):parseMPEGPES(pes),audioTrack.pesData=null):(audioData&&audioData.size&&_logger.logger.log("last AAC PES packet truncated,might overlap between fragments"),audioTrack.pesData=audioData),id3Data&&(pes=parsePES(id3Data))?(parseID3PES(pes),id3Track.pesData=null):id3Track.pesData=id3Data,this.remux(level,sn,cc,null,timeOffset,defaultInitPTS)}},{key:"remux",value:function(level,sn,cc,data,timeOffset,defaultInitPTS){for(var avcTrack=this._avcTrack,samples=avcTrack.samples,nbNalu=0,naluLen=0,i=0;i<samples.length;i++){for(var sample=samples[i],units=sample.units.units,nbUnits=units.length,sampleLen=0,j=0;j<nbUnits;j++)sampleLen+=units[j].data.length;naluLen+=sampleLen,nbNalu+=nbUnits,sample.length=sampleLen}avcTrack.len=naluLen,avcTrack.nbNalu=nbNalu,this.remuxer.remux(level,sn,cc,this._audioTrack,this._avcTrack,this._id3Track,this._txtTrack,timeOffset,this.contiguous,this.accurateTimeOffset,defaultInitPTS,data)}},{key:"destroy",value:function(){this.switchLevel(),this._initPTS=this._initDTS=void 0,this._duration=0}},{key:"_parsePAT",value:function(data,offset){return(31&data[offset+10])<<8|data[offset+11]}},{key:"_parsePMT",value:function(data,offset,mpegSupported){var sectionLength,tableEnd,programInfoLength,pid,result={audio:-1,avc:-1,id3:-1,isAAC:!0};for(sectionLength=(15&data[offset+1])<<8|data[offset+2],tableEnd=offset+3+sectionLength-4,programInfoLength=(15&data[offset+10])<<8|data[offset+11],offset+=12+programInfoLength;offset<tableEnd;){switch(pid=(31&data[offset+1])<<8|data[offset+2],data[offset]){case 15:result.audio===-1&&(result.audio=pid);break;case 21:result.id3===-1&&(result.id3=pid);break;case 27:result.avc===-1&&(result.avc=pid);break;case 3:case 4:mpegSupported?result.audio===-1&&(result.audio=pid,result.isAAC=!1):_logger.logger.log("MPEG audio found, not supported in this browser for now");break;case 36:_logger.logger.warn("HEVC stream type found, not supported for now");break;default:_logger.logger.log("unkown stream type:"+data[offset])}offset+=((15&data[offset+3])<<8|data[offset+4])+5}return result}},{key:"_parsePES",value:function(stream){var frag,pesFlags,pesPrefix,pesLen,pesHdrLen,pesData,pesPts,pesDts,payloadStartOffset,i=0,data=stream.data;if(!stream||0===stream.size)return null;for(;data[0].length<19&&data.length>1;){var newData=new Uint8Array(data[0].length+data[1].length);newData.set(data[0]),newData.set(data[1],data[0].length),data[0]=newData,data.splice(1,1)}if(frag=data[0],pesPrefix=(frag[0]<<16)+(frag[1]<<8)+frag[2],1===pesPrefix){if(pesLen=(frag[4]<<8)+frag[5],pesLen&&pesLen>stream.size-6)return null;pesFlags=frag[7],192&pesFlags&&(pesPts=536870912*(14&frag[9])+4194304*(255&frag[10])+16384*(254&frag[11])+128*(255&frag[12])+(254&frag[13])/2,pesPts>4294967295&&(pesPts-=8589934592),64&pesFlags?(pesDts=536870912*(14&frag[14])+4194304*(255&frag[15])+16384*(254&frag[16])+128*(255&frag[17])+(254&frag[18])/2,pesDts>4294967295&&(pesDts-=8589934592),pesPts-pesDts>54e5&&(_logger.logger.warn(Math.round((pesPts-pesDts)/9e4)+"s delta between PTS and DTS, align them"),pesPts=pesDts)):pesDts=pesPts),pesHdrLen=frag[8],payloadStartOffset=pesHdrLen+9,stream.size-=payloadStartOffset,pesData=new Uint8Array(stream.size);for(var j=0,dataLen=data.length;j<dataLen;j++){frag=data[j];var len=frag.byteLength;if(payloadStartOffset){if(payloadStartOffset>len){payloadStartOffset-=len;continue}frag=frag.subarray(payloadStartOffset),len-=payloadStartOffset,payloadStartOffset=0}pesData.set(frag,i),i+=len}return pesLen&&(pesLen-=pesHdrLen+3),{data:pesData,pts:pesPts,dts:pesDts,len:pesLen}}return null}},{key:"pushAccesUnit",value:function(avcSample,avcTrack){avcSample.units.units.length&&avcSample.frame&&(!this.config.forceKeyFrameOnDiscontinuity||avcSample.key===!0||avcTrack.sps&&(avcTrack.samples.length||this.contiguous)?avcTrack.samples.push(avcSample):avcTrack.dropped++),avcSample.debug.length&&_logger.logger.log(avcSample.pts+"/"+avcSample.dts+":"+avcSample.debug+","+avcSample.units.length)}},{key:"_parseAVCPES",value:function(pes,last){var expGolombDecoder,push,i,_this=this,track=this._avcTrack,units=this._parseAVCNALu(pes.data),debug=!1,avcSample=this.avcSample;pes.data=null,units.forEach(function(unit){switch(unit.type){case 1:push=!0,debug&&avcSample&&(avcSample.debug+="NDR "),avcSample.frame=!0;var data=unit.data;if(data.length>4){var sliceType=new _expGolomb2.default(data).readSliceType();2!==sliceType&&4!==sliceType&&7!==sliceType&&9!==sliceType||(avcSample.key=!0)}break;case 5:push=!0,avcSample||(avcSample=_this.avcSample=_this._createAVCSample(!0,pes.pts,pes.dts,"")),debug&&(avcSample.debug+="IDR "),avcSample.key=!0,avcSample.frame=!0;break;case 6:push=!0,debug&&avcSample&&(avcSample.debug+="SEI "),expGolombDecoder=new _expGolomb2.default(_this.discardEPB(unit.data)),expGolombDecoder.readUByte();for(var payloadType=0,payloadSize=0,endOfCaptions=!1,b=0;!endOfCaptions&&expGolombDecoder.bytesAvailable>1;){payloadType=0;do b=expGolombDecoder.readUByte(),payloadType+=b;while(255===b);payloadSize=0;do b=expGolombDecoder.readUByte(),payloadSize+=b;while(255===b);if(4===payloadType&&0!==expGolombDecoder.bytesAvailable){endOfCaptions=!0;var countryCode=expGolombDecoder.readUByte();if(181===countryCode){var providerCode=expGolombDecoder.readUShort();if(49===providerCode){var userStructure=expGolombDecoder.readUInt();if(1195456820===userStructure){var userDataType=expGolombDecoder.readUByte();if(3===userDataType){var firstByte=expGolombDecoder.readUByte(),secondByte=expGolombDecoder.readUByte(),totalCCs=31&firstByte,byteArray=[firstByte,secondByte];for(i=0;i<totalCCs;i++)byteArray.push(expGolombDecoder.readUByte()),byteArray.push(expGolombDecoder.readUByte()),byteArray.push(expGolombDecoder.readUByte());_this._insertSampleInOrder(_this._txtTrack.samples,{type:3,pts:pes.pts,bytes:byteArray})}}}}}else if(payloadSize<expGolombDecoder.bytesAvailable)for(i=0;i<payloadSize;i++)expGolombDecoder.readUByte()}break;case 7:if(push=!0,debug&&avcSample&&(avcSample.debug+="SPS "),!track.sps){expGolombDecoder=new _expGolomb2.default(unit.data);var config=expGolombDecoder.readSPS();track.width=config.width,track.height=config.height,track.pixelRatio=config.pixelRatio,track.sps=[unit.data],track.duration=_this._duration;var codecarray=unit.data.subarray(1,4),codecstring="avc1.";for(i=0;i<3;i++){var h=codecarray[i].toString(16);h.length<2&&(h="0"+h),codecstring+=h}track.codec=codecstring}break;case 8:push=!0,debug&&avcSample&&(avcSample.debug+="PPS "),track.pps||(track.pps=[unit.data]);break;case 9:push=!1,avcSample&&_this.pushAccesUnit(avcSample,track),avcSample=_this.avcSample=_this._createAVCSample(!1,pes.pts,pes.dts,debug?"AUD ":"");break;case 12:push=!1;break;default:push=!1,avcSample&&(avcSample.debug+="unknown NAL "+unit.type+" ")}if(avcSample&&push){var _units=avcSample.units;_units.units.push(unit)}}),last&&avcSample&&(this.pushAccesUnit(avcSample,track),this.avcSample=null)}},{key:"_createAVCSample",value:function(key,pts,dts,debug){return{key:key,pts:pts,dts:dts,units:{units:[],length:0},debug:debug}}},{key:"_insertSampleInOrder",value:function(arr,data){var len=arr.length;if(len>0){if(data.pts>=arr[len-1].pts)arr.push(data);else for(var pos=len-1;pos>=0;pos--)if(data.pts<arr[pos].pts){arr.splice(pos,0,data);break}}else arr.push(data)}},{key:"_getLastNalUnit",value:function(){var avcSample=this.avcSample,lastUnit=void 0;if(!avcSample||0===avcSample.units.units.length){var track=this._avcTrack,samples=track.samples;avcSample=samples[samples.length-1]}if(avcSample){var units=avcSample.units.units;lastUnit=units[units.length-1]}return lastUnit}},{key:"_parseAVCNALu",value:function(array){var value,overflow,unit,unitType,lastUnitType,i=0,len=array.byteLength,track=this._avcTrack,state=track.naluState||0,lastState=state,units=[],lastUnitStart=-1;for(state===-1&&(lastUnitStart=0,lastUnitType=31&array[0],state=0,i=1);i<len;)if(value=array[i++],state)if(1!==state)if(value)if(1===value){if(lastUnitStart>=0)unit={data:array.subarray(lastUnitStart,i-state-1),type:lastUnitType},units.push(unit);else{var lastUnit=this._getLastNalUnit();if(lastUnit&&(lastState&&i<=4-lastState&&lastUnit.state&&(lastUnit.data=lastUnit.data.subarray(0,lastUnit.data.byteLength-lastState)),overflow=i-state-1,overflow>0)){var tmp=new Uint8Array(lastUnit.data.byteLength+overflow);tmp.set(lastUnit.data,0),tmp.set(array.subarray(0,overflow),lastUnit.data.byteLength),lastUnit.data=tmp}}i<len?(unitType=31&array[i],lastUnitStart=i,lastUnitType=unitType,state=0):state=-1}else state=0;else state=3;else state=value?0:2;else state=value?0:1;if(lastUnitStart>=0&&state>=0&&(unit={data:array.subarray(lastUnitStart,len),type:lastUnitType,state:state},units.push(unit)),0===units.length){var _lastUnit=this._getLastNalUnit();if(_lastUnit){var _tmp=new Uint8Array(_lastUnit.data.byteLength+array.byteLength);_tmp.set(_lastUnit.data,0),_tmp.set(array,_lastUnit.data.byteLength),_lastUnit.data=_tmp}}return track.naluState=state,units}},{key:"discardEPB",value:function(data){for(var newLength,newData,length=data.byteLength,EPBPositions=[],i=1;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(EPBPositions.push(i+2),i+=2):i++;if(0===EPBPositions.length)return data;newLength=length-EPBPositions.length,newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===EPBPositions[0]&&(sourceIndex++,EPBPositions.shift()),newData[i]=data[sourceIndex];return newData}},{key:"_parseAACPES",value:function(pes){var config,frameLength,frameDuration,frameIndex,offset,headerLength,stamp,len,aacSample,track=this._audioTrack,data=pes.data,pts=pes.pts,startOffset=0,aacOverFlow=this.aacOverFlow,aacLastPTS=this.aacLastPTS;if(aacOverFlow){var tmp=new Uint8Array(aacOverFlow.byteLength+data.byteLength);tmp.set(aacOverFlow,0),tmp.set(data,aacOverFlow.byteLength),data=tmp}for(offset=startOffset,len=data.length;offset<len-1&&(255!==data[offset]||240!==(240&data[offset+1]));offset++);if(offset){var reason,fatal;if(offset<len-1?(reason="AAC PES did not start with ADTS header,offset:"+offset,fatal=!1):(reason="no ADTS header found in AAC PES",fatal=!0),_logger.logger.warn("parsing error:"+reason),this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,id:this.id,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:fatal,reason:reason}),fatal)return}if(!track.audiosamplerate){var audioCodec=this.audioCodec;config=_adts2.default.getAudioConfig(this.observer,data,offset,audioCodec),track.config=config.config,track.audiosamplerate=config.samplerate,track.channelCount=config.channelCount,track.codec=config.codec,track.manifestCodec=config.manifestCodec,track.duration=this._duration,_logger.logger.log("parsed codec:"+track.codec+",rate:"+config.samplerate+",nb channel:"+config.channelCount)}if(frameIndex=0,frameDuration=9216e4/track.audiosamplerate,aacOverFlow&&aacLastPTS){var newPTS=aacLastPTS+frameDuration;Math.abs(newPTS-pts)>1&&(_logger.logger.log("AAC: align PTS for overlapping frames by "+Math.round((newPTS-pts)/90)),pts=newPTS)}for(;offset+5<len&&(headerLength=1&data[offset+1]?7:9,frameLength=(3&data[offset+3])<<11|data[offset+4]<<3|(224&data[offset+5])>>>5,frameLength-=headerLength,frameLength>0&&offset+headerLength+frameLength<=len);)for(stamp=pts+frameIndex*frameDuration,aacSample={unit:data.subarray(offset+headerLength,offset+headerLength+frameLength),pts:stamp,dts:stamp},track.samples.push(aacSample),track.len+=frameLength,offset+=frameLength+headerLength,frameIndex++;offset<len-1&&(255!==data[offset]||240!==(240&data[offset+1]));offset++);aacOverFlow=offset<len?data.subarray(offset,len):null,this.aacOverFlow=aacOverFlow,this.aacLastPTS=stamp}},{key:"_parseMPEGPES",value:function(pes){for(var parsed,data=pes.data,pts=pes.pts,length=data.length,frameIndex=0,offset=0;offset<length&&(parsed=this._parseMpeg(data,offset,length,frameIndex++,pts))>0;)offset+=parsed}},{key:"_onMpegFrame",value:function(data,bitRate,sampleRate,channelCount,frameIndex,pts){var frameDuration=1152/sampleRate*1e3,stamp=pts+frameIndex*frameDuration,track=this._audioTrack;track.config=[],track.channelCount=channelCount,track.audiosamplerate=sampleRate,track.duration=this._duration,track.samples.push({unit:data,pts:stamp,dts:stamp}),track.len+=data.length}},{key:"_onMpegNoise",value:function(data){_logger.logger.warn("mpeg audio has noise: "+data.length+" bytes")}},{key:"_parseMpeg",value:function(data,start,end,frameIndex,pts){var BitratesMap=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3];if(start+2>end)return-1;if(255===data[start]||224===(224&data[start+1])){if(start+24>end)return-1;var headerB=data[start+1]>>3&3,headerC=data[start+1]>>1&3,headerE=data[start+2]>>4&15,headerF=data[start+2]>>2&3,headerG=!!(2&data[start+2]);if(1!==headerB&&0!==headerE&&15!==headerE&&3!==headerF){var columnInBitrates=3===headerB?3-headerC:3===headerC?3:4,bitRate=1e3*BitratesMap[14*columnInBitrates+headerE-1],columnInSampleRates=3===headerB?0:2===headerB?1:2,sampleRate=SamplingRateMap[3*columnInSampleRates+headerF],padding=headerG?1:0,channelCount=data[start+3]>>6===3?1:2,frameLength=3===headerC?(3===headerB?12:6)*bitRate/sampleRate+padding<<2:(3===headerB?144:72)*bitRate/sampleRate+padding|0;return start+frameLength>end?-1:(this._onMpegFrame&&this._onMpegFrame(data.subarray(start,start+frameLength),bitRate,sampleRate,channelCount,frameIndex,pts),frameLength)}}for(var offset=start+2;offset<end;){if(255===data[offset-1]&&224===(224&data[offset]))return this._onMpegNoise&&this._onMpegNoise(data.subarray(start,offset-1)),offset-start-1;offset++}return-1}},{key:"_parseID3PES",value:function(pes){this._id3Track.samples.push(pes)}}],[{key:"probe",value:function(data){return data.length>=564&&71===data[0]&&71===data[188]&&71===data[376]}}]),TSDemuxer}();exports.default=TSDemuxer},{"../errors":26,"../events":28,"../utils/logger":45,"./adts":19,"./exp-golomb":23}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.ErrorTypes={NETWORK_ERROR:"networkError",MEDIA_ERROR:"mediaError",MUX_ERROR:"muxError",OTHER_ERROR:"otherError"},exports.ErrorDetails={MANIFEST_LOAD_ERROR:"manifestLoadError",MANIFEST_LOAD_TIMEOUT:"manifestLoadTimeOut",MANIFEST_PARSING_ERROR:"manifestParsingError",MANIFEST_INCOMPATIBLE_CODECS_ERROR:"manifestIncompatibleCodecsError",LEVEL_LOAD_ERROR:"levelLoadError",LEVEL_LOAD_TIMEOUT:"levelLoadTimeOut",LEVEL_SWITCH_ERROR:"levelSwitchError",AUDIO_TRACK_LOAD_ERROR:"audioTrackLoadError",AUDIO_TRACK_LOAD_TIMEOUT:"audioTrackLoadTimeOut",FRAG_LOAD_ERROR:"fragLoadError",FRAG_LOOP_LOADING_ERROR:"fragLoopLoadingError",FRAG_LOAD_TIMEOUT:"fragLoadTimeOut",FRAG_DECRYPT_ERROR:"fragDecryptError",FRAG_PARSING_ERROR:"fragParsingError",REMUX_ALLOC_ERROR:"remuxAllocError",KEY_LOAD_ERROR:"keyLoadError",KEY_LOAD_TIMEOUT:"keyLoadTimeOut",BUFFER_ADD_CODEC_ERROR:"bufferAddCodecError",BUFFER_APPEND_ERROR:"bufferAppendError",BUFFER_APPENDING_ERROR:"bufferAppendingError",BUFFER_STALLED_ERROR:"bufferStalledError",BUFFER_FULL_ERROR:"bufferFullError",BUFFER_SEEK_OVER_HOLE:"bufferSeekOverHole",BUFFER_NUDGE_ON_STALL:"bufferNudgeOnStall",INTERNAL_EXCEPTION:"internalException"}},{}],27:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_logger=require("./utils/logger"),_errors=require("./errors"),_events=require("./events"),_events2=_interopRequireDefault(_events),EventHandler=function(){function EventHandler(hls){_classCallCheck(this,EventHandler),this.hls=hls,this.onEvent=this.onEvent.bind(this);for(var _len=arguments.length,events=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)events[_key-1]=arguments[_key];this.handledEvents=events,this.useGenericHandler=!0,this.registerListeners()}return _createClass(EventHandler,[{key:"destroy",value:function(){this.unregisterListeners()}},{key:"isEventHandler",value:function(){return"object"===_typeof(this.handledEvents)&&this.handledEvents.length&&"function"==typeof this.onEvent}},{key:"registerListeners",value:function(){this.isEventHandler()&&this.handledEvents.forEach(function(event){if("hlsEventGeneric"===event)throw new Error("Forbidden event name: "+event);this.hls.on(event,this.onEvent)}.bind(this))}},{key:"unregisterListeners",value:function(){this.isEventHandler()&&this.handledEvents.forEach(function(event){this.hls.off(event,this.onEvent)}.bind(this))}},{key:"onEvent",value:function(event,data){this.onEventGeneric(event,data)}},{key:"onEventGeneric",value:function(event,data){var eventToFunction=function(event,data){var funcName="on"+event.replace("hls","");if("function"!=typeof this[funcName])throw new Error("Event "+event+" has no generic handler in this "+this.constructor.name+" class (tried "+funcName+")");return this[funcName].bind(this,data)};try{eventToFunction.call(this,event,data).call()}catch(err){_logger.logger.error("internal error happened while processing "+event+":"+err.message),this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.OTHER_ERROR,details:_errors.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:event,err:err})}}}]),EventHandler}();exports.default=EventHandler},{"./errors":26,"./events":28,"./utils/logger":45}],28:[function(require,module,exports){"use strict";module.exports={MEDIA_ATTACHING:"hlsMediaAttaching",MEDIA_ATTACHED:"hlsMediaAttached",MEDIA_DETACHING:"hlsMediaDetaching",MEDIA_DETACHED:"hlsMediaDetached",BUFFER_RESET:"hlsBufferReset",BUFFER_CODECS:"hlsBufferCodecs",BUFFER_CREATED:"hlsBufferCreated",BUFFER_APPENDING:"hlsBufferAppending",BUFFER_APPENDED:"hlsBufferAppended",BUFFER_EOS:"hlsBufferEos",BUFFER_FLUSHING:"hlsBufferFlushing",BUFFER_FLUSHED:"hlsBufferFlushed",MANIFEST_LOADING:"hlsManifestLoading",MANIFEST_LOADED:"hlsManifestLoaded",MANIFEST_PARSED:"hlsManifestParsed",LEVEL_LOADING:"hlsLevelLoading",LEVEL_LOADED:"hlsLevelLoaded",LEVEL_UPDATED:"hlsLevelUpdated",LEVEL_PTS_UPDATED:"hlsLevelPtsUpdated",LEVEL_SWITCH:"hlsLevelSwitch",AUDIO_TRACKS_UPDATED:"hlsAudioTracksUpdated",AUDIO_TRACK_SWITCH:"hlsAudioTrackSwitch",AUDIO_TRACK_SWITCHING:"hlsAudioTrackSwitching",AUDIO_TRACK_SWITCHED:"hlsAudioTrackSwitched",AUDIO_TRACK_LOADING:"hlsAudioTrackLoading",AUDIO_TRACK_LOADED:"hlsAudioTrackLoaded",INIT_PTS_FOUND:"hlsInitPtsFound",FRAG_LOADING:"hlsFragLoading",FRAG_LOAD_PROGRESS:"hlsFragLoadProgress",FRAG_LOAD_EMERGENCY_ABORTED:"hlsFragLoadEmergencyAborted",FRAG_LOADED:"hlsFragLoaded",FRAG_DECRYPTED:"hlsFragDecrypted",FRAG_PARSING_INIT_SEGMENT:"hlsFragParsingInitSegment",FRAG_PARSING_USERDATA:"hlsFragParsingUserdata",FRAG_PARSING_METADATA:"hlsFragParsingMetadata",FRAG_PARSING_DATA:"hlsFragParsingData",FRAG_PARSED:"hlsFragParsed",FRAG_BUFFERED:"hlsFragBuffered",FRAG_CHANGED:"hlsFragChanged",FPS_DROP:"hlsFpsDrop",FPS_DROP_LEVEL_CAPPING:"hlsFpsDropLevelCapping",ERROR:"hlsError",DESTROYING:"hlsDestroying",KEY_LOADING:"hlsKeyLoading",KEY_LOADED:"hlsKeyLoaded",STREAM_STATE_TRANSITION:"hlsStreamStateTransition"}},{}],29:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),AAC=function(){function AAC(){_classCallCheck(this,AAC)}return _createClass(AAC,null,[{key:"getSilentFrame",value:function(codec,channelCount){switch(codec){case"mp4a.40.2":if(1===channelCount)return new Uint8Array([0,200,0,128,35,128]);if(2===channelCount)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===channelCount)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),AAC}();exports.default=AAC},{}],30:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BufferHelper=function(){function BufferHelper(){_classCallCheck(this,BufferHelper)}return _createClass(BufferHelper,null,[{key:"isBuffered",value:function(media,position){if(media)for(var buffered=media.buffered,i=0;i<buffered.length;i++)if(position>=buffered.start(i)&&position<=buffered.end(i))return!0;return!1}},{key:"bufferInfo",value:function(media,pos,maxHoleDuration){if(media){var i,vbuffered=media.buffered,buffered=[];for(i=0;i<vbuffered.length;i++)buffered.push({start:vbuffered.start(i),end:vbuffered.end(i)});return this.bufferedInfo(buffered,pos,maxHoleDuration)}return{len:0,start:0,end:0,nextStart:void 0}}},{key:"bufferedInfo",value:function(buffered,pos,maxHoleDuration){var bufferLen,bufferStart,bufferEnd,bufferStartNext,i,buffered2=[];for(buffered.sort(function(a,b){var diff=a.start-b.start;return diff?diff:b.end-a.end}),i=0;i<buffered.length;i++){var buf2len=buffered2.length;if(buf2len){var buf2end=buffered2[buf2len-1].end;buffered[i].start-buf2end<maxHoleDuration?buffered[i].end>buf2end&&(buffered2[buf2len-1].end=buffered[i].end):buffered2.push(buffered[i])}else buffered2.push(buffered[i])}for(i=0,bufferLen=0,bufferStart=bufferEnd=pos;i<buffered2.length;i++){var start=buffered2[i].start,end=buffered2[i].end;if(pos+maxHoleDuration>=start&&pos<end)bufferStart=start,bufferEnd=end,bufferLen=bufferEnd-pos;else if(pos+maxHoleDuration<start){bufferStartNext=start;break}}return{len:bufferLen,start:bufferStart,end:bufferEnd,nextStart:bufferStartNext}}}]),BufferHelper}();exports.default=BufferHelper},{}],31:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_logger=require("../utils/logger"),LevelHelper=function(){function LevelHelper(){_classCallCheck(this,LevelHelper)}return _createClass(LevelHelper,null,[{key:"mergeDetails",value:function(oldDetails,newDetails){var PTSFrag,start=Math.max(oldDetails.startSN,newDetails.startSN)-newDetails.startSN,end=Math.min(oldDetails.endSN,newDetails.endSN)-newDetails.startSN,delta=newDetails.startSN-oldDetails.startSN,oldfragments=oldDetails.fragments,newfragments=newDetails.fragments,ccOffset=0;if(end<start)return void(newDetails.PTSKnown=!1);for(var i=start;i<=end;i++){var oldFrag=oldfragments[delta+i],newFrag=newfragments[i];newFrag&&oldFrag&&(ccOffset=oldFrag.cc-newFrag.cc,isNaN(oldFrag.startPTS)||(newFrag.start=newFrag.startPTS=oldFrag.startPTS,newFrag.endPTS=oldFrag.endPTS,newFrag.duration=oldFrag.duration,PTSFrag=newFrag))}if(ccOffset)for(_logger.logger.log("discontinuity sliding from playlist, take drift into account"),i=0;i<newfragments.length;i++)newfragments[i].cc+=ccOffset;if(PTSFrag)LevelHelper.updateFragPTSDTS(newDetails,PTSFrag.sn,PTSFrag.startPTS,PTSFrag.endPTS,PTSFrag.startDTS,PTSFrag.endDTS);else if(delta>=0&&delta<oldfragments.length){var sliding=oldfragments[delta].start;for(i=0;i<newfragments.length;i++)newfragments[i].start+=sliding}newDetails.PTSKnown=oldDetails.PTSKnown}},{key:"updateFragPTSDTS",value:function(details,sn,startPTS,endPTS,startDTS,endDTS){var fragIdx,fragments,frag,i;if(!details||sn<details.startSN||sn>details.endSN)return 0;if(fragIdx=sn-details.startSN,fragments=details.fragments,frag=fragments[fragIdx],!isNaN(frag.startPTS)){var deltaPTS=Math.abs(frag.startPTS-startPTS);isNaN(frag.deltaPTS)?frag.deltaPTS=deltaPTS:frag.deltaPTS=Math.max(deltaPTS,frag.deltaPTS),startPTS=Math.min(startPTS,frag.startPTS),endPTS=Math.max(endPTS,frag.endPTS),startDTS=Math.min(startDTS,frag.startDTS),endDTS=Math.max(endDTS,frag.endDTS)}var drift=startPTS-frag.start;for(frag.start=frag.startPTS=startPTS,frag.endPTS=endPTS,frag.startDTS=startDTS,frag.endDTS=endDTS,frag.duration=endPTS-startPTS,i=fragIdx;i>0;i--)LevelHelper.updatePTS(fragments,i,i-1);for(i=fragIdx;i<fragments.length-1;i++)LevelHelper.updatePTS(fragments,i,i+1);return details.PTSKnown=!0,drift}},{key:"updatePTS",value:function(fragments,fromIdx,toIdx){var fragFrom=fragments[fromIdx],fragTo=fragments[toIdx],fragToPTS=fragTo.startPTS;isNaN(fragToPTS)?toIdx>fromIdx?fragTo.start=fragFrom.start+fragFrom.duration:fragTo.start=fragFrom.start-fragTo.duration:toIdx>fromIdx?(fragFrom.duration=fragToPTS-fragFrom.start,fragFrom.duration<0&&_logger.logger.warn("negative duration computed for frag "+fragFrom.sn+",level "+fragFrom.level+", there should be some duration drift between playlist and fragment!")):(fragTo.duration=fragFrom.start-fragToPTS,fragTo.duration<0&&_logger.logger.warn("negative duration computed for frag "+fragTo.sn+",level "+fragTo.level+", there should be some duration drift between playlist and fragment!"))}}]),LevelHelper}();exports.default=LevelHelper},{"../utils/logger":45}],32:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("./events"),_events2=_interopRequireDefault(_events),_errors=require("./errors"),_playlistLoader=require("./loader/playlist-loader"),_playlistLoader2=_interopRequireDefault(_playlistLoader),_fragmentLoader=require("./loader/fragment-loader"),_fragmentLoader2=_interopRequireDefault(_fragmentLoader),_abrController=require("./controller/abr-controller"),_abrController2=_interopRequireDefault(_abrController),_bufferController=require("./controller/buffer-controller"),_bufferController2=_interopRequireDefault(_bufferController),_capLevelController=require("./controller/cap-level-controller"),_capLevelController2=_interopRequireDefault(_capLevelController),_audioStreamController=require("./controller/audio-stream-controller"),_audioStreamController2=_interopRequireDefault(_audioStreamController),_streamController=require("./controller/stream-controller"),_streamController2=_interopRequireDefault(_streamController),_levelController=require("./controller/level-controller"),_levelController2=_interopRequireDefault(_levelController),_timelineController=require("./controller/timeline-controller"),_timelineController2=_interopRequireDefault(_timelineController),_fpsController=require("./controller/fps-controller"),_fpsController2=_interopRequireDefault(_fpsController),_audioTrackController=require("./controller/audio-track-controller"),_audioTrackController2=_interopRequireDefault(_audioTrackController),_logger=require("./utils/logger"),_xhrLoader=require("./utils/xhr-loader"),_xhrLoader2=_interopRequireDefault(_xhrLoader),_events3=require("events"),_events4=_interopRequireDefault(_events3),_keyLoader=require("./loader/key-loader"),_keyLoader2=_interopRequireDefault(_keyLoader),_cues=require("./utils/cues"),_cues2=_interopRequireDefault(_cues),Hls=function(){
function Hls(){var config=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Hls);var defaultConfig=Hls.DefaultConfig;if((config.liveSyncDurationCount||config.liveMaxLatencyDurationCount)&&(config.liveSyncDuration||config.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");for(var prop in defaultConfig)prop in config||(config[prop]=defaultConfig[prop]);if(void 0!==config.liveMaxLatencyDurationCount&&config.liveMaxLatencyDurationCount<=config.liveSyncDurationCount)throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be gt "liveSyncDurationCount"');if(void 0!==config.liveMaxLatencyDuration&&(config.liveMaxLatencyDuration<=config.liveSyncDuration||void 0===config.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be gt "liveSyncDuration"');(0,_logger.enableLogs)(config.debug),this.config=config;var observer=this.observer=new _events4.default;observer.trigger=function(event){for(var _len=arguments.length,data=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)data[_key-1]=arguments[_key];observer.emit.apply(observer,[event,event].concat(data))},observer.off=function(event){for(var _len2=arguments.length,data=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)data[_key2-1]=arguments[_key2];observer.removeListener.apply(observer,[event].concat(data))},this.on=observer.on.bind(observer),this.off=observer.off.bind(observer),this.trigger=observer.trigger.bind(observer),this.playlistLoader=new _playlistLoader2.default(this),this.fragmentLoader=new _fragmentLoader2.default(this),this.levelController=new _levelController2.default(this),this.abrController=new config.abrController(this),this.bufferController=new config.bufferController(this),this.capLevelController=new config.capLevelController(this),this.fpsController=new config.fpsController(this),this.streamController=new config.streamController(this),this.audioStreamController=new config.audioStreamController(this),this.timelineController=new config.timelineController(this),this.audioTrackController=new _audioTrackController2.default(this),this.keyLoader=new _keyLoader2.default(this)}return _createClass(Hls,null,[{key:"isSupported",value:function(){return window.MediaSource=window.MediaSource||window.WebKitMediaSource,window.MediaSource&&"function"==typeof window.MediaSource.isTypeSupported&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"version",get:function(){return"__VERSION__"}},{key:"Events",get:function(){return _events2.default}},{key:"ErrorTypes",get:function(){return _errors.ErrorTypes}},{key:"ErrorDetails",get:function(){return _errors.ErrorDetails}},{key:"DefaultConfig",get:function(){return Hls.defaultConfig||(Hls.defaultConfig={autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,maxBufferSize:6e7,maxBufferHole:.5,maxMaxBufferLength:600,maxSeekHole:2,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,fragLoadingLoopThreshold:3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:_xhrLoader2.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,fetchSetup:void 0,abrController:_abrController2.default,bufferController:_bufferController2.default,capLevelController:_capLevelController2.default,fpsController:_fpsController2.default,streamController:_streamController2.default,audioStreamController:_audioStreamController2.default,timelineController:_timelineController2.default,cueHandler:_cues2.default,enableCEA708Captions:!0,enableMP2TPassThrough:!1,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0}),Hls.defaultConfig},set:function(defaultConfig){Hls.defaultConfig=defaultConfig}}]),_createClass(Hls,[{key:"destroy",value:function(){_logger.logger.log("destroy"),this.trigger(_events2.default.DESTROYING),this.detachMedia(),this.playlistLoader.destroy(),this.fragmentLoader.destroy(),this.levelController.destroy(),this.abrController.destroy(),this.bufferController.destroy(),this.capLevelController.destroy(),this.fpsController.destroy(),this.streamController.destroy(),this.audioStreamController.destroy(),this.timelineController.destroy(),this.audioTrackController.destroy(),this.keyLoader.destroy(),this.url=null,this.observer.removeAllListeners()}},{key:"attachMedia",value:function(media){_logger.logger.log("attachMedia"),this.media=media,this.trigger(_events2.default.MEDIA_ATTACHING,{media:media})}},{key:"detachMedia",value:function(){_logger.logger.log("detachMedia"),this.trigger(_events2.default.MEDIA_DETACHING),this.media=null}},{key:"loadSource",value:function(url){_logger.logger.log("loadSource:"+url),this.url=url,this.trigger(_events2.default.MANIFEST_LOADING,{url:url})}},{key:"startLoad",value:function(){var startPosition=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;_logger.logger.log("startLoad("+startPosition+")"),this.levelController.startLoad(),this.streamController.startLoad(startPosition),this.audioStreamController.startLoad(startPosition)}},{key:"stopLoad",value:function(){_logger.logger.log("stopLoad"),this.levelController.stopLoad(),this.streamController.stopLoad(),this.audioStreamController.stopLoad()}},{key:"swapAudioCodec",value:function(){_logger.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}},{key:"recoverMediaError",value:function(){_logger.logger.log("recoverMediaError");var media=this.media;this.detachMedia(),this.attachMedia(media)}},{key:"levels",get:function(){return this.levelController.levels}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(newLevel){_logger.logger.log("set currentLevel:"+newLevel),this.loadLevel=newLevel,this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(newLevel){_logger.logger.log("set nextLevel:"+newLevel),this.levelController.manualLevel=newLevel,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(newLevel){_logger.logger.log("set loadLevel:"+newLevel),this.levelController.manualLevel=newLevel}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(level){this.levelController.nextLoadLevel=level}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.abrController.minAutoLevel)},set:function(newLevel){_logger.logger.log("set firstLevel:"+newLevel),this.levelController.firstLevel=newLevel}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(newLevel){_logger.logger.log("set startLevel:"+newLevel),this.levelController.startLevel=newLevel}},{key:"autoLevelCapping",get:function(){return this.abrController.autoLevelCapping},set:function(newLevel){_logger.logger.log("set autoLevelCapping:"+newLevel),this.abrController.autoLevelCapping=newLevel}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"audioTracks",get:function(){return this.audioTrackController.audioTracks}},{key:"audioTrack",get:function(){return this.audioTrackController.audioTrack},set:function(audioTrackId){this.audioTrackController.audioTrack=audioTrackId}},{key:"liveSyncPosition",get:function(){return this.streamController.liveSyncPosition}}]),Hls}();exports.default=Hls},{"./controller/abr-controller":4,"./controller/audio-stream-controller":5,"./controller/audio-track-controller":6,"./controller/buffer-controller":7,"./controller/cap-level-controller":8,"./controller/fps-controller":10,"./controller/level-controller":11,"./controller/stream-controller":12,"./controller/timeline-controller":13,"./errors":26,"./events":28,"./loader/fragment-loader":34,"./loader/key-loader":35,"./loader/playlist-loader":36,"./utils/cues":43,"./utils/logger":45,"./utils/xhr-loader":47,events:1}],33:[function(require,module,exports){"use strict";module.exports=require("./hls.js").default},{"./hls.js":32}],34:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_errors=require("../errors"),_logger=require("../utils/logger"),FragmentLoader=function(_EventHandler){function FragmentLoader(hls){_classCallCheck(this,FragmentLoader);var _this=_possibleConstructorReturn(this,(FragmentLoader.__proto__||Object.getPrototypeOf(FragmentLoader)).call(this,hls,_events2.default.FRAG_LOADING));return _this.loaders={},_this}return _inherits(FragmentLoader,_EventHandler),_createClass(FragmentLoader,[{key:"destroy",value:function(){var loaders=this.loaders;for(var loaderName in loaders){var loader=loaders[loaderName];loader&&loader.destroy()}this.loaders={},_eventHandler2.default.prototype.destroy.call(this)}},{key:"onFragLoading",value:function(data){var frag=data.frag,type=frag.type,loader=this.loaders[type],config=this.hls.config;frag.loaded=0,loader&&(_logger.logger.warn("abort previous fragment loader for type:"+type),loader.abort()),loader=this.loaders[type]=frag.loader="undefined"!=typeof config.fLoader?new config.fLoader(config):new config.loader(config);var loaderContext=void 0,loaderConfig=void 0,loaderCallbacks=void 0;loaderContext={url:frag.url,frag:frag,responseType:"arraybuffer",progressData:!1};var start=frag.byteRangeStartOffset,end=frag.byteRangeEndOffset;isNaN(start)||isNaN(end)||(loaderContext.rangeStart=start,loaderContext.rangeEnd=end),loaderConfig={timeout:config.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:config.fragLoadingMaxRetryTimeout},loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this),onProgress:this.loadprogress.bind(this)},loader.load(loaderContext,loaderConfig,loaderCallbacks)}},{key:"loadsuccess",value:function(response,stats,context){var payload=response.data,frag=context.frag;frag.loader=void 0,this.loaders[frag.type]=void 0,this.hls.trigger(_events2.default.FRAG_LOADED,{payload:payload,frag:frag,stats:stats})}},{key:"loaderror",value:function(response,context){var loader=context.loader;loader&&loader.abort(),this.loaders[context.type]=void 0,this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:context.frag,response:response})}},{key:"loadtimeout",value:function(stats,context){var loader=context.loader;loader&&loader.abort(),this.loaders[context.type]=void 0,this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:context.frag})}},{key:"loadprogress",value:function(stats,context,data){var frag=context.frag;frag.loaded=stats.loaded,this.hls.trigger(_events2.default.FRAG_LOAD_PROGRESS,{frag:frag,stats:stats})}}]),FragmentLoader}(_eventHandler2.default);exports.default=FragmentLoader},{"../errors":26,"../event-handler":27,"../events":28,"../utils/logger":45}],35:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_errors=require("../errors"),_logger=require("../utils/logger"),KeyLoader=function(_EventHandler){function KeyLoader(hls){_classCallCheck(this,KeyLoader);var _this=_possibleConstructorReturn(this,(KeyLoader.__proto__||Object.getPrototypeOf(KeyLoader)).call(this,hls,_events2.default.KEY_LOADING));return _this.loaders={},_this.decryptkey=null,_this.decrypturl=null,_this}return _inherits(KeyLoader,_EventHandler),_createClass(KeyLoader,[{key:"destroy",value:function(){for(var loaderName in this.loaders){var loader=this.loaders[loaderName];loader&&loader.destroy()}this.loaders={},_eventHandler2.default.prototype.destroy.call(this)}},{key:"onKeyLoading",value:function(data){var frag=data.frag,type=frag.type,loader=this.loaders[type],decryptdata=frag.decryptdata,uri=decryptdata.uri;if(uri!==this.decrypturl||null===this.decryptkey){var config=this.hls.config;loader&&(_logger.logger.warn("abort previous key loader for type:"+type),loader.abort()),frag.loader=this.loaders[type]=new config.loader(config),this.decrypturl=uri,this.decryptkey=null;var loaderContext=void 0,loaderConfig=void 0,loaderCallbacks=void 0;loaderContext={url:uri,frag:frag,responseType:"arraybuffer"},loaderConfig={timeout:config.fragLoadingTimeOut,maxRetry:config.fragLoadingMaxRetry,retryDelay:config.fragLoadingRetryDelay,maxRetryDelay:config.fragLoadingMaxRetryTimeout},loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)},frag.loader.load(loaderContext,loaderConfig,loaderCallbacks)}else this.decryptkey&&(decryptdata.key=this.decryptkey,this.hls.trigger(_events2.default.KEY_LOADED,{frag:frag}))}},{key:"loadsuccess",value:function(response,stats,context){var frag=context.frag;this.decryptkey=frag.decryptdata.key=new Uint8Array(response.data),frag.loader=void 0,this.loaders[frag.type]=void 0,this.hls.trigger(_events2.default.KEY_LOADED,{frag:frag})}},{key:"loaderror",value:function(response,context){var frag=context.frag,loader=frag.loader;loader&&loader.abort(),this.loaders[context.type]=void 0,this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:frag,response:response})}},{key:"loadtimeout",value:function(stats,context){var frag=context.frag,loader=frag.loader;loader&&loader.abort(),this.loaders[context.type]=void 0,this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:frag})}}]),KeyLoader}(_eventHandler2.default);exports.default=KeyLoader},{"../errors":26,"../event-handler":27,"../events":28,"../utils/logger":45}],36:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_urlToolkit=require("url-toolkit"),_urlToolkit2=_interopRequireDefault(_urlToolkit),_events=require("../events"),_events2=_interopRequireDefault(_events),_eventHandler=require("../event-handler"),_eventHandler2=_interopRequireDefault(_eventHandler),_errors=require("../errors"),_attrList=require("../utils/attr-list"),_attrList2=_interopRequireDefault(_attrList),_logger=require("../utils/logger"),MASTER_PLAYLIST_REGEX=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,MASTER_PLAYLIST_MEDIA_REGEX=/#EXT-X-MEDIA:(.*)/g,LEVEL_PLAYLIST_REGEX_FAST=/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE: *(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#.*/g,LEVEL_PLAYLIST_REGEX_SLOW=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:(#)(.*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,LevelKey=function(){function LevelKey(){_classCallCheck(this,LevelKey),this.method=null,this.key=null,this.iv=null,this._uri=null}return _createClass(LevelKey,[{key:"uri",get:function(){return!this._uri&&this.reluri&&(this._uri=_urlToolkit2.default.buildAbsoluteURL(this.baseuri,this.reluri)),this._uri}}]),LevelKey}(),Fragment=function(){function Fragment(){_classCallCheck(this,Fragment),this._url=null,this._byteRange=null,this._decryptdata=null}return _createClass(Fragment,[{key:"createInitializationVector",value:function(segmentNumber){for(var uint8View=new Uint8Array(16),i=12;i<16;i++)uint8View[i]=segmentNumber>>8*(15-i)&255;return uint8View}},{key:"fragmentDecryptdataFromLevelkey",value:function(levelkey,segmentNumber){var decryptdata=levelkey;return levelkey&&levelkey.method&&levelkey.uri&&!levelkey.iv&&(decryptdata=new LevelKey,decryptdata.method=levelkey.method,decryptdata.baseuri=levelkey.baseuri,decryptdata.reluri=levelkey.reluri,decryptdata.iv=this.createInitializationVector(segmentNumber)),decryptdata}},{key:"cloneObj",value:function(obj){return JSON.parse(JSON.stringify(obj))}},{key:"url",get:function(){return!this._url&&this.relurl&&(this._url=_urlToolkit2.default.buildAbsoluteURL(this.baseurl,this.relurl)),this._url},set:function(value){this._url=value}},{key:"programDateTime",get:function(){return!this._programDateTime&&this.rawProgramDateTime&&(this._programDateTime=new Date(Date.parse(this.rawProgramDateTime))),this._programDateTime}},{key:"byteRange",get:function(){if(!this._byteRange){var byteRange=this._byteRange=[];if(this.rawByteRange){var params=this.rawByteRange.split("@",2);if(1===params.length){var lastByteRangeEndOffset=this.lastByteRangeEndOffset;byteRange[0]=lastByteRangeEndOffset?lastByteRangeEndOffset:0}else byteRange[0]=parseInt(params[1]);byteRange[1]=parseInt(params[0])+byteRange[0]}}return this._byteRange}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"decryptdata",get:function(){return this._decryptdata||(this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn)),this._decryptdata}}]),Fragment}(),PlaylistLoader=function(_EventHandler){function PlaylistLoader(hls){_classCallCheck(this,PlaylistLoader);var _this=_possibleConstructorReturn(this,(PlaylistLoader.__proto__||Object.getPrototypeOf(PlaylistLoader)).call(this,hls,_events2.default.MANIFEST_LOADING,_events2.default.LEVEL_LOADING,_events2.default.AUDIO_TRACK_LOADING));return _this.loaders={},_this}return _inherits(PlaylistLoader,_EventHandler),_createClass(PlaylistLoader,[{key:"destroy",value:function(){for(var loaderName in this.loaders){var loader=this.loaders[loaderName];loader&&loader.destroy()}this.loaders={},_eventHandler2.default.prototype.destroy.call(this)}},{key:"onManifestLoading",value:function(data){this.load(data.url,{type:"manifest"})}},{key:"onLevelLoading",value:function(data){this.load(data.url,{type:"level",level:data.level,id:data.id})}},{key:"onAudioTrackLoading",value:function(data){this.load(data.url,{type:"audioTrack",id:data.id})}},{key:"load",value:function(url,context){var loader=this.loaders[context.type];if(loader){var loaderContext=loader.context;if(loaderContext&&loaderContext.url===url)return void _logger.logger.trace("playlist request ongoing");_logger.logger.warn("abort previous loader for type:"+context.type),loader.abort()}var config=this.hls.config,retry=void 0,timeout=void 0,retryDelay=void 0,maxRetryDelay=void 0;"manifest"===context.type?(retry=config.manifestLoadingMaxRetry,timeout=config.manifestLoadingTimeOut,retryDelay=config.manifestLoadingRetryDelay,maxRetryDelay=config.manifestLoadingMaxRetryTimeout):(retry=config.levelLoadingMaxRetry,timeout=config.levelLoadingTimeOut,retryDelay=config.levelLoadingRetryDelay,maxRetryDelay=config.levelLoadingMaxRetryTimeout,_logger.logger.log("loading playlist for "+context.type+" "+(context.level||context.id))),loader=this.loaders[context.type]=context.loader="undefined"!=typeof config.pLoader?new config.pLoader(config):new config.loader(config),context.url=url,context.responseType="";var loaderConfig=void 0,loaderCallbacks=void 0;loaderConfig={timeout:timeout,maxRetry:retry,retryDelay:retryDelay,maxRetryDelay:maxRetryDelay},loaderCallbacks={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)},loader.load(context,loaderConfig,loaderCallbacks)}},{key:"resolve",value:function(url,baseUrl){return _urlToolkit2.default.buildAbsoluteURL(baseUrl,url)}},{key:"parseMasterPlaylist",value:function(string,baseurl){var levels=[],result=void 0;for(MASTER_PLAYLIST_REGEX.lastIndex=0;null!=(result=MASTER_PLAYLIST_REGEX.exec(string));){var level={},attrs=level.attrs=new _attrList2.default(result[1]);level.url=this.resolve(result[2],baseurl);var resolution=attrs.decimalResolution("RESOLUTION");resolution&&(level.width=resolution.width,level.height=resolution.height),level.bitrate=attrs.decimalInteger("AVERAGE-BANDWIDTH")||attrs.decimalInteger("BANDWIDTH"),level.name=attrs.NAME;var codecs=attrs.CODECS;if(codecs){codecs=codecs.split(/[ ,]+/);for(var i=0;i<codecs.length;i++){var codec=codecs[i];codec.indexOf("avc1")!==-1?level.videoCodec=this.avc1toavcoti(codec):level.audioCodec=codec}}levels.push(level)}return levels}},{key:"parseMasterPlaylistMedia",value:function(string,baseurl,type){var result=void 0,medias=[];for(MASTER_PLAYLIST_MEDIA_REGEX.lastIndex=0;null!=(result=MASTER_PLAYLIST_MEDIA_REGEX.exec(string));){var media={},attrs=new _attrList2.default(result[1]);attrs.TYPE===type&&(media.groupId=attrs["GROUP-ID"],media.name=attrs.NAME,media.type=type,media.default="YES"===attrs.DEFAULT,media.autoselect="YES"===attrs.AUTOSELECT,media.forced="YES"===attrs.FORCED,attrs.URI&&(media.url=this.resolve(attrs.URI,baseurl)),media.lang=attrs.LANGUAGE,media.name||(media.name=media.lang),medias.push(media))}return medias}},{key:"avc1toavcoti",value:function(codec){var result,avcdata=codec.split(".");return avcdata.length>2?(result=avcdata.shift()+".",result+=parseInt(avcdata.shift()).toString(16),result+=("000"+parseInt(avcdata.shift()).toString(16)).substr(-4)):result=codec,result}},{key:"parseLevelPlaylist",value:function(string,baseurl,id,type){var result,i,currentSN=0,totalduration=0,level={type:null,version:null,url:baseurl,fragments:[],live:!0,startSN:0},levelkey=new LevelKey,cc=0,prevFrag=null,frag=new Fragment;for(frag.tagList=[],LEVEL_PLAYLIST_REGEX_FAST.lastIndex=0;null!==(result=LEVEL_PLAYLIST_REGEX_FAST.exec(string));){var duration=result[1];if(duration){frag.duration=parseFloat(duration);var title=(" "+result[2]).slice(1);frag.title=title?title:null,frag.tagList.push(title?["INF",duration,title]:["INF",duration])}else if(result[3]){if(!isNaN(frag.duration)){var sn=currentSN++;frag.type=type,frag.start=totalduration,frag.levelkey=levelkey,frag.sn=sn,frag.level=id,frag.cc=cc,frag.baseurl=baseurl,frag.relurl=(" "+result[3]).slice(1),level.fragments.push(frag),prevFrag=frag,totalduration+=frag.duration,frag=new Fragment,frag.tagList=[]}}else if(result[4]){if(frag.rawByteRange=(" "+result[4]).slice(1),prevFrag){var lastByteRangeEndOffset=prevFrag.byteRangeEndOffset;lastByteRangeEndOffset&&(frag.lastByteRangeEndOffset=lastByteRangeEndOffset)}}else if(result[5])frag.rawProgramDateTime=(" "+result[5]).slice(1),frag.tagList.push(["PROGRAM-DATE-TIME",frag.rawProgramDateTime]);else{for(result=result[0].match(LEVEL_PLAYLIST_REGEX_SLOW),i=1;i<result.length&&void 0===result[i];i++);var value1=(" "+result[i+1]).slice(1),value2=(" "+result[i+2]).slice(1);switch(result[i]){case"#":frag.tagList.push(value2?[value1,value2]:[value1]);break;case"PLAYLIST-TYPE":level.type=value1.toUpperCase();break;case"MEDIA-SEQUENCE":currentSN=level.startSN=parseInt(value1);break;case"TARGETDURATION":level.targetduration=parseFloat(value1);break;case"VERSION":level.version=parseInt(value1);break;case"EXTM3U":break;case"ENDLIST":level.live=!1;break;case"DIS":cc++,frag.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":cc=parseInt(value1);break;case"KEY":var decryptparams=value1,keyAttrs=new _attrList2.default(decryptparams),decryptmethod=keyAttrs.enumeratedString("METHOD"),decrypturi=keyAttrs.URI,decryptiv=keyAttrs.hexadecimalInteger("IV");decryptmethod&&(levelkey=new LevelKey,decrypturi&&"AES-128"===decryptmethod&&(levelkey.method=decryptmethod,levelkey.baseuri=baseurl,levelkey.reluri=decrypturi,levelkey.key=null,levelkey.iv=decryptiv));break;case"START":var startParams=value1,startAttrs=new _attrList2.default(startParams),startTimeOffset=startAttrs.decimalFloatingPoint("TIME-OFFSET");isNaN(startTimeOffset)||(level.startTimeOffset=startTimeOffset);break;default:_logger.logger.warn("line parsed but not handled: "+result)}}}return frag=prevFrag,frag&&!frag.relurl&&(level.fragments.pop(),totalduration-=frag.duration),level.totalduration=totalduration,level.averagetargetduration=totalduration/level.fragments.length,level.endSN=currentSN-1,level}},{key:"loadsuccess",value:function(response,stats,context){var string=response.data,url=response.url,type=context.type,id=context.id,level=context.level,hls=this.hls;if(this.loaders[type]=void 0,void 0!==url&&0!==url.indexOf("data:")||(url=context.url),stats.tload=performance.now(),0===string.indexOf("#EXTM3U"))if(string.indexOf("#EXTINF:")>0){var isLevel="audioTrack"!==type,levelDetails=this.parseLevelPlaylist(string,url,(isLevel?level:id)||0,isLevel?"main":"audio");"manifest"===type&&hls.trigger(_events2.default.MANIFEST_LOADED,{levels:[{url:url,details:levelDetails}],audioTracks:[],url:url,stats:stats}),stats.tparsed=performance.now(),levelDetails.targetduration?isLevel?hls.trigger(_events2.default.LEVEL_LOADED,{details:levelDetails,level:level||0,id:id||0,stats:stats}):hls.trigger(_events2.default.AUDIO_TRACK_LOADED,{details:levelDetails,id:id,stats:stats}):hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:!0,url:url,reason:"invalid targetduration"})}else{var levels=this.parseMasterPlaylist(string,url);if(levels.length){var audiotracks=this.parseMasterPlaylistMedia(string,url,"AUDIO");if(audiotracks.length){var embeddedAudioFound=!1;audiotracks.forEach(function(audioTrack){audioTrack.url||(embeddedAudioFound=!0)}),embeddedAudioFound===!1&&levels[0].audioCodec&&!levels[0].attrs.AUDIO&&(_logger.logger.log("audio codec signaled in quality level, but no embedded audio track signaled, create one"),audiotracks.unshift({type:"main",name:"main"}))}hls.trigger(_events2.default.MANIFEST_LOADED,{levels:levels,audioTracks:audiotracks,url:url,stats:stats})}else hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:!0,url:url,reason:"no level found in manifest"})}else hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:_errors.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:!0,url:url,reason:"no EXTM3U delimiter"})}},{key:"loaderror",value:function(response,context){var details,fatal,loader=context.loader;switch(context.type){case"manifest":details=_errors.ErrorDetails.MANIFEST_LOAD_ERROR,fatal=!0;break;case"level":details=_errors.ErrorDetails.LEVEL_LOAD_ERROR,fatal=!1;break;case"audioTrack":details=_errors.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal=!1}loader&&(loader.abort(),this.loaders[context.type]=void 0),this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:details,fatal:fatal,url:loader.url,loader:loader,response:response,context:context})}},{key:"loadtimeout",value:function(stats,context){var details,fatal,loader=context.loader;switch(context.type){case"manifest":details=_errors.ErrorDetails.MANIFEST_LOAD_TIMEOUT,
fatal=!0;break;case"level":details=_errors.ErrorDetails.LEVEL_LOAD_TIMEOUT,fatal=!1;break;case"audioTrack":details=_errors.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT,fatal=!1}loader&&(loader.abort(),this.loaders[context.type]=void 0),this.hls.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.NETWORK_ERROR,details:details,fatal:fatal,url:loader.url,loader:loader,context:context})}}]),PlaylistLoader}(_eventHandler2.default);exports.default=PlaylistLoader},{"../errors":26,"../event-handler":27,"../events":28,"../utils/attr-list":40,"../utils/logger":45,"url-toolkit":2}],37:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MP4=function(){function MP4(){_classCallCheck(this,MP4)}return _createClass(MP4,null,[{key:"init",value:function(){MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var i;for(i in MP4.types)MP4.types.hasOwnProperty(i)&&(MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);var videoHdlr=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audioHdlr=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:videoHdlr,audio:audioHdlr};var dref=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),stco=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=stco,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var majorBrand=new Uint8Array([105,115,111,109]),avc1Brand=new Uint8Array([97,118,99,49]),minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref))}},{key:"box",value:function(type){for(var result,payload=Array.prototype.slice.call(arguments,1),size=8,i=payload.length,len=i;i--;)size+=payload[i].byteLength;for(result=new Uint8Array(size),result[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;i++)result.set(payload[i],size),size+=payload[i].byteLength;return result}},{key:"hdlr",value:function(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type])}},{key:"mdat",value:function(data){return MP4.box(MP4.types.mdat,data)}},{key:"mdhd",value:function(timescale,duration){return duration*=timescale,MP4.box(MP4.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,duration>>24,duration>>16&255,duration>>8&255,255&duration,85,196,0,0]))}},{key:"mdia",value:function(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track))}},{key:"mfhd",value:function(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,sequenceNumber>>24,sequenceNumber>>16&255,sequenceNumber>>8&255,255&sequenceNumber]))}},{key:"minf",value:function(track){return"audio"===track.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track))}},{key:"moof",value:function(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime))}},{key:"moov",value:function(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trak(tracks[i]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(tracks[0].timescale,tracks[0].duration)].concat(boxes).concat(MP4.mvex(tracks)))}},{key:"mvex",value:function(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=MP4.trex(tracks[i]);return MP4.box.apply(null,[MP4.types.mvex].concat(boxes))}},{key:"mvhd",value:function(timescale,duration){duration*=timescale;var bytes=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,duration>>24&255,duration>>16&255,duration>>8&255,255&duration,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,bytes)}},{key:"sdtp",value:function(track){var flags,i,samples=track.samples||[],bytes=new Uint8Array(4+samples.length);for(i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return MP4.box(MP4.types.sdtp,bytes)}},{key:"stbl",value:function(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}},{key:"avc1",value:function(track){var i,data,len,sps=[],pps=[];for(i=0;i<track.sps.length;i++)data=track.sps[i],len=data.byteLength,sps.push(len>>>8&255),sps.push(255&len),sps=sps.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)data=track.pps[i],len=data.byteLength,pps.push(len>>>8&255),pps.push(255&len),pps=pps.concat(Array.prototype.slice.call(data));var avcc=MP4.box(MP4.types.avcC,new Uint8Array([1,sps[3],sps[4],sps[5],255,224|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height,hSpacing=track.pixelRatio[0],vSpacing=track.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,width>>8&255,255&width,height>>8&255,255&height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([hSpacing>>24,hSpacing>>16&255,hSpacing>>8&255,255&hSpacing,vSpacing>>24,vSpacing>>16&255,vSpacing>>8&255,255&vSpacing])))}},{key:"esds",value:function(track){var configlen=track.config.length;return new Uint8Array([0,0,0,0,3,23+configlen,0,1,0,4,15+configlen,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([configlen]).concat(track.config).concat([6,1,2]))}},{key:"mp4a",value:function(track){var audiosamplerate=track.audiosamplerate;return MP4.box(MP4.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,audiosamplerate>>8&255,255&audiosamplerate,0,0]),MP4.box(MP4.types.esds,MP4.esds(track)))}},{key:"mp3",value:function(track){var audiosamplerate=track.audiosamplerate;return MP4.box(MP4.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,audiosamplerate>>8&255,255&audiosamplerate,0,0]))}},{key:"stsd",value:function(track){return"audio"===track.type?track.isAAC||"mp3"!==track.codec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track))}},{key:"tkhd",value:function(track){var id=track.id,duration=track.duration*track.timescale,width=track.width,height=track.height;return MP4.box(MP4.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,id>>24&255,id>>16&255,id>>8&255,255&id,0,0,0,0,duration>>24,duration>>16&255,duration>>8&255,255&duration,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,width>>8&255,255&width,0,0,height>>8&255,255&height,0,0]))}},{key:"traf",value:function(track,baseMediaDecodeTime){var sampleDependencyTable=MP4.sdtp(track),id=track.id;return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id])),MP4.box(MP4.types.tfdt,new Uint8Array([0,0,0,0,baseMediaDecodeTime>>24,baseMediaDecodeTime>>16&255,baseMediaDecodeTime>>8&255,255&baseMediaDecodeTime])),MP4.trun(track,sampleDependencyTable.length+16+16+8+16+8+8),sampleDependencyTable)}},{key:"trak",value:function(track){return track.duration=track.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track))}},{key:"trex",value:function(track){var id=track.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(track,offset){var i,sample,duration,size,flags,cts,samples=track.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen);for(offset+=8+arraylen,array.set([0,0,15,1,len>>>24&255,len>>>16&255,len>>>8&255,255&len,offset>>>24&255,offset>>>16&255,offset>>>8&255,255&offset],0),i=0;i<len;i++)sample=samples[i],duration=sample.duration,size=sample.size,flags=sample.flags,cts=sample.cts,array.set([duration>>>24&255,duration>>>16&255,duration>>>8&255,255&duration,size>>>24&255,size>>>16&255,size>>>8&255,255&size,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,61440&flags.degradPrio,15&flags.degradPrio,cts>>>24&255,cts>>>16&255,cts>>>8&255,255&cts],12+16*i);return MP4.box(MP4.types.trun,array)}},{key:"initSegment",value:function(tracks){MP4.types||MP4.init();var result,movie=MP4.moov(tracks);return result=new Uint8Array(MP4.FTYP.byteLength+movie.byteLength),result.set(MP4.FTYP),result.set(movie,MP4.FTYP.byteLength),result}}]),MP4}();exports.default=MP4},{}],38:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_aac=require("../helper/aac"),_aac2=_interopRequireDefault(_aac),_events=require("../events"),_events2=_interopRequireDefault(_events),_logger=require("../utils/logger"),_mp4Generator=require("../remux/mp4-generator"),_mp4Generator2=_interopRequireDefault(_mp4Generator),_errors=require("../errors"),MP4Remuxer=function(){function MP4Remuxer(observer,id,config,typeSupported){_classCallCheck(this,MP4Remuxer),this.observer=observer,this.id=id,this.config=config,this.typeSupported=typeSupported,this.ISGenerated=!1,this.PES2MP4SCALEFACTOR=4,this.PES_TIMESCALE=9e4,this.MP4_TIMESCALE=this.PES_TIMESCALE/this.PES2MP4SCALEFACTOR}return _createClass(MP4Remuxer,[{key:"destroy",value:function(){}},{key:"insertDiscontinuity",value:function(){this._initPTS=this._initDTS=void 0}},{key:"switchLevel",value:function(){this.ISGenerated=!1}},{key:"remux",value:function(level,sn,cc,audioTrack,videoTrack,id3Track,textTrack,timeOffset,contiguous,accurateTimeOffset,defaultInitPTS){if(this.level=level,this.sn=sn,this.ISGenerated||this.generateIS(audioTrack,videoTrack,timeOffset,cc),null!==defaultInitPTS&&(this._initPTS=this._initDTS=defaultInitPTS),this.ISGenerated)if(audioTrack.samples.length){var audioData=this.remuxAudio(audioTrack,timeOffset,contiguous,accurateTimeOffset);if(videoTrack.samples.length){var audioTrackLength=void 0;audioData&&(audioTrackLength=audioData.endPTS-audioData.startPTS),this.remuxVideo(videoTrack,timeOffset,contiguous,audioTrackLength)}}else{var videoData=void 0;videoTrack.samples.length&&(videoData=this.remuxVideo(videoTrack,timeOffset,contiguous)),videoData&&audioTrack.codec&&this.remuxEmptyAudio(audioTrack,timeOffset,contiguous,videoData)}id3Track.samples.length&&this.remuxID3(id3Track,timeOffset),textTrack.samples.length&&this.remuxText(textTrack,timeOffset),this.observer.trigger(_events2.default.FRAG_PARSED,{id:this.id,level:this.level,sn:this.sn})}},{key:"generateIS",value:function(audioTrack,videoTrack,timeOffset,cc){var initPTS,initDTS,observer=this.observer,audioSamples=audioTrack.samples,videoSamples=videoTrack.samples,pesTimeScale=this.PES_TIMESCALE,typeSupported=this.typeSupported,container="audio/mp4",tracks={},data={id:this.id,level:this.level,sn:this.sn,tracks:tracks,unique:!1},computePTSDTS=void 0===this._initPTS;computePTSDTS&&(initPTS=initDTS=1/0),audioTrack.config&&audioSamples.length&&(audioTrack.timescale=audioTrack.audiosamplerate,audioTrack.timescale*audioTrack.duration>Math.pow(2,32)&&!function(){var greatestCommonDivisor=function greatestCommonDivisor(a,b){return b?greatestCommonDivisor(b,a%b):a};audioTrack.timescale=audioTrack.audiosamplerate/greatestCommonDivisor(audioTrack.audiosamplerate,audioTrack.isAAC?1024:1152)}(),_logger.logger.log("audio mp4 timescale :"+audioTrack.timescale),audioTrack.isAAC||(typeSupported.mpeg?(container="audio/mpeg",audioTrack.codec=""):typeSupported.mp3&&(audioTrack.codec="mp3")),tracks.audio={container:container,codec:audioTrack.codec,initSegment:!audioTrack.isAAC&&typeSupported.mpeg?new Uint8Array:_mp4Generator2.default.initSegment([audioTrack]),metadata:{channelCount:audioTrack.channelCount}},computePTSDTS&&(initPTS=initDTS=audioSamples[0].pts-pesTimeScale*timeOffset)),videoTrack.sps&&videoTrack.pps&&videoSamples.length&&(videoTrack.timescale=this.MP4_TIMESCALE,tracks.video={container:"video/mp4",codec:videoTrack.codec,initSegment:_mp4Generator2.default.initSegment([videoTrack]),metadata:{width:videoTrack.width,height:videoTrack.height}},computePTSDTS&&(initPTS=Math.min(initPTS,videoSamples[0].pts-pesTimeScale*timeOffset),initDTS=Math.min(initDTS,videoSamples[0].dts-pesTimeScale*timeOffset),this.observer.trigger(_events2.default.INIT_PTS_FOUND,{id:this.id,initPTS:initPTS,cc:cc}))),Object.keys(tracks).length?(observer.trigger(_events2.default.FRAG_PARSING_INIT_SEGMENT,data),this.ISGenerated=!0,computePTSDTS&&(this._initPTS=initPTS,this._initDTS=initDTS)):observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MEDIA_ERROR,id:this.id,details:_errors.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"})}},{key:"remuxVideo",value:function(track,timeOffset,contiguous,audioTrackLength){var mp4SampleDuration,mdat,moof,firstPTS,firstDTS,nextDTS,lastPTS,lastDTS,offset=8,pesTimeScale=this.PES_TIMESCALE,pes2mp4ScaleFactor=this.PES2MP4SCALEFACTOR,inputSamples=track.samples,outputSamples=[],nbSamples=inputSamples.length,ptsNormalize=this._PTSNormalize,initDTS=this._initDTS;inputSamples.sort(function(a,b){var deltadts=a.dts-b.dts;return deltadts?deltadts:a.pts-b.pts});var PTSDTSshift=inputSamples.reduce(function(prev,curr){return Math.max(Math.min(prev,curr.pts-curr.dts),-18e3)},0);if(PTSDTSshift<0){_logger.logger.warn("PTS < DTS detected in video samples, shifting DTS by "+Math.round(PTSDTSshift/90)+" ms to overcome this issue");for(var i=0;i<inputSamples.length;i++)inputSamples[i].dts+=PTSDTSshift}var nextAvcDts=void 0;nextAvcDts=contiguous?this.nextAvcDts:timeOffset*pesTimeScale;var sample=inputSamples[0];firstDTS=Math.max(ptsNormalize(sample.dts-initDTS,nextAvcDts),0),firstPTS=Math.max(ptsNormalize(sample.pts-initDTS,nextAvcDts),0);var delta=Math.round((firstDTS-nextAvcDts)/90);contiguous&&delta&&(delta>1?_logger.logger.log("AVC:"+delta+" ms hole between fragments detected,filling it"):delta<-1&&_logger.logger.log("AVC:"+-delta+" ms overlapping between fragments detected"),firstDTS=nextAvcDts,inputSamples[0].dts=firstDTS+initDTS,firstPTS=Math.max(firstPTS-delta,nextAvcDts),inputSamples[0].pts=firstPTS+initDTS,_logger.logger.log("Video/PTS/DTS adjusted: "+Math.round(firstPTS/90)+"/"+Math.round(firstDTS/90)+",delta:"+delta+" ms")),nextDTS=firstDTS,sample=inputSamples[inputSamples.length-1],lastDTS=Math.max(ptsNormalize(sample.dts-initDTS,nextAvcDts),0),lastPTS=Math.max(ptsNormalize(sample.pts-initDTS,nextAvcDts),0),lastPTS=Math.max(lastPTS,lastDTS);var vendor=navigator.vendor,userAgent=navigator.userAgent,isSafari=vendor&&vendor.indexOf("Apple")>-1&&userAgent&&!userAgent.match("CriOS");isSafari&&(mp4SampleDuration=Math.round((lastDTS-firstDTS)/(pes2mp4ScaleFactor*(inputSamples.length-1))));for(var _i=0;_i<nbSamples;_i++){var _sample=inputSamples[_i];isSafari?_sample.dts=firstDTS+_i*pes2mp4ScaleFactor*mp4SampleDuration:(_sample.dts=Math.max(ptsNormalize(_sample.dts-initDTS,nextAvcDts),firstDTS),_sample.dts=Math.round(_sample.dts/pes2mp4ScaleFactor)*pes2mp4ScaleFactor),_sample.pts=Math.max(ptsNormalize(_sample.pts-initDTS,nextAvcDts),_sample.dts),_sample.pts=Math.round(_sample.pts/pes2mp4ScaleFactor)*pes2mp4ScaleFactor}var mdatSize=track.len+4*track.nbNalu+8;try{mdat=new Uint8Array(mdatSize)}catch(err){return void this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MUX_ERROR,level:this.level,id:this.id,details:_errors.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:mdatSize,reason:"fail allocating video mdat "+mdatSize})}var view=new DataView(mdat.buffer);view.setUint32(0,mdatSize),mdat.set(_mp4Generator2.default.types.mdat,4);for(var _i2=0;_i2<nbSamples;_i2++){for(var avcSample=inputSamples[_i2],avcSampleUnits=avcSample.units.units,mp4SampleLength=0,compositionTimeOffset=void 0,j=0,nbUnits=avcSampleUnits.length;j<nbUnits;j++){var unit=avcSampleUnits[j],unitData=unit.data,unitDataLen=unit.data.byteLength;view.setUint32(offset,unitDataLen),offset+=4,mdat.set(unitData,offset),offset+=unitDataLen,mp4SampleLength+=4+unitDataLen}if(isSafari)compositionTimeOffset=Math.max(0,mp4SampleDuration*Math.round((avcSample.pts-avcSample.dts)/(pes2mp4ScaleFactor*mp4SampleDuration)));else{if(_i2<nbSamples-1)mp4SampleDuration=inputSamples[_i2+1].dts-avcSample.dts;else{var config=this.config,lastFrameDuration=avcSample.dts-inputSamples[_i2>0?_i2-1:_i2].dts;if(config.stretchShortVideoTrack){var maxBufferHole=config.maxBufferHole,maxSeekHole=config.maxSeekHole,gapTolerance=Math.floor(Math.min(maxBufferHole,maxSeekHole)*pesTimeScale),deltaToFrameEnd=(audioTrackLength?firstPTS+audioTrackLength*pesTimeScale:this.nextAudioPts)-avcSample.pts;deltaToFrameEnd>gapTolerance?(mp4SampleDuration=deltaToFrameEnd-lastFrameDuration,mp4SampleDuration<0&&(mp4SampleDuration=lastFrameDuration),_logger.logger.log("It is approximately "+deltaToFrameEnd/90+" ms to the next segment; using duration "+mp4SampleDuration/90+" ms for the last video frame.")):mp4SampleDuration=lastFrameDuration}else mp4SampleDuration=lastFrameDuration}mp4SampleDuration/=pes2mp4ScaleFactor,compositionTimeOffset=Math.round((avcSample.pts-avcSample.dts)/pes2mp4ScaleFactor)}outputSamples.push({size:mp4SampleLength,duration:mp4SampleDuration,cts:compositionTimeOffset,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:avcSample.key?2:1,isNonSync:avcSample.key?0:1}})}this.nextAvcDts=lastDTS+mp4SampleDuration*pes2mp4ScaleFactor;var dropped=track.dropped;if(track.len=0,track.nbNalu=0,track.dropped=0,outputSamples.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var flags=outputSamples[0].flags;flags.dependsOn=2,flags.isNonSync=0}track.samples=outputSamples,moof=_mp4Generator2.default.moof(track.sequenceNumber++,firstDTS/pes2mp4ScaleFactor,track),track.samples=[];var data={id:this.id,level:this.level,sn:this.sn,data1:moof,data2:mdat,startPTS:firstPTS/pesTimeScale,endPTS:(lastPTS+pes2mp4ScaleFactor*mp4SampleDuration)/pesTimeScale,startDTS:firstDTS/pesTimeScale,endDTS:this.nextAvcDts/pesTimeScale,type:"video",nb:outputSamples.length,dropped:dropped};return this.observer.trigger(_events2.default.FRAG_PARSING_DATA,data),data}},{key:"remuxAudio",value:function(track,timeOffset,contiguous,accurateTimeOffset){var view,audioSample,mp4Sample,unit,mdat,moof,firstPTS,firstDTS,lastDTS,pts,dts,ptsnorm,dtsnorm,fillFrame,newStamp,nextAudioPts,pesTimeScale=this.PES_TIMESCALE,mp4timeScale=track.timescale,pes2mp4ScaleFactor=pesTimeScale/mp4timeScale,expectedSampleDuration=track.timescale*(track.isAAC?1024:1152)/track.audiosamplerate,pesFrameDuration=expectedSampleDuration*pes2mp4ScaleFactor,ptsNormalize=this._PTSNormalize,initDTS=this._initDTS,rawMPEG=!track.isAAC&&this.typeSupported.mpeg,offset=rawMPEG?0:8,outputSamples=[],inputSamples=[];if(track.samples.sort(function(a,b){return a.pts-b.pts}),inputSamples=track.samples,nextAudioPts=this.nextAudioPts,contiguous|=inputSamples.length&&nextAudioPts&&(Math.abs(timeOffset-nextAudioPts/pesTimeScale)<.1||Math.abs(inputSamples[0].pts-nextAudioPts-this._initDTS)<20*pesFrameDuration),contiguous||(nextAudioPts=timeOffset*pesTimeScale),accurateTimeOffset&&track.isAAC)for(var i=0,nextPtsNorm=nextAudioPts;i<inputSamples.length;){var sample=inputSamples[i],ptsNorm=ptsNormalize(sample.pts-initDTS,nextAudioPts),delta=ptsNorm-nextPtsNorm;if(delta<=-pesFrameDuration)_logger.logger.warn("Dropping 1 audio frame @ "+Math.round(nextPtsNorm/90)/1e3+"s due to "+Math.round(Math.abs(delta/90))+" ms overlap."),inputSamples.splice(i,1),track.len-=sample.unit.length;else if(delta>=pesFrameDuration&&nextPtsNorm){var missing=Math.round(delta/pesFrameDuration);_logger.logger.warn("Injecting "+missing+" audio frame @ "+Math.round(nextPtsNorm/90)/1e3+"s due to "+Math.round(delta/90)+" ms gap.");for(var j=0;j<missing;j++)newStamp=nextPtsNorm+initDTS,newStamp=Math.max(newStamp,initDTS),fillFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount),fillFrame||(_logger.logger.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),fillFrame=sample.unit.subarray()),inputSamples.splice(i,0,{unit:fillFrame,pts:newStamp,dts:newStamp}),track.len+=fillFrame.length,nextPtsNorm+=pesFrameDuration,i+=1;sample.pts=sample.dts=nextPtsNorm+initDTS,nextPtsNorm+=pesFrameDuration,i+=1}else Math.abs(delta)>.1*pesFrameDuration,nextPtsNorm+=pesFrameDuration,0===i?sample.pts=sample.dts=initDTS+nextAudioPts:sample.pts=sample.dts=inputSamples[i-1].pts+pesFrameDuration,i+=1}for(var _j=0,_nbSamples=inputSamples.length;_j<_nbSamples;_j++){if(audioSample=inputSamples[_j],unit=audioSample.unit,pts=audioSample.pts-initDTS,dts=audioSample.dts-initDTS,void 0!==lastDTS)ptsnorm=ptsNormalize(pts,lastDTS),dtsnorm=ptsNormalize(dts,lastDTS),mp4Sample.duration=Math.round((dtsnorm-lastDTS)/pes2mp4ScaleFactor);else{ptsnorm=ptsNormalize(pts,nextAudioPts),dtsnorm=ptsNormalize(dts,nextAudioPts);var _delta=Math.round(1e3*(ptsnorm-nextAudioPts)/pesTimeScale),numMissingFrames=0;if(contiguous&&track.isAAC&&_delta){if(_delta>0)numMissingFrames=Math.round((ptsnorm-nextAudioPts)/pesFrameDuration),_logger.logger.log(_delta+" ms hole between AAC samples detected,filling it"),numMissingFrames>0&&(fillFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount),fillFrame||(fillFrame=unit.subarray()),track.len+=numMissingFrames*fillFrame.length);else if(_delta<-12){_logger.logger.log(-_delta+" ms overlapping between AAC samples detected, drop frame"),track.len-=unit.byteLength;continue}ptsnorm=dtsnorm=nextAudioPts}if(firstPTS=Math.max(0,ptsnorm),firstDTS=Math.max(0,dtsnorm),!(track.len>0))return;var mdatSize=rawMPEG?track.len:track.len+8;try{mdat=new Uint8Array(mdatSize)}catch(err){return void this.observer.trigger(_events2.default.ERROR,{type:_errors.ErrorTypes.MUX_ERROR,level:this.level,id:this.id,details:_errors.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:mdatSize,reason:"fail allocating audio mdat "+mdatSize})}rawMPEG||(view=new DataView(mdat.buffer),view.setUint32(0,mdatSize),mdat.set(_mp4Generator2.default.types.mdat,4));for(var _i3=0;_i3<numMissingFrames;_i3++)newStamp=ptsnorm-(numMissingFrames-_i3)*pesFrameDuration,fillFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount),fillFrame||(_logger.logger.log("Unable to get silent frame for given audio codec; duplicating this frame instead."),fillFrame=unit.subarray()),mdat.set(fillFrame,offset),offset+=fillFrame.byteLength,mp4Sample={size:fillFrame.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},outputSamples.push(mp4Sample)}mdat.set(unit,offset);var unitLen=unit.byteLength;offset+=unitLen,mp4Sample={size:unitLen,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},outputSamples.push(mp4Sample),lastDTS=dtsnorm}var lastSampleDuration=0,nbSamples=outputSamples.length;if(nbSamples>=2&&(lastSampleDuration=outputSamples[nbSamples-2].duration,mp4Sample.duration=lastSampleDuration),nbSamples){this.nextAudioPts=ptsnorm+pes2mp4ScaleFactor*lastSampleDuration,track.len=0,track.samples=outputSamples,moof=rawMPEG?new Uint8Array:_mp4Generator2.default.moof(track.sequenceNumber++,firstDTS/pes2mp4ScaleFactor,track),track.samples=[];var audioData={id:this.id,level:this.level,sn:this.sn,data1:moof,data2:mdat,startPTS:firstPTS/pesTimeScale,endPTS:this.nextAudioPts/pesTimeScale,startDTS:firstDTS/pesTimeScale,endDTS:(dtsnorm+pes2mp4ScaleFactor*lastSampleDuration)/pesTimeScale,type:"audio",nb:nbSamples};return this.observer.trigger(_events2.default.FRAG_PARSING_DATA,audioData),audioData}return null}},{key:"remuxEmptyAudio",value:function(track,timeOffset,contiguous,videoData){var pesTimeScale=this.PES_TIMESCALE,mp4timeScale=track.timescale?track.timescale:track.audiosamplerate,pes2mp4ScaleFactor=pesTimeScale/mp4timeScale,nextAudioPts=this.nextAudioPts,startDTS=(void 0!==nextAudioPts?nextAudioPts:videoData.startDTS*pesTimeScale)+this._initDTS,endDTS=videoData.endDTS*pesTimeScale+this._initDTS,sampleDuration=1024,frameDuration=pes2mp4ScaleFactor*sampleDuration,nbSamples=Math.ceil((endDTS-startDTS)/frameDuration),silentFrame=_aac2.default.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(_logger.logger.warn("remux empty Audio"),!silentFrame)return void _logger.logger.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!");for(var samples=[],i=0;i<nbSamples;i++){var stamp=startDTS+i*frameDuration;samples.push({unit:silentFrame,pts:stamp,dts:stamp}),track.len+=silentFrame.length}track.samples=samples,this.remuxAudio(track,timeOffset,contiguous)}},{key:"remuxID3",value:function(track,timeOffset){var sample,length=track.samples.length;if(length){for(var index=0;index<length;index++)sample=track.samples[index],sample.pts=(sample.pts-this._initPTS)/this.PES_TIMESCALE,sample.dts=(sample.dts-this._initDTS)/this.PES_TIMESCALE;this.observer.trigger(_events2.default.FRAG_PARSING_METADATA,{id:this.id,level:this.level,sn:this.sn,samples:track.samples})}track.samples=[],timeOffset=timeOffset}},{key:"remuxText",value:function(track,timeOffset){track.samples.sort(function(a,b){return a.pts-b.pts});var sample,length=track.samples.length;if(length){for(var index=0;index<length;index++)sample=track.samples[index],sample.pts=(sample.pts-this._initPTS)/this.PES_TIMESCALE;this.observer.trigger(_events2.default.FRAG_PARSING_USERDATA,{id:this.id,level:this.level,sn:this.sn,samples:track.samples})}track.samples=[],timeOffset=timeOffset}},{key:"_PTSNormalize",value:function(value,reference){var offset;if(void 0===reference)return value;for(offset=reference<value?-8589934592:8589934592;Math.abs(value-reference)>4294967296;)value+=offset;return value}},{key:"passthrough",get:function(){return!1}}]),MP4Remuxer}();exports.default=MP4Remuxer},{"../errors":26,"../events":28,"../helper/aac":29,"../remux/mp4-generator":37,"../utils/logger":45}],39:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_events=require("../events"),_events2=_interopRequireDefault(_events),PassThroughRemuxer=function(){function PassThroughRemuxer(observer,id){_classCallCheck(this,PassThroughRemuxer),this.observer=observer,this.id=id,this.ISGenerated=!1}return _createClass(PassThroughRemuxer,[{key:"destroy",value:function(){}},{key:"insertDiscontinuity",value:function(){}},{key:"switchLevel",value:function(){this.ISGenerated=!1}},{key:"remux",value:function(audioTrack,videoTrack,id3Track,textTrack,timeOffset,rawData){var observer=this.observer;if(!this.ISGenerated){var tracks={},data={id:this.id,tracks:tracks,unique:!0},track=videoTrack,codec=track.codec;codec&&(data.tracks.video={container:track.container,codec:codec,metadata:{width:track.width,height:track.height}}),track=audioTrack,codec=track.codec,codec&&(data.tracks.audio={container:track.container,codec:codec,metadata:{channelCount:track.channelCount}}),this.ISGenerated=!0,observer.trigger(_events2.default.FRAG_PARSING_INIT_SEGMENT,data)}observer.trigger(_events2.default.FRAG_PARSING_DATA,{id:this.id,data1:rawData,startPTS:timeOffset,startDTS:timeOffset,type:"audiovideo",nb:1,dropped:0})}},{key:"passthrough",get:function(){return!0}}]),PassThroughRemuxer}();exports.default=PassThroughRemuxer},{"../events":28}],40:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),DECIMAL_RESOLUTION_REGEX=/^(\d+)x(\d+)$/,ATTR_LIST_REGEX=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,AttrList=function(){function AttrList(attrs){_classCallCheck(this,AttrList),"string"==typeof attrs&&(attrs=AttrList.parseAttrList(attrs));for(var attr in attrs)attrs.hasOwnProperty(attr)&&(this[attr]=attrs[attr])}return _createClass(AttrList,[{key:"decimalInteger",value:function(attrName){var intValue=parseInt(this[attrName],10);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue}},{key:"hexadecimalInteger",value:function(attrName){if(this[attrName]){var stringValue=(this[attrName]||"0x").slice(2);stringValue=(1&stringValue.length?"0":"")+stringValue;for(var value=new Uint8Array(stringValue.length/2),i=0;i<stringValue.length/2;i++)value[i]=parseInt(stringValue.slice(2*i,2*i+2),16);return value}return null}},{key:"hexadecimalIntegerAsNumber",value:function(attrName){var intValue=parseInt(this[attrName],16);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue;
}},{key:"decimalFloatingPoint",value:function(attrName){return parseFloat(this[attrName])}},{key:"enumeratedString",value:function(attrName){return this[attrName]}},{key:"decimalResolution",value:function(attrName){var res=DECIMAL_RESOLUTION_REGEX.exec(this[attrName]);if(null!==res)return{width:parseInt(res[1],10),height:parseInt(res[2],10)}}}],[{key:"parseAttrList",value:function(input){var match,attrs={};for(ATTR_LIST_REGEX.lastIndex=0;null!==(match=ATTR_LIST_REGEX.exec(input));){var value=match[2],quote='"';0===value.indexOf(quote)&&value.lastIndexOf(quote)===value.length-1&&(value=value.slice(1,-1)),attrs[match[1]]=value}return attrs}}]),AttrList}();exports.default=AttrList},{}],41:[function(require,module,exports){"use strict";var BinarySearch={search:function(list,comparisonFunction){for(var minIndex=0,maxIndex=list.length-1,currentIndex=null,currentElement=null;minIndex<=maxIndex;){currentIndex=(minIndex+maxIndex)/2|0,currentElement=list[currentIndex];var comparisonResult=comparisonFunction(currentElement);if(comparisonResult>0)minIndex=currentIndex+1;else{if(!(comparisonResult<0))return currentElement;maxIndex=currentIndex-1}}return null}};module.exports=BinarySearch},{}],42:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),specialCea608CharsCodes={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},getCharForByte=function(byte){var charCode=byte;return specialCea608CharsCodes.hasOwnProperty(byte)&&(charCode=specialCea608CharsCodes[byte]),String.fromCharCode(charCode)},NR_ROWS=15,NR_COLS=32,rowsLowCh1={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},rowsHighCh1={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rowsLowCh2={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},rowsHighCh2={25:2,26:4,29:6,30:8,31:10,27:13,28:15},backgroundColors=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],logger={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(newTime){this.time=newTime},log:function(severity,msg){var minLevel=this.verboseFilter[severity];this.verboseLevel>=minLevel&&console.log(this.time+" ["+severity+"] "+msg)}},numArrayToHexArray=function(numArray){for(var hexArray=[],j=0;j<numArray.length;j++)hexArray.push(numArray[j].toString(16));return hexArray},PenState=function(){function PenState(foreground,underline,italics,background,flash){_classCallCheck(this,PenState),this.foreground=foreground||"white",this.underline=underline||!1,this.italics=italics||!1,this.background=background||"black",this.flash=flash||!1}return _createClass(PenState,[{key:"reset",value:function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}},{key:"setStyles",value:function(styles){for(var attribs=["foreground","underline","italics","background","flash"],i=0;i<attribs.length;i++){var style=attribs[i];styles.hasOwnProperty(style)&&(this[style]=styles[style])}}},{key:"isDefault",value:function(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}},{key:"equals",value:function(other){return this.foreground===other.foreground&&this.underline===other.underline&&this.italics===other.italics&&this.background===other.background&&this.flash===other.flash}},{key:"copy",value:function(newPenState){this.foreground=newPenState.foreground,this.underline=newPenState.underline,this.italics=newPenState.italics,this.background=newPenState.background,this.flash=newPenState.flash}},{key:"toString",value:function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}]),PenState}(),StyledUnicodeChar=function(){function StyledUnicodeChar(uchar,foreground,underline,italics,background,flash){_classCallCheck(this,StyledUnicodeChar),this.uchar=uchar||" ",this.penState=new PenState(foreground,underline,italics,background,flash)}return _createClass(StyledUnicodeChar,[{key:"reset",value:function(){this.uchar=" ",this.penState.reset()}},{key:"setChar",value:function(uchar,newPenState){this.uchar=uchar,this.penState.copy(newPenState)}},{key:"setPenState",value:function(newPenState){this.penState.copy(newPenState)}},{key:"equals",value:function(other){return this.uchar===other.uchar&&this.penState.equals(other.penState)}},{key:"copy",value:function(newChar){this.uchar=newChar.uchar,this.penState.copy(newChar.penState)}},{key:"isEmpty",value:function(){return" "===this.uchar&&this.penState.isDefault()}}]),StyledUnicodeChar}(),Row=function(){function Row(){_classCallCheck(this,Row),this.chars=[];for(var i=0;i<NR_COLS;i++)this.chars.push(new StyledUnicodeChar);this.pos=0,this.currPenState=new PenState}return _createClass(Row,[{key:"equals",value:function(other){for(var equal=!0,i=0;i<NR_COLS;i++)if(!this.chars[i].equals(other.chars[i])){equal=!1;break}return equal}},{key:"copy",value:function(other){for(var i=0;i<NR_COLS;i++)this.chars[i].copy(other.chars[i])}},{key:"isEmpty",value:function(){for(var empty=!0,i=0;i<NR_COLS;i++)if(!this.chars[i].isEmpty()){empty=!1;break}return empty}},{key:"setCursor",value:function(absPos){this.pos!==absPos&&(this.pos=absPos),this.pos<0?(logger.log("ERROR","Negative cursor position "+this.pos),this.pos=0):this.pos>NR_COLS&&(logger.log("ERROR","Too large cursor position "+this.pos),this.pos=NR_COLS)}},{key:"moveCursor",value:function(relPos){var newPos=this.pos+relPos;if(relPos>1)for(var i=this.pos+1;i<newPos+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(newPos)}},{key:"backSpace",value:function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}},{key:"insertChar",value:function(byte){byte>=144&&this.backSpace();var char=getCharForByte(byte);return this.pos>=NR_COLS?void logger.log("ERROR","Cannot insert "+byte.toString(16)+" ("+char+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(char,this.currPenState),void this.moveCursor(1))}},{key:"clearFromPos",value:function(startPos){var i;for(i=startPos;i<NR_COLS;i++)this.chars[i].reset()}},{key:"clear",value:function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}},{key:"clearToEndOfRow",value:function(){this.clearFromPos(this.pos)}},{key:"getTextString",value:function(){for(var chars=[],empty=!0,i=0;i<NR_COLS;i++){var char=this.chars[i].uchar;" "!==char&&(empty=!1),chars.push(char)}return empty?"":chars.join("")}},{key:"setPenStyles",value:function(styles){this.currPenState.setStyles(styles);var currChar=this.chars[this.pos];currChar.setPenState(this.currPenState)}}]),Row}(),CaptionScreen=function(){function CaptionScreen(){_classCallCheck(this,CaptionScreen),this.rows=[];for(var i=0;i<NR_ROWS;i++)this.rows.push(new Row);this.currRow=NR_ROWS-1,this.nrRollUpRows=null,this.reset()}return _createClass(CaptionScreen,[{key:"reset",value:function(){for(var i=0;i<NR_ROWS;i++)this.rows[i].clear();this.currRow=NR_ROWS-1}},{key:"equals",value:function(other){for(var equal=!0,i=0;i<NR_ROWS;i++)if(!this.rows[i].equals(other.rows[i])){equal=!1;break}return equal}},{key:"copy",value:function(other){for(var i=0;i<NR_ROWS;i++)this.rows[i].copy(other.rows[i])}},{key:"isEmpty",value:function(){for(var empty=!0,i=0;i<NR_ROWS;i++)if(!this.rows[i].isEmpty()){empty=!1;break}return empty}},{key:"backSpace",value:function(){var row=this.rows[this.currRow];row.backSpace()}},{key:"clearToEndOfRow",value:function(){var row=this.rows[this.currRow];row.clearToEndOfRow()}},{key:"insertChar",value:function(char){var row=this.rows[this.currRow];row.insertChar(char)}},{key:"setPen",value:function(styles){var row=this.rows[this.currRow];row.setPenStyles(styles)}},{key:"moveCursor",value:function(relPos){var row=this.rows[this.currRow];row.moveCursor(relPos)}},{key:"setCursor",value:function(absPos){logger.log("INFO","setCursor: "+absPos);var row=this.rows[this.currRow];row.setCursor(absPos)}},{key:"setPAC",value:function(pacData,lastOutputScreen){logger.log("INFO","pacData = "+JSON.stringify(pacData));var newRow=pacData.row-1;if(this.nrRollUpRows&&newRow<this.nrRollUpRows-1&&(newRow=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==newRow){for(var i=0;i<NR_ROWS;i++)this.rows[i].clear();var topRowIndex=this.currRow+1-this.nrRollUpRows,prevLineTime=lastOutputScreen.rows[topRowIndex].cueStartTime;if(prevLineTime&&prevLineTime<logger.time)for(i=0;i<this.nrRollUpRows;i++)this.rows[newRow-this.nrRollUpRows+i+1].copy(lastOutputScreen.rows[topRowIndex+i])}this.currRow=newRow;var row=this.rows[this.currRow];if(null!==pacData.indent){var indent=pacData.indent,prevPos=Math.max(indent-1,0);row.setCursor(pacData.indent),pacData.color=row.chars[prevPos].penState.foreground}var styles={foreground:pacData.color,underline:pacData.underline,italics:pacData.italics,background:"black",flash:!1};this.setPen(styles)}},{key:"setBkgData",value:function(bkgData){logger.log("INFO","bkgData = "+JSON.stringify(bkgData)),this.backSpace(),this.setPen(bkgData),this.insertChar(32)}},{key:"setRollUpRows",value:function(nrRows){this.nrRollUpRows=nrRows}},{key:"rollUp",value:function(){if(null===this.nrRollUpRows)return void logger.log("DEBUG","roll_up but nrRollUpRows not set yet");logger.log("TEXT",this.getDisplayText());var topRowIndex=this.currRow+1-this.nrRollUpRows,topRow=this.rows.splice(topRowIndex,1)[0];topRow.clear(),this.rows.splice(this.currRow,0,topRow),logger.log("INFO","Rolling up")}},{key:"getDisplayText",value:function(asOneRow){asOneRow=asOneRow||!1;for(var displayText=[],text="",rowNr=-1,i=0;i<NR_ROWS;i++){var rowText=this.rows[i].getTextString();rowText&&(rowNr=i+1,asOneRow?displayText.push("Row "+rowNr+": '"+rowText+"'"):displayText.push(rowText.trim()))}return displayText.length>0&&(text=asOneRow?"["+displayText.join(" | ")+"]":displayText.join("\n")),text}},{key:"getTextAndFormat",value:function(){return this.rows}}]),CaptionScreen}(),Cea608Channel=function(){function Cea608Channel(channelNumber,outputFilter){_classCallCheck(this,Cea608Channel),this.chNr=channelNumber,this.outputFilter=outputFilter,this.mode=null,this.verbose=0,this.displayedMemory=new CaptionScreen,this.nonDisplayedMemory=new CaptionScreen,this.lastOutputScreen=new CaptionScreen,this.currRollUpRow=this.displayedMemory.rows[NR_ROWS-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}return _createClass(Cea608Channel,[{key:"reset",value:function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.currRollUpRow=this.displayedMemory.rows[NR_ROWS-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null}},{key:"getHandler",value:function(){return this.outputFilter}},{key:"setHandler",value:function(newHandler){this.outputFilter=newHandler}},{key:"setPAC",value:function(pacData){this.writeScreen.setPAC(pacData,this.lastOutputScreen)}},{key:"setBkgData",value:function(bkgData){this.writeScreen.setBkgData(bkgData)}},{key:"setMode",value:function(newMode){newMode!==this.mode&&(this.mode=newMode,logger.log("INFO","MODE="+newMode),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset(),this.lastOutputScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=newMode)}},{key:"insertChars",value:function(chars){for(var i=0;i<chars.length;i++)this.writeScreen.insertChar(chars[i]);var screen=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";logger.log("INFO",screen+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(logger.log("TEXT","DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}},{key:"ccRCL",value:function(){logger.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}},{key:"ccBS",value:function(){logger.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}},{key:"ccAOF",value:function(){}},{key:"ccAON",value:function(){}},{key:"ccDER",value:function(){logger.log("INFO","DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}},{key:"ccRU",value:function(nrRows){logger.log("INFO","RU("+nrRows+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(nrRows)}},{key:"ccFON",value:function(){logger.log("INFO","FON - Flash On"),this.writeScreen.setPen({flash:!0})}},{key:"ccRDC",value:function(){logger.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}},{key:"ccTR",value:function(){logger.log("INFO","TR"),this.setMode("MODE_TEXT")}},{key:"ccRTD",value:function(){logger.log("INFO","RTD"),this.setMode("MODE_TEXT")}},{key:"ccEDM",value:function(){logger.log("INFO","EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate()}},{key:"ccCR",value:function(){logger.log("CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate()}},{key:"ccENM",value:function(){logger.log("INFO","ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}},{key:"ccEOC",value:function(){if(logger.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var tmp=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=tmp,this.writeScreen=this.nonDisplayedMemory,logger.log("TEXT","DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate()}},{key:"ccTO",value:function(nrCols){logger.log("INFO","TO("+nrCols+") - Tab Offset"),this.writeScreen.moveCursor(nrCols)}},{key:"ccMIDROW",value:function(secondByte){var styles={flash:!1};if(styles.underline=secondByte%2===1,styles.italics=secondByte>=46,styles.italics)styles.foreground="white";else{var colorIndex=Math.floor(secondByte/2)-16,colors=["white","green","blue","cyan","red","yellow","magenta"];styles.foreground=colors[colorIndex]}logger.log("INFO","MIDROW: "+JSON.stringify(styles)),this.writeScreen.setPen(styles)}},{key:"outputDataUpdate",value:function(){var t=logger.time;null!==t&&this.outputFilter&&(this.outputFilter.updateData&&this.outputFilter.updateData(t,this.displayedMemory),null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}},{key:"cueSplitAtTime",value:function(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}]),Cea608Channel}(),Cea608Parser=function(){function Cea608Parser(field,out1,out2){_classCallCheck(this,Cea608Parser),this.field=field||1,this.outputs=[out1,out2],this.channels=[new Cea608Channel(1,out1),new Cea608Channel(2,out2)],this.currChNr=-1,this.lastCmdA=null,this.lastCmdB=null,this.bufferedData=[],this.startTime=null,this.lastTime=null,this.dataCounters={padding:0,char:0,cmd:0,other:0}}return _createClass(Cea608Parser,[{key:"getHandler",value:function(index){return this.channels[index].getHandler()}},{key:"setHandler",value:function(index,newHandler){this.channels[index].setHandler(newHandler)}},{key:"addData",value:function(t,byteList){var cmdFound,a,b,charsFound=!1;this.lastTime=t,logger.setTime(t);for(var i=0;i<byteList.length;i+=2)if(a=127&byteList[i],b=127&byteList[i+1],0!==a||0!==b){if(logger.log("DATA","["+numArrayToHexArray([byteList[i],byteList[i+1]])+"] -> ("+numArrayToHexArray([a,b])+")"),cmdFound=this.parseCmd(a,b),cmdFound||(cmdFound=this.parseMidrow(a,b)),cmdFound||(cmdFound=this.parsePAC(a,b)),cmdFound||(cmdFound=this.parseBackgroundAttributes(a,b)),!cmdFound&&(charsFound=this.parseChars(a,b)))if(this.currChNr&&this.currChNr>=0){var channel=this.channels[this.currChNr-1];channel.insertChars(charsFound)}else logger.log("WARNING","No channel found yet. TEXT-MODE?");cmdFound?this.dataCounters.cmd+=2:charsFound?this.dataCounters.char+=2:(this.dataCounters.other+=2,logger.log("WARNING","Couldn't parse cleaned data "+numArrayToHexArray([a,b])+" orig: "+numArrayToHexArray([byteList[i],byteList[i+1]])))}else this.dataCounters.padding+=2}},{key:"parseCmd",value:function(a,b){var chNr=null,cond1=(20===a||28===a)&&32<=b&&b<=47,cond2=(23===a||31===a)&&33<=b&&b<=35;if(!cond1&&!cond2)return!1;if(a===this.lastCmdA&&b===this.lastCmdB)return this.lastCmdA=null,this.lastCmdB=null,logger.log("DEBUG","Repeated command ("+numArrayToHexArray([a,b])+") is dropped"),!0;chNr=20===a||23===a?1:2;var channel=this.channels[chNr-1];return 20===a||28===a?32===b?channel.ccRCL():33===b?channel.ccBS():34===b?channel.ccAOF():35===b?channel.ccAON():36===b?channel.ccDER():37===b?channel.ccRU(2):38===b?channel.ccRU(3):39===b?channel.ccRU(4):40===b?channel.ccFON():41===b?channel.ccRDC():42===b?channel.ccTR():43===b?channel.ccRTD():44===b?channel.ccEDM():45===b?channel.ccCR():46===b?channel.ccENM():47===b&&channel.ccEOC():channel.ccTO(b-32),this.lastCmdA=a,this.lastCmdB=b,this.currChNr=chNr,!0}},{key:"parseMidrow",value:function(a,b){var chNr=null;if((17===a||25===a)&&32<=b&&b<=47){if(chNr=17===a?1:2,chNr!==this.currChNr)return logger.log("ERROR","Mismatch channel in midrow parsing"),!1;var channel=this.channels[chNr-1];return channel.ccMIDROW(b),logger.log("DEBUG","MIDROW ("+numArrayToHexArray([a,b])+")"),!0}return!1}},{key:"parsePAC",value:function(a,b){var chNr=null,row=null,case1=(17<=a&&a<=23||25<=a&&a<=31)&&64<=b&&b<=127,case2=(16===a||24===a)&&64<=b&&b<=95;if(!case1&&!case2)return!1;if(a===this.lastCmdA&&b===this.lastCmdB)return this.lastCmdA=null,this.lastCmdB=null,!0;chNr=a<=23?1:2,row=64<=b&&b<=95?1===chNr?rowsLowCh1[a]:rowsLowCh2[a]:1===chNr?rowsHighCh1[a]:rowsHighCh2[a];var pacData=this.interpretPAC(row,b),channel=this.channels[chNr-1];return channel.setPAC(pacData),this.lastCmdA=a,this.lastCmdB=b,this.currChNr=chNr,!0}},{key:"interpretPAC",value:function(row,byte){var pacIndex=byte,pacData={color:null,italics:!1,indent:null,underline:!1,row:row};return pacIndex=byte>95?byte-96:byte-64,pacData.underline=1===(1&pacIndex),pacIndex<=13?pacData.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(pacIndex/2)]:pacIndex<=15?(pacData.italics=!0,pacData.color="white"):pacData.indent=4*Math.floor((pacIndex-16)/2),pacData}},{key:"parseChars",value:function(a,b){var channelNr=null,charCodes=null,charCode1=null;if(a>=25?(channelNr=2,charCode1=a-8):(channelNr=1,charCode1=a),17<=charCode1&&charCode1<=19){var oneCode=b;oneCode=17===charCode1?b+80:18===charCode1?b+112:b+144,logger.log("INFO","Special char '"+getCharForByte(oneCode)+"' in channel "+channelNr),charCodes=[oneCode]}else 32<=a&&a<=127&&(charCodes=0===b?[a]:[a,b]);if(charCodes){var hexCodes=numArrayToHexArray(charCodes);logger.log("DEBUG","Char codes =  "+hexCodes.join(",")),this.lastCmdA=null,this.lastCmdB=null}return charCodes}},{key:"parseBackgroundAttributes",value:function(a,b){var bkgData,index,chNr,channel,case1=(16===a||24===a)&&32<=b&&b<=47,case2=(23===a||31===a)&&45<=b&&b<=47;return!(!case1&&!case2)&&(bkgData={},16===a||24===a?(index=Math.floor((b-32)/2),bkgData.background=backgroundColors[index],b%2===1&&(bkgData.background=bkgData.background+"_semi")):45===b?bkgData.background="transparent":(bkgData.foreground="black",47===b&&(bkgData.underline=!0)),chNr=a<24?1:2,channel=this.channels[chNr-1],channel.setBkgData(bkgData),this.lastCmdA=null,this.lastCmdB=null,!0)}},{key:"reset",value:function(){for(var i=0;i<this.channels.length;i++)this.channels[i]&&this.channels[i].reset();this.lastCmdA=null,this.lastCmdB=null}},{key:"cueSplitAtTime",value:function(t){for(var i=0;i<this.channels.length;i++)this.channels[i]&&this.channels[i].cueSplitAtTime(t)}}]),Cea608Parser}();exports.default=Cea608Parser},{}],43:[function(require,module,exports){"use strict";var Cues={newCue:function(track,startTime,endTime,captionScreen){for(var row,cue,indenting,indent,text,VTTCue=window.VTTCue||window.TextTrackCue,r=0;r<captionScreen.rows.length;r++)if(row=captionScreen.rows[r],indenting=!0,indent=0,text="",!row.isEmpty()){for(var c=0;c<row.chars.length;c++)row.chars[c].uchar.match(/\s/)&&indenting?indent++:(text+=row.chars[c].uchar,indenting=!1);row.cueStartTime=startTime,cue=new VTTCue(startTime,endTime,text.trim()),indent>=16?indent--:indent++,navigator.userAgent.match(/Firefox\//)?cue.line=r+1:cue.line=r>7?r-2:r+1,cue.align="left",cue.position=Math.max(0,Math.min(100,100*(indent/32)+(navigator.userAgent.match(/Firefox\//)?50:0))),track.addCue(cue)}}};module.exports=Cues},{}],44:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),EWMA=function(){function EWMA(halfLife){_classCallCheck(this,EWMA),this.alpha_=halfLife?Math.exp(Math.log(.5)/halfLife):0,this.estimate_=0,this.totalWeight_=0}return _createClass(EWMA,[{key:"sample",value:function(weight,value){var adjAlpha=Math.pow(this.alpha_,weight);this.estimate_=value*(1-adjAlpha)+adjAlpha*this.estimate_,this.totalWeight_+=weight}},{key:"getTotalWeight",value:function(){return this.totalWeight_}},{key:"getEstimate",value:function(){if(this.alpha_){var zeroFactor=1-Math.pow(this.alpha_,this.totalWeight_);return this.estimate_/zeroFactor}return this.estimate_}}]),EWMA}();exports.default=EWMA},{}],45:[function(require,module,exports){"use strict";function noop(){}function formatMsg(type,msg){return msg="["+type+"] > "+msg}function consolePrintFn(type){var func=self.console[type];return func?function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];args[0]&&(args[0]=formatMsg(type,args[0])),func.apply(self.console,args)}:noop}function exportLoggerFunctions(debugConfig){for(var _len2=arguments.length,functions=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)functions[_key2-1]=arguments[_key2];functions.forEach(function(type){exportedLogger[type]=debugConfig[type]?debugConfig[type].bind(debugConfig):consolePrintFn(type)})}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},fakeLogger={trace:noop,debug:noop,log:noop,warn:noop,info:noop,error:noop},exportedLogger=fakeLogger;exports.enableLogs=function(debugConfig){if(debugConfig===!0||"object"===("undefined"==typeof debugConfig?"undefined":_typeof(debugConfig))){exportLoggerFunctions(debugConfig,"debug","log","info","warn","error");try{exportedLogger.log()}catch(e){exportedLogger=fakeLogger}}else exportedLogger=fakeLogger},exports.logger=exportedLogger},{}],46:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),TimeRanges=function(){function TimeRanges(){_classCallCheck(this,TimeRanges)}return _createClass(TimeRanges,null,[{key:"toString",value:function(r){for(var log="",len=r.length,i=0;i<len;i++)log+="["+r.start(i).toFixed(3)+","+r.end(i).toFixed(3)+"]";return log}}]),TimeRanges}();exports.default=TimeRanges},{}],47:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_logger=require("../utils/logger"),XhrLoader=function(){function XhrLoader(config){_classCallCheck(this,XhrLoader),config&&config.xhrSetup&&(this.xhrSetup=config.xhrSetup)}return _createClass(XhrLoader,[{key:"destroy",value:function(){this.abort(),this.loader=null}},{key:"abort",value:function(){var loader=this.loader;loader&&4!==loader.readyState&&(this.stats.aborted=!0,loader.abort()),window.clearTimeout(this.requestTimeout),this.requestTimeout=null,window.clearTimeout(this.retryTimeout),this.retryTimeout=null}},{key:"load",value:function(context,config,callbacks){this.context=context,this.config=config,this.callbacks=callbacks,this.stats={trequest:performance.now(),retry:0},this.retryDelay=config.retryDelay,this.loadInternal()}},{key:"loadInternal",value:function(){var xhr,context=this.context;xhr="undefined"!=typeof XDomainRequest?this.loader=new XDomainRequest:this.loader=new XMLHttpRequest,xhr.onreadystatechange=this.readystatechange.bind(this),xhr.onprogress=this.loadprogress.bind(this),xhr.open("GET",context.url,!0),context.rangeEnd&&xhr.setRequestHeader("Range","bytes="+context.rangeStart+"-"+(context.rangeEnd-1)),xhr.responseType=context.responseType;var stats=this.stats;stats.tfirst=0,stats.loaded=0,this.xhrSetup&&this.xhrSetup(xhr,context.url),this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),this.config.timeout),xhr.send()}},{key:"arrayToArrayBuffer",value:function(array){for(var length=array.length,buffer=new ArrayBuffer(2*length),view=new Uint8Array(buffer),i=0;i<length;i++)view[i]=array[i];return buffer}},{key:"readystatechange",value:function(event){var xhr=event.currentTarget,readyState=xhr.readyState,stats=this.stats,context=this.context,config=this.config;if(!stats.aborted&&readyState>=2)if(window.clearTimeout(this.requestTimeout),0===stats.tfirst&&(stats.tfirst=Math.max(performance.now(),stats.trequest)),4===readyState){var status=xhr.status;if(status>=200&&status<300){stats.tload=Math.max(stats.tfirst,performance.now());var data,len;"arraybuffer"===context.responseType?(data=xhr.response,len=data.byteLength):(data=xhr.responseText,len=data.length),stats.loaded=stats.total=len;var fn_arr=xhr.responseURL.split("/");fn_arr.pop();if(xhr.responseURL.split("/").pop().startsWith("_")&&(xhr.responseURL.endsWith(".ts")||xhr.responseURL.endsWith(".TS"))){for(var datam=new Uint8Array(data),r=0;r<datam.length;r++){var before=datam[r];datam[r]=144^before}data=this.arrayToArrayBuffer(datam)}var response={url:xhr.responseURL,data:data};this.callbacks.onSuccess(response,stats,context)}else stats.retry>=config.maxRetry||status>=400&&status<499?(_logger.logger.error(status+" while loading "+context.url),this.callbacks.onError({code:status,text:xhr.statusText},context)):(_logger.logger.warn(status+" while loading "+context.url+", retrying in "+this.retryDelay+"..."),this.destroy(),this.retryTimeout=window.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,config.maxRetryDelay),stats.retry++)}else this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),config.timeout)}},{key:"loadtimeout",value:function(){_logger.logger.warn("timeout while loading "+this.context.url),this.callbacks.onTimeout(this.stats,this.context)}},{key:"loadprogress",value:function(event){var stats=this.stats;stats.loaded=event.loaded,event.lengthComputable&&(stats.total=event.total);var onProgress=this.callbacks.onProgress;onProgress&&onProgress(stats,this.context,null)}}]),XhrLoader}();exports.default=XhrLoader},{"../utils/logger":45}]},{},[33])(33)});
